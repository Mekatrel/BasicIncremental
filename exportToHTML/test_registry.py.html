<html>
<head>
<title>test_registry.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #808080;}
.s1 { color: #a9b7c6;}
.s2 { color: #629755; font-style: italic;}
.s3 { color: #cc7832;}
.s4 { color: #6a8759;}
.s5 { color: #6897bb;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_registry.py</font>
</center></td></tr></table>
<pre><span class="s0">##############################################################################</span>
<span class="s0">#</span>
<span class="s0"># Copyright (c) 2001, 2002, 2009 Zope Foundation and Contributors.</span>
<span class="s0"># All Rights Reserved.</span>
<span class="s0">#</span>
<span class="s0"># This software is subject to the provisions of the Zope Public License,</span>
<span class="s0"># Version 2.1 (ZPL).  A copy of the ZPL should accompany this distribution.</span>
<span class="s0"># THIS SOFTWARE IS PROVIDED &quot;AS IS&quot; AND ANY AND ALL EXPRESS OR IMPLIED</span>
<span class="s0"># WARRANTIES ARE DISCLAIMED, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED</span>
<span class="s0"># WARRANTIES OF TITLE, MERCHANTABILITY, AGAINST INFRINGEMENT, AND FITNESS</span>
<span class="s0"># FOR A PARTICULAR PURPOSE.</span>
<span class="s0">#</span>
<span class="s0">##############################################################################</span>
<span class="s2">&quot;&quot;&quot;Component Registry Tests&quot;&quot;&quot;</span>
<span class="s0"># pylint:disable=protected-access</span>
<span class="s3">import </span><span class="s1">unittest</span>

<span class="s3">from </span><span class="s1">zope.interface </span><span class="s3">import </span><span class="s1">Interface</span>
<span class="s3">from </span><span class="s1">zope.interface.adapter </span><span class="s3">import </span><span class="s1">VerifyingAdapterRegistry</span>

<span class="s3">from </span><span class="s1">zope.interface.registry </span><span class="s3">import </span><span class="s1">Components</span>

<span class="s3">class </span><span class="s1">ComponentsTests(unittest.TestCase):</span>

    <span class="s3">def </span><span class="s1">_getTargetClass(self):</span>
        <span class="s3">return </span><span class="s1">Components</span>

    <span class="s3">def </span><span class="s1">_makeOne(self</span><span class="s3">, </span><span class="s1">name=</span><span class="s4">'test'</span><span class="s3">, </span><span class="s1">*args</span><span class="s3">, </span><span class="s1">**kw):</span>
        <span class="s3">return </span><span class="s1">self._getTargetClass()(name</span><span class="s3">, </span><span class="s1">*args</span><span class="s3">, </span><span class="s1">**kw)</span>

    <span class="s3">def </span><span class="s1">_wrapEvents(self):</span>
        <span class="s3">from </span><span class="s1">zope.interface </span><span class="s3">import </span><span class="s1">registry</span>
        <span class="s1">_events = []</span>
        <span class="s3">def </span><span class="s1">_notify(*args</span><span class="s3">, </span><span class="s1">**kw):</span>
            <span class="s1">_events.append((args</span><span class="s3">, </span><span class="s1">kw))</span>
        <span class="s1">_monkey = _Monkey(registry</span><span class="s3">, </span><span class="s1">notify=_notify)</span>
        <span class="s3">return </span><span class="s1">_monkey</span><span class="s3">, </span><span class="s1">_events</span>

    <span class="s3">def </span><span class="s1">test_ctor_no_bases(self):</span>
        <span class="s3">from </span><span class="s1">zope.interface.adapter </span><span class="s3">import </span><span class="s1">AdapterRegistry</span>
        <span class="s1">comp = self._makeOne(</span><span class="s4">'testing'</span><span class="s1">)</span>
        <span class="s1">self.assertEqual(comp.__name__</span><span class="s3">, </span><span class="s4">'testing'</span><span class="s1">)</span>
        <span class="s1">self.assertEqual(comp.__bases__</span><span class="s3">, </span><span class="s1">())</span>
        <span class="s1">self.assertTrue(isinstance(comp.adapters</span><span class="s3">, </span><span class="s1">AdapterRegistry))</span>
        <span class="s1">self.assertTrue(isinstance(comp.utilities</span><span class="s3">, </span><span class="s1">AdapterRegistry))</span>
        <span class="s1">self.assertEqual(comp.adapters.__bases__</span><span class="s3">, </span><span class="s1">())</span>
        <span class="s1">self.assertEqual(comp.utilities.__bases__</span><span class="s3">, </span><span class="s1">())</span>
        <span class="s1">self.assertEqual(comp._utility_registrations</span><span class="s3">, </span><span class="s1">{})</span>
        <span class="s1">self.assertEqual(comp._adapter_registrations</span><span class="s3">, </span><span class="s1">{})</span>
        <span class="s1">self.assertEqual(comp._subscription_registrations</span><span class="s3">, </span><span class="s1">[])</span>
        <span class="s1">self.assertEqual(comp._handler_registrations</span><span class="s3">, </span><span class="s1">[])</span>

    <span class="s3">def </span><span class="s1">test_ctor_w_base(self):</span>
        <span class="s1">base = self._makeOne(</span><span class="s4">'base'</span><span class="s1">)</span>
        <span class="s1">comp = self._makeOne(</span><span class="s4">'testing'</span><span class="s3">, </span><span class="s1">(base</span><span class="s3">,</span><span class="s1">))</span>
        <span class="s1">self.assertEqual(comp.__name__</span><span class="s3">, </span><span class="s4">'testing'</span><span class="s1">)</span>
        <span class="s1">self.assertEqual(comp.__bases__</span><span class="s3">, </span><span class="s1">(base</span><span class="s3">,</span><span class="s1">))</span>
        <span class="s1">self.assertEqual(comp.adapters.__bases__</span><span class="s3">, </span><span class="s1">(base.adapters</span><span class="s3">,</span><span class="s1">))</span>
        <span class="s1">self.assertEqual(comp.utilities.__bases__</span><span class="s3">, </span><span class="s1">(base.utilities</span><span class="s3">,</span><span class="s1">))</span>

    <span class="s3">def </span><span class="s1">test___repr__(self):</span>
        <span class="s1">comp = self._makeOne(</span><span class="s4">'testing'</span><span class="s1">)</span>
        <span class="s1">self.assertEqual(repr(comp)</span><span class="s3">, </span><span class="s4">'&lt;Components testing&gt;'</span><span class="s1">)</span>

    <span class="s0"># test _init_registries / _init_registrations via only caller, __init__.</span>

    <span class="s3">def </span><span class="s1">test_assign_to___bases__(self):</span>
        <span class="s1">base1 = self._makeOne(</span><span class="s4">'base1'</span><span class="s1">)</span>
        <span class="s1">base2 = self._makeOne(</span><span class="s4">'base2'</span><span class="s1">)</span>
        <span class="s1">comp = self._makeOne()</span>
        <span class="s1">comp.__bases__ = (base1</span><span class="s3">, </span><span class="s1">base2)</span>
        <span class="s1">self.assertEqual(comp.__bases__</span><span class="s3">, </span><span class="s1">(base1</span><span class="s3">, </span><span class="s1">base2))</span>
        <span class="s1">self.assertEqual(comp.adapters.__bases__</span><span class="s3">,</span>
                         <span class="s1">(base1.adapters</span><span class="s3">, </span><span class="s1">base2.adapters))</span>
        <span class="s1">self.assertEqual(comp.utilities.__bases__</span><span class="s3">,</span>
                         <span class="s1">(base1.utilities</span><span class="s3">, </span><span class="s1">base2.utilities))</span>

    <span class="s3">def </span><span class="s1">test_registerUtility_with_component_name(self):</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">named</span><span class="s3">, </span><span class="s1">InterfaceClass</span>


        <span class="s3">class </span><span class="s1">IFoo(InterfaceClass):</span>
            <span class="s3">pass</span>
        <span class="s1">ifoo = IFoo(</span><span class="s4">'IFoo'</span><span class="s1">)</span>

        <span class="s1">@named(</span><span class="s4">u'foo'</span><span class="s1">)</span>
        <span class="s3">class </span><span class="s1">Foo(object):</span>
            <span class="s3">pass</span>
        <span class="s1">foo = Foo()</span>
        <span class="s1">_info = </span><span class="s4">u'info'</span>

        <span class="s1">comp = self._makeOne()</span>
        <span class="s1">comp.registerUtility(foo</span><span class="s3">, </span><span class="s1">ifoo</span><span class="s3">, </span><span class="s1">info=_info)</span>
        <span class="s1">self.assertEqual(</span>
            <span class="s1">comp._utility_registrations[ifoo</span><span class="s3">, </span><span class="s4">u'foo'</span><span class="s1">]</span><span class="s3">,</span>
            <span class="s1">(foo</span><span class="s3">, </span><span class="s1">_info</span><span class="s3">, None</span><span class="s1">))</span>

    <span class="s3">def </span><span class="s1">test_registerUtility_both_factory_and_component(self):</span>
        <span class="s3">def </span><span class="s1">_factory():</span>
            <span class="s3">raise </span><span class="s1">NotImplementedError()</span>
        <span class="s1">_to_reg = object()</span>
        <span class="s1">comp = self._makeOne()</span>
        <span class="s1">self.assertRaises(TypeError</span><span class="s3">, </span><span class="s1">comp.registerUtility</span><span class="s3">,</span>
                          <span class="s1">component=_to_reg</span><span class="s3">, </span><span class="s1">factory=_factory)</span>

    <span class="s3">def </span><span class="s1">test_registerUtility_w_component(self):</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">InterfaceClass</span>
        <span class="s3">from </span><span class="s1">zope.interface.interfaces </span><span class="s3">import </span><span class="s1">Registered</span>
        <span class="s3">from </span><span class="s1">zope.interface.registry </span><span class="s3">import </span><span class="s1">UtilityRegistration</span>

        <span class="s3">class </span><span class="s1">IFoo(InterfaceClass):</span>
            <span class="s3">pass</span>
        <span class="s1">ifoo = IFoo(</span><span class="s4">'IFoo'</span><span class="s1">)</span>
        <span class="s1">_info = </span><span class="s4">u'info'</span>
        <span class="s1">_name = </span><span class="s4">u'name'</span>
        <span class="s1">_to_reg = object()</span>
        <span class="s1">comp = self._makeOne()</span>
        <span class="s1">_monkey</span><span class="s3">, </span><span class="s1">_events = self._wrapEvents()</span>
        <span class="s3">with </span><span class="s1">_monkey:</span>
            <span class="s1">comp.registerUtility(_to_reg</span><span class="s3">, </span><span class="s1">ifoo</span><span class="s3">, </span><span class="s1">_name</span><span class="s3">, </span><span class="s1">_info)</span>
        <span class="s1">self.assertTrue(comp.utilities._adapters[</span><span class="s5">0</span><span class="s1">][ifoo][_name] </span><span class="s3">is </span><span class="s1">_to_reg)</span>
        <span class="s1">self.assertEqual(comp._utility_registrations[ifoo</span><span class="s3">, </span><span class="s1">_name]</span><span class="s3">,</span>
                         <span class="s1">(_to_reg</span><span class="s3">, </span><span class="s1">_info</span><span class="s3">, None</span><span class="s1">))</span>
        <span class="s1">self.assertEqual(comp.utilities._subscribers[</span><span class="s5">0</span><span class="s1">][ifoo][</span><span class="s4">''</span><span class="s1">]</span><span class="s3">, </span><span class="s1">(_to_reg</span><span class="s3">,</span><span class="s1">))</span>
        <span class="s1">self.assertEqual(len(_events)</span><span class="s3">, </span><span class="s5">1</span><span class="s1">)</span>
        <span class="s1">args</span><span class="s3">, </span><span class="s1">kw = _events[</span><span class="s5">0</span><span class="s1">]</span>
        <span class="s1">event</span><span class="s3">, </span><span class="s1">= args</span>
        <span class="s1">self.assertEqual(kw</span><span class="s3">, </span><span class="s1">{})</span>
        <span class="s1">self.assertTrue(isinstance(event</span><span class="s3">, </span><span class="s1">Registered))</span>
        <span class="s1">self.assertTrue(isinstance(event.object</span><span class="s3">, </span><span class="s1">UtilityRegistration))</span>
        <span class="s1">self.assertTrue(event.object.registry </span><span class="s3">is </span><span class="s1">comp)</span>
        <span class="s1">self.assertTrue(event.object.provided </span><span class="s3">is </span><span class="s1">ifoo)</span>
        <span class="s1">self.assertTrue(event.object.name </span><span class="s3">is </span><span class="s1">_name)</span>
        <span class="s1">self.assertTrue(event.object.component </span><span class="s3">is </span><span class="s1">_to_reg)</span>
        <span class="s1">self.assertTrue(event.object.info </span><span class="s3">is </span><span class="s1">_info)</span>
        <span class="s1">self.assertTrue(event.object.factory </span><span class="s3">is None</span><span class="s1">)</span>

    <span class="s3">def </span><span class="s1">test_registerUtility_w_factory(self):</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">InterfaceClass</span>
        <span class="s3">from </span><span class="s1">zope.interface.interfaces </span><span class="s3">import </span><span class="s1">Registered</span>
        <span class="s3">from </span><span class="s1">zope.interface.registry </span><span class="s3">import </span><span class="s1">UtilityRegistration</span>

        <span class="s3">class </span><span class="s1">IFoo(InterfaceClass):</span>
            <span class="s3">pass</span>
        <span class="s1">ifoo = IFoo(</span><span class="s4">'IFoo'</span><span class="s1">)</span>
        <span class="s1">_info = </span><span class="s4">u'info'</span>
        <span class="s1">_name = </span><span class="s4">u'name'</span>
        <span class="s1">_to_reg = object()</span>
        <span class="s3">def </span><span class="s1">_factory():</span>
            <span class="s3">return </span><span class="s1">_to_reg</span>
        <span class="s1">comp = self._makeOne()</span>
        <span class="s1">_monkey</span><span class="s3">, </span><span class="s1">_events = self._wrapEvents()</span>
        <span class="s3">with </span><span class="s1">_monkey:</span>
            <span class="s1">comp.registerUtility(</span><span class="s3">None, </span><span class="s1">ifoo</span><span class="s3">, </span><span class="s1">_name</span><span class="s3">, </span><span class="s1">_info</span><span class="s3">, </span><span class="s1">factory=_factory)</span>
        <span class="s1">self.assertEqual(len(_events)</span><span class="s3">, </span><span class="s5">1</span><span class="s1">)</span>
        <span class="s1">args</span><span class="s3">, </span><span class="s1">kw = _events[</span><span class="s5">0</span><span class="s1">]</span>
        <span class="s1">event</span><span class="s3">, </span><span class="s1">= args</span>
        <span class="s1">self.assertEqual(kw</span><span class="s3">, </span><span class="s1">{})</span>
        <span class="s1">self.assertTrue(isinstance(event</span><span class="s3">, </span><span class="s1">Registered))</span>
        <span class="s1">self.assertTrue(isinstance(event.object</span><span class="s3">, </span><span class="s1">UtilityRegistration))</span>
        <span class="s1">self.assertTrue(event.object.registry </span><span class="s3">is </span><span class="s1">comp)</span>
        <span class="s1">self.assertTrue(event.object.provided </span><span class="s3">is </span><span class="s1">ifoo)</span>
        <span class="s1">self.assertTrue(event.object.name </span><span class="s3">is </span><span class="s1">_name)</span>
        <span class="s1">self.assertTrue(event.object.component </span><span class="s3">is </span><span class="s1">_to_reg)</span>
        <span class="s1">self.assertTrue(event.object.info </span><span class="s3">is </span><span class="s1">_info)</span>
        <span class="s1">self.assertTrue(event.object.factory </span><span class="s3">is </span><span class="s1">_factory)</span>

    <span class="s3">def </span><span class="s1">test_registerUtility_no_provided_available(self):</span>
        <span class="s3">class </span><span class="s1">Foo(object):</span>
            <span class="s3">pass</span>

        <span class="s1">_info = </span><span class="s4">u'info'</span>
        <span class="s1">_name = </span><span class="s4">u'name'</span>
        <span class="s1">_to_reg = Foo()</span>
        <span class="s1">comp = self._makeOne()</span>
        <span class="s1">self.assertRaises(TypeError</span><span class="s3">,</span>
                          <span class="s1">comp.registerUtility</span><span class="s3">, </span><span class="s1">_to_reg</span><span class="s3">, None, </span><span class="s1">_name</span><span class="s3">, </span><span class="s1">_info)</span>

    <span class="s3">def </span><span class="s1">test_registerUtility_wo_provided(self):</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">directlyProvides</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">InterfaceClass</span>
        <span class="s3">from </span><span class="s1">zope.interface.interfaces </span><span class="s3">import </span><span class="s1">Registered</span>
        <span class="s3">from </span><span class="s1">zope.interface.registry </span><span class="s3">import </span><span class="s1">UtilityRegistration</span>

        <span class="s3">class </span><span class="s1">IFoo(InterfaceClass):</span>
            <span class="s3">pass</span>
        <span class="s3">class </span><span class="s1">Foo(object):</span>
            <span class="s3">pass</span>
        <span class="s1">ifoo = IFoo(</span><span class="s4">'IFoo'</span><span class="s1">)</span>
        <span class="s1">_info = </span><span class="s4">u'info'</span>
        <span class="s1">_name = </span><span class="s4">u'name'</span>
        <span class="s1">_to_reg = Foo()</span>
        <span class="s1">directlyProvides(_to_reg</span><span class="s3">, </span><span class="s1">ifoo)</span>
        <span class="s1">comp = self._makeOne()</span>
        <span class="s1">_monkey</span><span class="s3">, </span><span class="s1">_events = self._wrapEvents()</span>
        <span class="s3">with </span><span class="s1">_monkey:</span>
            <span class="s1">comp.registerUtility(_to_reg</span><span class="s3">, None, </span><span class="s1">_name</span><span class="s3">, </span><span class="s1">_info)</span>
        <span class="s1">self.assertEqual(len(_events)</span><span class="s3">, </span><span class="s5">1</span><span class="s1">)</span>
        <span class="s1">args</span><span class="s3">, </span><span class="s1">kw = _events[</span><span class="s5">0</span><span class="s1">]</span>
        <span class="s1">event</span><span class="s3">, </span><span class="s1">= args</span>
        <span class="s1">self.assertEqual(kw</span><span class="s3">, </span><span class="s1">{})</span>
        <span class="s1">self.assertTrue(isinstance(event</span><span class="s3">, </span><span class="s1">Registered))</span>
        <span class="s1">self.assertTrue(isinstance(event.object</span><span class="s3">, </span><span class="s1">UtilityRegistration))</span>
        <span class="s1">self.assertTrue(event.object.registry </span><span class="s3">is </span><span class="s1">comp)</span>
        <span class="s1">self.assertTrue(event.object.provided </span><span class="s3">is </span><span class="s1">ifoo)</span>
        <span class="s1">self.assertTrue(event.object.name </span><span class="s3">is </span><span class="s1">_name)</span>
        <span class="s1">self.assertTrue(event.object.component </span><span class="s3">is </span><span class="s1">_to_reg)</span>
        <span class="s1">self.assertTrue(event.object.info </span><span class="s3">is </span><span class="s1">_info)</span>
        <span class="s1">self.assertTrue(event.object.factory </span><span class="s3">is None</span><span class="s1">)</span>

    <span class="s3">def </span><span class="s1">test_registerUtility_duplicates_existing_reg(self):</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">InterfaceClass</span>

        <span class="s3">class </span><span class="s1">IFoo(InterfaceClass):</span>
            <span class="s3">pass</span>
        <span class="s1">ifoo = IFoo(</span><span class="s4">'IFoo'</span><span class="s1">)</span>
        <span class="s1">_info = </span><span class="s4">u'info'</span>
        <span class="s1">_name = </span><span class="s4">u'name'</span>
        <span class="s1">_to_reg = object()</span>
        <span class="s1">comp = self._makeOne()</span>
        <span class="s1">comp.registerUtility(_to_reg</span><span class="s3">, </span><span class="s1">ifoo</span><span class="s3">, </span><span class="s1">_name</span><span class="s3">, </span><span class="s1">_info)</span>
        <span class="s1">_monkey</span><span class="s3">, </span><span class="s1">_events = self._wrapEvents()</span>
        <span class="s3">with </span><span class="s1">_monkey:</span>
            <span class="s1">comp.registerUtility(_to_reg</span><span class="s3">, </span><span class="s1">ifoo</span><span class="s3">, </span><span class="s1">_name</span><span class="s3">, </span><span class="s1">_info)</span>
        <span class="s1">self.assertEqual(len(_events)</span><span class="s3">, </span><span class="s5">0</span><span class="s1">)</span>

    <span class="s3">def </span><span class="s1">test_registerUtility_w_different_info(self):</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">InterfaceClass</span>

        <span class="s3">class </span><span class="s1">IFoo(InterfaceClass):</span>
            <span class="s3">pass</span>
        <span class="s1">ifoo = IFoo(</span><span class="s4">'IFoo'</span><span class="s1">)</span>
        <span class="s1">_info1 = </span><span class="s4">u'info1'</span>
        <span class="s1">_info2 = </span><span class="s4">u'info2'</span>
        <span class="s1">_name = </span><span class="s4">u'name'</span>
        <span class="s1">_to_reg = object()</span>
        <span class="s1">comp = self._makeOne()</span>
        <span class="s1">comp.registerUtility(_to_reg</span><span class="s3">, </span><span class="s1">ifoo</span><span class="s3">, </span><span class="s1">_name</span><span class="s3">, </span><span class="s1">_info1)</span>
        <span class="s1">_monkey</span><span class="s3">, </span><span class="s1">_events = self._wrapEvents()</span>
        <span class="s3">with </span><span class="s1">_monkey:</span>
            <span class="s1">comp.registerUtility(_to_reg</span><span class="s3">, </span><span class="s1">ifoo</span><span class="s3">, </span><span class="s1">_name</span><span class="s3">, </span><span class="s1">_info2)</span>
        <span class="s1">self.assertEqual(len(_events)</span><span class="s3">, </span><span class="s5">2</span><span class="s1">)  </span><span class="s0"># unreg, reg</span>
        <span class="s1">self.assertEqual(comp._utility_registrations[(ifoo</span><span class="s3">, </span><span class="s1">_name)]</span><span class="s3">,</span>
                         <span class="s1">(_to_reg</span><span class="s3">, </span><span class="s1">_info2</span><span class="s3">, None</span><span class="s1">))  </span><span class="s0"># replaced</span>
        <span class="s1">self.assertEqual(comp.utilities._subscribers[</span><span class="s5">0</span><span class="s1">][ifoo][</span><span class="s4">u''</span><span class="s1">]</span><span class="s3">,</span>
                         <span class="s1">(_to_reg</span><span class="s3">,</span><span class="s1">))</span>

    <span class="s3">def </span><span class="s1">test_registerUtility_w_different_names_same_component(self):</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">InterfaceClass</span>

        <span class="s3">class </span><span class="s1">IFoo(InterfaceClass):</span>
            <span class="s3">pass</span>
        <span class="s1">ifoo = IFoo(</span><span class="s4">'IFoo'</span><span class="s1">)</span>
        <span class="s1">_info = </span><span class="s4">u'info'</span>
        <span class="s1">_name1 = </span><span class="s4">u'name1'</span>
        <span class="s1">_name2 = </span><span class="s4">u'name2'</span>
        <span class="s1">_other_reg = object()</span>
        <span class="s1">_to_reg = object()</span>
        <span class="s1">comp = self._makeOne()</span>
        <span class="s1">comp.registerUtility(_other_reg</span><span class="s3">, </span><span class="s1">ifoo</span><span class="s3">, </span><span class="s1">_name1</span><span class="s3">, </span><span class="s1">_info)</span>
        <span class="s1">_monkey</span><span class="s3">, </span><span class="s1">_events = self._wrapEvents()</span>
        <span class="s3">with </span><span class="s1">_monkey:</span>
            <span class="s1">comp.registerUtility(_to_reg</span><span class="s3">, </span><span class="s1">ifoo</span><span class="s3">, </span><span class="s1">_name2</span><span class="s3">, </span><span class="s1">_info)</span>
        <span class="s1">self.assertEqual(len(_events)</span><span class="s3">, </span><span class="s5">1</span><span class="s1">)  </span><span class="s0"># reg</span>
        <span class="s1">self.assertEqual(comp._utility_registrations[(ifoo</span><span class="s3">, </span><span class="s1">_name1)]</span><span class="s3">,</span>
                         <span class="s1">(_other_reg</span><span class="s3">, </span><span class="s1">_info</span><span class="s3">, None</span><span class="s1">))</span>
        <span class="s1">self.assertEqual(comp._utility_registrations[(ifoo</span><span class="s3">, </span><span class="s1">_name2)]</span><span class="s3">,</span>
                         <span class="s1">(_to_reg</span><span class="s3">, </span><span class="s1">_info</span><span class="s3">, None</span><span class="s1">))</span>
        <span class="s1">self.assertEqual(comp.utilities._subscribers[</span><span class="s5">0</span><span class="s1">][ifoo][</span><span class="s4">u''</span><span class="s1">]</span><span class="s3">,</span>
                         <span class="s1">(_other_reg</span><span class="s3">, </span><span class="s1">_to_reg</span><span class="s3">,</span><span class="s1">))</span>

    <span class="s3">def </span><span class="s1">test_registerUtility_replaces_existing_reg(self):</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">InterfaceClass</span>
        <span class="s3">from </span><span class="s1">zope.interface.interfaces </span><span class="s3">import </span><span class="s1">Unregistered</span>
        <span class="s3">from </span><span class="s1">zope.interface.interfaces </span><span class="s3">import </span><span class="s1">Registered</span>
        <span class="s3">from </span><span class="s1">zope.interface.registry </span><span class="s3">import </span><span class="s1">UtilityRegistration</span>

        <span class="s3">class </span><span class="s1">IFoo(InterfaceClass):</span>
            <span class="s3">pass</span>
        <span class="s1">ifoo = IFoo(</span><span class="s4">'IFoo'</span><span class="s1">)</span>
        <span class="s1">_info = </span><span class="s4">u'info'</span>
        <span class="s1">_name = </span><span class="s4">u'name'</span>
        <span class="s1">_before</span><span class="s3">, </span><span class="s1">_after = object()</span><span class="s3">, </span><span class="s1">object()</span>
        <span class="s1">comp = self._makeOne()</span>
        <span class="s1">comp.registerUtility(_before</span><span class="s3">, </span><span class="s1">ifoo</span><span class="s3">, </span><span class="s1">_name</span><span class="s3">, </span><span class="s1">_info)</span>
        <span class="s1">_monkey</span><span class="s3">, </span><span class="s1">_events = self._wrapEvents()</span>
        <span class="s3">with </span><span class="s1">_monkey:</span>
            <span class="s1">comp.registerUtility(_after</span><span class="s3">, </span><span class="s1">ifoo</span><span class="s3">, </span><span class="s1">_name</span><span class="s3">, </span><span class="s1">_info)</span>
        <span class="s1">self.assertEqual(len(_events)</span><span class="s3">, </span><span class="s5">2</span><span class="s1">)</span>
        <span class="s1">args</span><span class="s3">, </span><span class="s1">kw = _events[</span><span class="s5">0</span><span class="s1">]</span>
        <span class="s1">event</span><span class="s3">, </span><span class="s1">= args</span>
        <span class="s1">self.assertEqual(kw</span><span class="s3">, </span><span class="s1">{})</span>
        <span class="s1">self.assertTrue(isinstance(event</span><span class="s3">, </span><span class="s1">Unregistered))</span>
        <span class="s1">self.assertTrue(isinstance(event.object</span><span class="s3">, </span><span class="s1">UtilityRegistration))</span>
        <span class="s1">self.assertTrue(event.object.registry </span><span class="s3">is </span><span class="s1">comp)</span>
        <span class="s1">self.assertTrue(event.object.provided </span><span class="s3">is </span><span class="s1">ifoo)</span>
        <span class="s1">self.assertTrue(event.object.name </span><span class="s3">is </span><span class="s1">_name)</span>
        <span class="s1">self.assertTrue(event.object.component </span><span class="s3">is </span><span class="s1">_before)</span>
        <span class="s1">self.assertTrue(event.object.info </span><span class="s3">is </span><span class="s1">_info)</span>
        <span class="s1">self.assertTrue(event.object.factory </span><span class="s3">is None</span><span class="s1">)</span>
        <span class="s1">args</span><span class="s3">, </span><span class="s1">kw = _events[</span><span class="s5">1</span><span class="s1">]</span>
        <span class="s1">event</span><span class="s3">, </span><span class="s1">= args</span>
        <span class="s1">self.assertEqual(kw</span><span class="s3">, </span><span class="s1">{})</span>
        <span class="s1">self.assertTrue(isinstance(event</span><span class="s3">, </span><span class="s1">Registered))</span>
        <span class="s1">self.assertTrue(isinstance(event.object</span><span class="s3">, </span><span class="s1">UtilityRegistration))</span>
        <span class="s1">self.assertTrue(event.object.registry </span><span class="s3">is </span><span class="s1">comp)</span>
        <span class="s1">self.assertTrue(event.object.provided </span><span class="s3">is </span><span class="s1">ifoo)</span>
        <span class="s1">self.assertTrue(event.object.name </span><span class="s3">is </span><span class="s1">_name)</span>
        <span class="s1">self.assertTrue(event.object.component </span><span class="s3">is </span><span class="s1">_after)</span>
        <span class="s1">self.assertTrue(event.object.info </span><span class="s3">is </span><span class="s1">_info)</span>
        <span class="s1">self.assertTrue(event.object.factory </span><span class="s3">is None</span><span class="s1">)</span>

    <span class="s3">def </span><span class="s1">test_registerUtility_w_existing_subscr(self):</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">InterfaceClass</span>

        <span class="s3">class </span><span class="s1">IFoo(InterfaceClass):</span>
            <span class="s3">pass</span>
        <span class="s1">ifoo = IFoo(</span><span class="s4">'IFoo'</span><span class="s1">)</span>
        <span class="s1">_info = </span><span class="s4">u'info'</span>
        <span class="s1">_name1 = </span><span class="s4">u'name1'</span>
        <span class="s1">_name2 = </span><span class="s4">u'name2'</span>
        <span class="s1">_to_reg = object()</span>
        <span class="s1">comp = self._makeOne()</span>
        <span class="s1">comp.registerUtility(_to_reg</span><span class="s3">, </span><span class="s1">ifoo</span><span class="s3">, </span><span class="s1">_name1</span><span class="s3">, </span><span class="s1">_info)</span>
        <span class="s1">_monkey</span><span class="s3">, </span><span class="s1">_events = self._wrapEvents()</span>
        <span class="s3">with </span><span class="s1">_monkey:</span>
            <span class="s1">comp.registerUtility(_to_reg</span><span class="s3">, </span><span class="s1">ifoo</span><span class="s3">, </span><span class="s1">_name2</span><span class="s3">, </span><span class="s1">_info)</span>
        <span class="s1">self.assertEqual(comp.utilities._subscribers[</span><span class="s5">0</span><span class="s1">][ifoo][</span><span class="s4">''</span><span class="s1">]</span><span class="s3">, </span><span class="s1">(_to_reg</span><span class="s3">,</span><span class="s1">))</span>

    <span class="s3">def </span><span class="s1">test_registerUtility_wo_event(self):</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">InterfaceClass</span>

        <span class="s3">class </span><span class="s1">IFoo(InterfaceClass):</span>
            <span class="s3">pass</span>
        <span class="s1">ifoo = IFoo(</span><span class="s4">'IFoo'</span><span class="s1">)</span>
        <span class="s1">_info = </span><span class="s4">u'info'</span>
        <span class="s1">_name = </span><span class="s4">u'name'</span>
        <span class="s1">_to_reg = object()</span>
        <span class="s1">comp = self._makeOne()</span>
        <span class="s1">_monkey</span><span class="s3">, </span><span class="s1">_events = self._wrapEvents()</span>
        <span class="s3">with </span><span class="s1">_monkey:</span>
            <span class="s1">comp.registerUtility(_to_reg</span><span class="s3">, </span><span class="s1">ifoo</span><span class="s3">, </span><span class="s1">_name</span><span class="s3">, </span><span class="s1">_info</span><span class="s3">, False</span><span class="s1">)</span>
        <span class="s1">self.assertEqual(len(_events)</span><span class="s3">, </span><span class="s5">0</span><span class="s1">)</span>

    <span class="s3">def </span><span class="s1">test_registerUtility_changes_object_identity_after(self):</span>
        <span class="s0"># If a subclass changes the identity of the _utility_registrations,</span>
        <span class="s0"># the cache is updated and the right thing still happens.</span>
        <span class="s3">class </span><span class="s1">CompThatChangesAfter1Reg(self._getTargetClass()):</span>
            <span class="s1">reg_count = </span><span class="s5">0</span>
            <span class="s3">def </span><span class="s1">registerUtility(self</span><span class="s3">, </span><span class="s1">*args):</span>
                <span class="s1">self.reg_count += </span><span class="s5">1</span>
                <span class="s1">super(CompThatChangesAfter1Reg</span><span class="s3">, </span><span class="s1">self).registerUtility(*args)</span>
                <span class="s3">if </span><span class="s1">self.reg_count == </span><span class="s5">1</span><span class="s1">:</span>
                    <span class="s1">self._utility_registrations = dict(self._utility_registrations)</span>

        <span class="s1">comp = CompThatChangesAfter1Reg()</span>
        <span class="s1">comp.registerUtility(object()</span><span class="s3">, </span><span class="s1">Interface)</span>

        <span class="s1">self.assertEqual(len(list(comp.registeredUtilities()))</span><span class="s3">, </span><span class="s5">1</span><span class="s1">)</span>

        <span class="s3">class </span><span class="s1">IFoo(Interface):</span>
            <span class="s3">pass</span>

        <span class="s1">comp.registerUtility(object()</span><span class="s3">, </span><span class="s1">IFoo)</span>
        <span class="s1">self.assertEqual(len(list(comp.registeredUtilities()))</span><span class="s3">, </span><span class="s5">2</span><span class="s1">)</span>

    <span class="s3">def </span><span class="s1">test_registerUtility_changes_object_identity_before(self):</span>
        <span class="s0"># If a subclass changes the identity of the _utility_registrations,</span>
        <span class="s0"># the cache is updated and the right thing still happens.</span>
        <span class="s3">class </span><span class="s1">CompThatChangesAfter2Reg(self._getTargetClass()):</span>
            <span class="s1">reg_count = </span><span class="s5">0</span>
            <span class="s3">def </span><span class="s1">registerUtility(self</span><span class="s3">, </span><span class="s1">*args):</span>
                <span class="s1">self.reg_count += </span><span class="s5">1</span>
                <span class="s3">if </span><span class="s1">self.reg_count == </span><span class="s5">2</span><span class="s1">:</span>
                    <span class="s1">self._utility_registrations = dict(self._utility_registrations)</span>

                <span class="s1">super(CompThatChangesAfter2Reg</span><span class="s3">, </span><span class="s1">self).registerUtility(*args)</span>

        <span class="s1">comp = CompThatChangesAfter2Reg()</span>
        <span class="s1">comp.registerUtility(object()</span><span class="s3">, </span><span class="s1">Interface)</span>

        <span class="s1">self.assertEqual(len(list(comp.registeredUtilities()))</span><span class="s3">, </span><span class="s5">1</span><span class="s1">)</span>

        <span class="s3">class </span><span class="s1">IFoo(Interface):</span>
            <span class="s3">pass</span>

        <span class="s1">comp.registerUtility(object()</span><span class="s3">, </span><span class="s1">IFoo)</span>
        <span class="s1">self.assertEqual(len(list(comp.registeredUtilities()))</span><span class="s3">, </span><span class="s5">2</span><span class="s1">)</span>


        <span class="s3">class </span><span class="s1">IBar(Interface):</span>
            <span class="s3">pass</span>

        <span class="s1">comp.registerUtility(object()</span><span class="s3">, </span><span class="s1">IBar)</span>
        <span class="s1">self.assertEqual(len(list(comp.registeredUtilities()))</span><span class="s3">, </span><span class="s5">3</span><span class="s1">)</span>


    <span class="s3">def </span><span class="s1">test_unregisterUtility_neither_factory_nor_component_nor_provided(self):</span>
        <span class="s1">comp = self._makeOne()</span>
        <span class="s1">self.assertRaises(TypeError</span><span class="s3">, </span><span class="s1">comp.unregisterUtility</span><span class="s3">,</span>
                          <span class="s1">component=</span><span class="s3">None, </span><span class="s1">provided=</span><span class="s3">None, </span><span class="s1">factory=</span><span class="s3">None</span><span class="s1">)</span>

    <span class="s3">def </span><span class="s1">test_unregisterUtility_both_factory_and_component(self):</span>
        <span class="s3">def </span><span class="s1">_factory():</span>
            <span class="s3">raise </span><span class="s1">NotImplementedError()</span>
        <span class="s1">_to_reg = object()</span>
        <span class="s1">comp = self._makeOne()</span>
        <span class="s1">self.assertRaises(TypeError</span><span class="s3">, </span><span class="s1">comp.unregisterUtility</span><span class="s3">,</span>
                          <span class="s1">component=_to_reg</span><span class="s3">, </span><span class="s1">factory=_factory)</span>

    <span class="s3">def </span><span class="s1">test_unregisterUtility_w_component_miss(self):</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">InterfaceClass</span>

        <span class="s3">class </span><span class="s1">IFoo(InterfaceClass):</span>
            <span class="s3">pass</span>
        <span class="s1">ifoo = IFoo(</span><span class="s4">'IFoo'</span><span class="s1">)</span>
        <span class="s1">_name = </span><span class="s4">u'name'</span>
        <span class="s1">_to_reg = object()</span>
        <span class="s1">comp = self._makeOne()</span>
        <span class="s1">_monkey</span><span class="s3">, </span><span class="s1">_events = self._wrapEvents()</span>
        <span class="s3">with </span><span class="s1">_monkey:</span>
            <span class="s1">unreg = comp.unregisterUtility(_to_reg</span><span class="s3">, </span><span class="s1">ifoo</span><span class="s3">, </span><span class="s1">_name)</span>
        <span class="s1">self.assertFalse(unreg)</span>
        <span class="s1">self.assertFalse(_events)</span>

    <span class="s3">def </span><span class="s1">test_unregisterUtility_w_component(self):</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">InterfaceClass</span>
        <span class="s3">from </span><span class="s1">zope.interface.interfaces </span><span class="s3">import </span><span class="s1">Unregistered</span>
        <span class="s3">from </span><span class="s1">zope.interface.registry </span><span class="s3">import </span><span class="s1">UtilityRegistration</span>

        <span class="s3">class </span><span class="s1">IFoo(InterfaceClass):</span>
            <span class="s3">pass</span>
        <span class="s1">ifoo = IFoo(</span><span class="s4">'IFoo'</span><span class="s1">)</span>
        <span class="s1">_name = </span><span class="s4">u'name'</span>
        <span class="s1">_to_reg = object()</span>
        <span class="s1">comp = self._makeOne()</span>
        <span class="s1">comp.registerUtility(_to_reg</span><span class="s3">, </span><span class="s1">ifoo</span><span class="s3">, </span><span class="s1">_name)</span>
        <span class="s1">_monkey</span><span class="s3">, </span><span class="s1">_events = self._wrapEvents()</span>
        <span class="s3">with </span><span class="s1">_monkey:</span>
            <span class="s1">unreg = comp.unregisterUtility(_to_reg</span><span class="s3">, </span><span class="s1">ifoo</span><span class="s3">, </span><span class="s1">_name)</span>
        <span class="s1">self.assertTrue(unreg)</span>
        <span class="s1">self.assertFalse(comp.utilities._adapters) </span><span class="s0"># all erased</span>
        <span class="s1">self.assertFalse((ifoo</span><span class="s3">, </span><span class="s1">_name) </span><span class="s3">in </span><span class="s1">comp._utility_registrations)</span>
        <span class="s1">self.assertFalse(comp.utilities._subscribers)</span>
        <span class="s1">self.assertEqual(len(_events)</span><span class="s3">, </span><span class="s5">1</span><span class="s1">)</span>
        <span class="s1">args</span><span class="s3">, </span><span class="s1">kw = _events[</span><span class="s5">0</span><span class="s1">]</span>
        <span class="s1">event</span><span class="s3">, </span><span class="s1">= args</span>
        <span class="s1">self.assertEqual(kw</span><span class="s3">, </span><span class="s1">{})</span>
        <span class="s1">self.assertTrue(isinstance(event</span><span class="s3">, </span><span class="s1">Unregistered))</span>
        <span class="s1">self.assertTrue(isinstance(event.object</span><span class="s3">, </span><span class="s1">UtilityRegistration))</span>
        <span class="s1">self.assertTrue(event.object.registry </span><span class="s3">is </span><span class="s1">comp)</span>
        <span class="s1">self.assertTrue(event.object.provided </span><span class="s3">is </span><span class="s1">ifoo)</span>
        <span class="s1">self.assertTrue(event.object.name </span><span class="s3">is </span><span class="s1">_name)</span>
        <span class="s1">self.assertTrue(event.object.component </span><span class="s3">is </span><span class="s1">_to_reg)</span>
        <span class="s1">self.assertTrue(event.object.factory </span><span class="s3">is None</span><span class="s1">)</span>

    <span class="s3">def </span><span class="s1">test_unregisterUtility_w_factory(self):</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">InterfaceClass</span>
        <span class="s3">from </span><span class="s1">zope.interface.interfaces </span><span class="s3">import </span><span class="s1">Unregistered</span>
        <span class="s3">from </span><span class="s1">zope.interface.registry </span><span class="s3">import </span><span class="s1">UtilityRegistration</span>

        <span class="s3">class </span><span class="s1">IFoo(InterfaceClass):</span>
            <span class="s3">pass</span>
        <span class="s1">ifoo = IFoo(</span><span class="s4">'IFoo'</span><span class="s1">)</span>
        <span class="s1">_info = </span><span class="s4">u'info'</span>
        <span class="s1">_name = </span><span class="s4">u'name'</span>
        <span class="s1">_to_reg = object()</span>
        <span class="s3">def </span><span class="s1">_factory():</span>
            <span class="s3">return </span><span class="s1">_to_reg</span>
        <span class="s1">comp = self._makeOne()</span>
        <span class="s1">comp.registerUtility(</span><span class="s3">None, </span><span class="s1">ifoo</span><span class="s3">, </span><span class="s1">_name</span><span class="s3">, </span><span class="s1">_info</span><span class="s3">, </span><span class="s1">factory=_factory)</span>
        <span class="s1">_monkey</span><span class="s3">, </span><span class="s1">_events = self._wrapEvents()</span>
        <span class="s3">with </span><span class="s1">_monkey:</span>
            <span class="s1">unreg = comp.unregisterUtility(</span><span class="s3">None, </span><span class="s1">ifoo</span><span class="s3">, </span><span class="s1">_name</span><span class="s3">, </span><span class="s1">factory=_factory)</span>
        <span class="s1">self.assertTrue(unreg)</span>
        <span class="s1">self.assertEqual(len(_events)</span><span class="s3">, </span><span class="s5">1</span><span class="s1">)</span>
        <span class="s1">args</span><span class="s3">, </span><span class="s1">kw = _events[</span><span class="s5">0</span><span class="s1">]</span>
        <span class="s1">event</span><span class="s3">, </span><span class="s1">= args</span>
        <span class="s1">self.assertEqual(kw</span><span class="s3">, </span><span class="s1">{})</span>
        <span class="s1">self.assertTrue(isinstance(event</span><span class="s3">, </span><span class="s1">Unregistered))</span>
        <span class="s1">self.assertTrue(isinstance(event.object</span><span class="s3">, </span><span class="s1">UtilityRegistration))</span>
        <span class="s1">self.assertTrue(event.object.registry </span><span class="s3">is </span><span class="s1">comp)</span>
        <span class="s1">self.assertTrue(event.object.provided </span><span class="s3">is </span><span class="s1">ifoo)</span>
        <span class="s1">self.assertTrue(event.object.name </span><span class="s3">is </span><span class="s1">_name)</span>
        <span class="s1">self.assertTrue(event.object.component </span><span class="s3">is </span><span class="s1">_to_reg)</span>
        <span class="s1">self.assertTrue(event.object.factory </span><span class="s3">is </span><span class="s1">_factory)</span>

    <span class="s3">def </span><span class="s1">test_unregisterUtility_wo_explicit_provided(self):</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">directlyProvides</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">InterfaceClass</span>
        <span class="s3">from </span><span class="s1">zope.interface.interfaces </span><span class="s3">import </span><span class="s1">Unregistered</span>
        <span class="s3">from </span><span class="s1">zope.interface.registry </span><span class="s3">import </span><span class="s1">UtilityRegistration</span>

        <span class="s3">class </span><span class="s1">IFoo(InterfaceClass):</span>
            <span class="s3">pass</span>
        <span class="s3">class </span><span class="s1">Foo(object):</span>
            <span class="s3">pass</span>
        <span class="s1">ifoo = IFoo(</span><span class="s4">'IFoo'</span><span class="s1">)</span>
        <span class="s1">_info = </span><span class="s4">u'info'</span>
        <span class="s1">_name = </span><span class="s4">u'name'</span>
        <span class="s1">_to_reg = Foo()</span>
        <span class="s1">directlyProvides(_to_reg</span><span class="s3">, </span><span class="s1">ifoo)</span>
        <span class="s1">comp = self._makeOne()</span>
        <span class="s1">comp.registerUtility(_to_reg</span><span class="s3">, </span><span class="s1">ifoo</span><span class="s3">, </span><span class="s1">_name</span><span class="s3">, </span><span class="s1">_info)</span>
        <span class="s1">_monkey</span><span class="s3">, </span><span class="s1">_events = self._wrapEvents()</span>
        <span class="s3">with </span><span class="s1">_monkey:</span>
            <span class="s1">unreg = comp.unregisterUtility(_to_reg</span><span class="s3">, None, </span><span class="s1">_name)</span>
        <span class="s1">self.assertTrue(unreg)</span>
        <span class="s1">self.assertEqual(len(_events)</span><span class="s3">, </span><span class="s5">1</span><span class="s1">)</span>
        <span class="s1">args</span><span class="s3">, </span><span class="s1">kw = _events[</span><span class="s5">0</span><span class="s1">]</span>
        <span class="s1">event</span><span class="s3">, </span><span class="s1">= args</span>
        <span class="s1">self.assertEqual(kw</span><span class="s3">, </span><span class="s1">{})</span>
        <span class="s1">self.assertTrue(isinstance(event</span><span class="s3">, </span><span class="s1">Unregistered))</span>
        <span class="s1">self.assertTrue(isinstance(event.object</span><span class="s3">, </span><span class="s1">UtilityRegistration))</span>
        <span class="s1">self.assertTrue(event.object.registry </span><span class="s3">is </span><span class="s1">comp)</span>
        <span class="s1">self.assertTrue(event.object.provided </span><span class="s3">is </span><span class="s1">ifoo)</span>
        <span class="s1">self.assertTrue(event.object.name </span><span class="s3">is </span><span class="s1">_name)</span>
        <span class="s1">self.assertTrue(event.object.component </span><span class="s3">is </span><span class="s1">_to_reg)</span>
        <span class="s1">self.assertTrue(event.object.info </span><span class="s3">is </span><span class="s1">_info)</span>
        <span class="s1">self.assertTrue(event.object.factory </span><span class="s3">is None</span><span class="s1">)</span>

    <span class="s3">def </span><span class="s1">test_unregisterUtility_wo_component_or_factory(self):</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">directlyProvides</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">InterfaceClass</span>
        <span class="s3">from </span><span class="s1">zope.interface.interfaces </span><span class="s3">import </span><span class="s1">Unregistered</span>
        <span class="s3">from </span><span class="s1">zope.interface.registry </span><span class="s3">import </span><span class="s1">UtilityRegistration</span>

        <span class="s3">class </span><span class="s1">IFoo(InterfaceClass):</span>
            <span class="s3">pass</span>
        <span class="s3">class </span><span class="s1">Foo(object):</span>
            <span class="s3">pass</span>
        <span class="s1">ifoo = IFoo(</span><span class="s4">'IFoo'</span><span class="s1">)</span>
        <span class="s1">_info = </span><span class="s4">u'info'</span>
        <span class="s1">_name = </span><span class="s4">u'name'</span>
        <span class="s1">_to_reg = Foo()</span>
        <span class="s1">directlyProvides(_to_reg</span><span class="s3">, </span><span class="s1">ifoo)</span>
        <span class="s1">comp = self._makeOne()</span>
        <span class="s1">comp.registerUtility(_to_reg</span><span class="s3">, </span><span class="s1">ifoo</span><span class="s3">, </span><span class="s1">_name</span><span class="s3">, </span><span class="s1">_info)</span>
        <span class="s1">_monkey</span><span class="s3">, </span><span class="s1">_events = self._wrapEvents()</span>
        <span class="s3">with </span><span class="s1">_monkey:</span>
            <span class="s0"># Just pass the interface / name</span>
            <span class="s1">unreg = comp.unregisterUtility(provided=ifoo</span><span class="s3">, </span><span class="s1">name=_name)</span>
        <span class="s1">self.assertTrue(unreg)</span>
        <span class="s1">self.assertEqual(len(_events)</span><span class="s3">, </span><span class="s5">1</span><span class="s1">)</span>
        <span class="s1">args</span><span class="s3">, </span><span class="s1">kw = _events[</span><span class="s5">0</span><span class="s1">]</span>
        <span class="s1">event</span><span class="s3">, </span><span class="s1">= args</span>
        <span class="s1">self.assertEqual(kw</span><span class="s3">, </span><span class="s1">{})</span>
        <span class="s1">self.assertTrue(isinstance(event</span><span class="s3">, </span><span class="s1">Unregistered))</span>
        <span class="s1">self.assertTrue(isinstance(event.object</span><span class="s3">, </span><span class="s1">UtilityRegistration))</span>
        <span class="s1">self.assertTrue(event.object.registry </span><span class="s3">is </span><span class="s1">comp)</span>
        <span class="s1">self.assertTrue(event.object.provided </span><span class="s3">is </span><span class="s1">ifoo)</span>
        <span class="s1">self.assertTrue(event.object.name </span><span class="s3">is </span><span class="s1">_name)</span>
        <span class="s1">self.assertTrue(event.object.component </span><span class="s3">is </span><span class="s1">_to_reg)</span>
        <span class="s1">self.assertTrue(event.object.info </span><span class="s3">is </span><span class="s1">_info)</span>
        <span class="s1">self.assertTrue(event.object.factory </span><span class="s3">is None</span><span class="s1">)</span>

    <span class="s3">def </span><span class="s1">test_unregisterUtility_w_existing_subscr(self):</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">InterfaceClass</span>

        <span class="s3">class </span><span class="s1">IFoo(InterfaceClass):</span>
            <span class="s3">pass</span>
        <span class="s1">ifoo = IFoo(</span><span class="s4">'IFoo'</span><span class="s1">)</span>
        <span class="s1">_info = </span><span class="s4">u'info'</span>
        <span class="s1">_name1 = </span><span class="s4">u'name1'</span>
        <span class="s1">_name2 = </span><span class="s4">u'name2'</span>
        <span class="s1">_to_reg = object()</span>
        <span class="s1">comp = self._makeOne()</span>
        <span class="s1">comp.registerUtility(_to_reg</span><span class="s3">, </span><span class="s1">ifoo</span><span class="s3">, </span><span class="s1">_name1</span><span class="s3">, </span><span class="s1">_info)</span>
        <span class="s1">comp.registerUtility(_to_reg</span><span class="s3">, </span><span class="s1">ifoo</span><span class="s3">, </span><span class="s1">_name2</span><span class="s3">, </span><span class="s1">_info)</span>
        <span class="s1">_monkey</span><span class="s3">, </span><span class="s1">_events = self._wrapEvents()</span>
        <span class="s3">with </span><span class="s1">_monkey:</span>
            <span class="s1">comp.unregisterUtility(_to_reg</span><span class="s3">, </span><span class="s1">ifoo</span><span class="s3">, </span><span class="s1">_name2)</span>
        <span class="s1">self.assertEqual(comp.utilities._subscribers[</span><span class="s5">0</span><span class="s1">][ifoo][</span><span class="s4">''</span><span class="s1">]</span><span class="s3">, </span><span class="s1">(_to_reg</span><span class="s3">,</span><span class="s1">))</span>

    <span class="s3">def </span><span class="s1">test_unregisterUtility_w_existing_subscr_non_hashable(self):</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">InterfaceClass</span>

        <span class="s3">class </span><span class="s1">IFoo(InterfaceClass):</span>
            <span class="s3">pass</span>
        <span class="s1">ifoo = IFoo(</span><span class="s4">'IFoo'</span><span class="s1">)</span>
        <span class="s1">_info = </span><span class="s4">u'info'</span>
        <span class="s1">_name1 = </span><span class="s4">u'name1'</span>
        <span class="s1">_name2 = </span><span class="s4">u'name2'</span>
        <span class="s1">_to_reg = dict()</span>
        <span class="s1">comp = self._makeOne()</span>
        <span class="s1">comp.registerUtility(_to_reg</span><span class="s3">, </span><span class="s1">ifoo</span><span class="s3">, </span><span class="s1">_name1</span><span class="s3">, </span><span class="s1">_info)</span>
        <span class="s1">comp.registerUtility(_to_reg</span><span class="s3">, </span><span class="s1">ifoo</span><span class="s3">, </span><span class="s1">_name2</span><span class="s3">, </span><span class="s1">_info)</span>
        <span class="s1">_monkey</span><span class="s3">, </span><span class="s1">_events = self._wrapEvents()</span>
        <span class="s3">with </span><span class="s1">_monkey:</span>
            <span class="s1">comp.unregisterUtility(_to_reg</span><span class="s3">, </span><span class="s1">ifoo</span><span class="s3">, </span><span class="s1">_name2)</span>
        <span class="s1">self.assertEqual(comp.utilities._subscribers[</span><span class="s5">0</span><span class="s1">][ifoo][</span><span class="s4">''</span><span class="s1">]</span><span class="s3">, </span><span class="s1">(_to_reg</span><span class="s3">,</span><span class="s1">))</span>

    <span class="s3">def </span><span class="s1">test_unregisterUtility_w_existing_subscr_non_hashable_fresh_cache(self):</span>
        <span class="s0"># We correctly populate the cache of registrations if it has gone away</span>
        <span class="s0"># (for example, the Components was unpickled)</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">InterfaceClass</span>
        <span class="s3">from </span><span class="s1">zope.interface.registry </span><span class="s3">import </span><span class="s1">_UtilityRegistrations</span>

        <span class="s3">class </span><span class="s1">IFoo(InterfaceClass):</span>
            <span class="s3">pass</span>
        <span class="s1">ifoo = IFoo(</span><span class="s4">'IFoo'</span><span class="s1">)</span>
        <span class="s1">_info = </span><span class="s4">u'info'</span>
        <span class="s1">_name1 = </span><span class="s4">u'name1'</span>
        <span class="s1">_name2 = </span><span class="s4">u'name2'</span>
        <span class="s1">_to_reg = dict()</span>
        <span class="s1">comp = self._makeOne()</span>
        <span class="s1">comp.registerUtility(_to_reg</span><span class="s3">, </span><span class="s1">ifoo</span><span class="s3">, </span><span class="s1">_name1</span><span class="s3">, </span><span class="s1">_info)</span>
        <span class="s1">comp.registerUtility(_to_reg</span><span class="s3">, </span><span class="s1">ifoo</span><span class="s3">, </span><span class="s1">_name2</span><span class="s3">, </span><span class="s1">_info)</span>

        <span class="s1">_monkey</span><span class="s3">, </span><span class="s1">_events = self._wrapEvents()</span>
        <span class="s3">with </span><span class="s1">_monkey:</span>
            <span class="s1">comp.unregisterUtility(_to_reg</span><span class="s3">, </span><span class="s1">ifoo</span><span class="s3">, </span><span class="s1">_name2)</span>
        <span class="s1">self.assertEqual(comp.utilities._subscribers[</span><span class="s5">0</span><span class="s1">][ifoo][</span><span class="s4">''</span><span class="s1">]</span><span class="s3">, </span><span class="s1">(_to_reg</span><span class="s3">,</span><span class="s1">))</span>

    <span class="s3">def </span><span class="s1">test_unregisterUtility_w_existing_subscr_non_hashable_reinitted(self):</span>
        <span class="s0"># We correctly populate the cache of registrations if the base objects change</span>
        <span class="s0"># out from under us</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">InterfaceClass</span>

        <span class="s3">class </span><span class="s1">IFoo(InterfaceClass):</span>
            <span class="s3">pass</span>
        <span class="s1">ifoo = IFoo(</span><span class="s4">'IFoo'</span><span class="s1">)</span>
        <span class="s1">_info = </span><span class="s4">u'info'</span>
        <span class="s1">_name1 = </span><span class="s4">u'name1'</span>
        <span class="s1">_name2 = </span><span class="s4">u'name2'</span>
        <span class="s1">_to_reg = dict()</span>
        <span class="s1">comp = self._makeOne()</span>
        <span class="s1">comp.registerUtility(_to_reg</span><span class="s3">, </span><span class="s1">ifoo</span><span class="s3">, </span><span class="s1">_name1</span><span class="s3">, </span><span class="s1">_info)</span>
        <span class="s1">comp.registerUtility(_to_reg</span><span class="s3">, </span><span class="s1">ifoo</span><span class="s3">, </span><span class="s1">_name2</span><span class="s3">, </span><span class="s1">_info)</span>

        <span class="s0"># zope.component.testing does this</span>
        <span class="s1">comp.__init__(</span><span class="s4">'base'</span><span class="s1">)</span>

        <span class="s1">comp.registerUtility(_to_reg</span><span class="s3">, </span><span class="s1">ifoo</span><span class="s3">, </span><span class="s1">_name2</span><span class="s3">, </span><span class="s1">_info)</span>

        <span class="s1">_monkey</span><span class="s3">, </span><span class="s1">_events = self._wrapEvents()</span>
        <span class="s3">with </span><span class="s1">_monkey:</span>
            <span class="s0"># Nothing to do, but we don't break either</span>
            <span class="s1">comp.unregisterUtility(_to_reg</span><span class="s3">, </span><span class="s1">ifoo</span><span class="s3">, </span><span class="s1">_name2)</span>
        <span class="s1">self.assertEqual(</span><span class="s5">0</span><span class="s3">, </span><span class="s1">len(comp.utilities._subscribers))</span>

    <span class="s3">def </span><span class="s1">test_unregisterUtility_w_existing_subscr_other_component(self):</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">InterfaceClass</span>

        <span class="s3">class </span><span class="s1">IFoo(InterfaceClass):</span>
            <span class="s3">pass</span>
        <span class="s1">ifoo = IFoo(</span><span class="s4">'IFoo'</span><span class="s1">)</span>
        <span class="s1">_info = </span><span class="s4">u'info'</span>
        <span class="s1">_name1 = </span><span class="s4">u'name1'</span>
        <span class="s1">_name2 = </span><span class="s4">u'name2'</span>
        <span class="s1">_other_reg = object()</span>
        <span class="s1">_to_reg = object()</span>
        <span class="s1">comp = self._makeOne()</span>
        <span class="s1">comp.registerUtility(_other_reg</span><span class="s3">, </span><span class="s1">ifoo</span><span class="s3">, </span><span class="s1">_name1</span><span class="s3">, </span><span class="s1">_info)</span>
        <span class="s1">comp.registerUtility(_to_reg</span><span class="s3">, </span><span class="s1">ifoo</span><span class="s3">, </span><span class="s1">_name2</span><span class="s3">, </span><span class="s1">_info)</span>
        <span class="s1">_monkey</span><span class="s3">, </span><span class="s1">_events = self._wrapEvents()</span>
        <span class="s3">with </span><span class="s1">_monkey:</span>
            <span class="s1">comp.unregisterUtility(_to_reg</span><span class="s3">, </span><span class="s1">ifoo</span><span class="s3">, </span><span class="s1">_name2)</span>
        <span class="s1">self.assertEqual(comp.utilities._subscribers[</span><span class="s5">0</span><span class="s1">][ifoo][</span><span class="s4">''</span><span class="s1">]</span><span class="s3">,</span>
                         <span class="s1">(_other_reg</span><span class="s3">,</span><span class="s1">))</span>

    <span class="s3">def </span><span class="s1">test_unregisterUtility_w_existing_subscr_other_component_mixed_hash(self):</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">InterfaceClass</span>

        <span class="s3">class </span><span class="s1">IFoo(InterfaceClass):</span>
            <span class="s3">pass</span>
        <span class="s1">ifoo = IFoo(</span><span class="s4">'IFoo'</span><span class="s1">)</span>
        <span class="s1">_info = </span><span class="s4">u'info'</span>
        <span class="s1">_name1 = </span><span class="s4">u'name1'</span>
        <span class="s1">_name2 = </span><span class="s4">u'name2'</span>
        <span class="s0"># First register something hashable</span>
        <span class="s1">_other_reg = object()</span>
        <span class="s0"># Then it transfers to something unhashable</span>
        <span class="s1">_to_reg = dict()</span>
        <span class="s1">comp = self._makeOne()</span>
        <span class="s1">comp.registerUtility(_other_reg</span><span class="s3">, </span><span class="s1">ifoo</span><span class="s3">, </span><span class="s1">_name1</span><span class="s3">, </span><span class="s1">_info)</span>
        <span class="s1">comp.registerUtility(_to_reg</span><span class="s3">, </span><span class="s1">ifoo</span><span class="s3">, </span><span class="s1">_name2</span><span class="s3">, </span><span class="s1">_info)</span>
        <span class="s1">_monkey</span><span class="s3">, </span><span class="s1">_events = self._wrapEvents()</span>
        <span class="s3">with </span><span class="s1">_monkey:</span>
            <span class="s1">comp.unregisterUtility(_to_reg</span><span class="s3">, </span><span class="s1">ifoo</span><span class="s3">, </span><span class="s1">_name2)</span>
        <span class="s1">self.assertEqual(comp.utilities._subscribers[</span><span class="s5">0</span><span class="s1">][ifoo][</span><span class="s4">''</span><span class="s1">]</span><span class="s3">,</span>
                         <span class="s1">(_other_reg</span><span class="s3">,</span><span class="s1">))</span>

    <span class="s3">def </span><span class="s1">test_registeredUtilities_empty(self):</span>
        <span class="s1">comp = self._makeOne()</span>
        <span class="s1">self.assertEqual(list(comp.registeredUtilities())</span><span class="s3">, </span><span class="s1">[])</span>

    <span class="s3">def </span><span class="s1">test_registeredUtilities_notempty(self):</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">InterfaceClass</span>

        <span class="s3">from </span><span class="s1">zope.interface.registry </span><span class="s3">import </span><span class="s1">UtilityRegistration</span>
        <span class="s3">class </span><span class="s1">IFoo(InterfaceClass):</span>
            <span class="s3">pass</span>
        <span class="s1">ifoo = IFoo(</span><span class="s4">'IFoo'</span><span class="s1">)</span>
        <span class="s1">_info = </span><span class="s4">u'info'</span>
        <span class="s1">_name1 = </span><span class="s4">u'name1'</span>
        <span class="s1">_name2 = </span><span class="s4">u'name2'</span>
        <span class="s1">_to_reg = object()</span>
        <span class="s1">comp = self._makeOne()</span>
        <span class="s1">comp.registerUtility(_to_reg</span><span class="s3">, </span><span class="s1">ifoo</span><span class="s3">, </span><span class="s1">_name1</span><span class="s3">, </span><span class="s1">_info)</span>
        <span class="s1">comp.registerUtility(_to_reg</span><span class="s3">, </span><span class="s1">ifoo</span><span class="s3">, </span><span class="s1">_name2</span><span class="s3">, </span><span class="s1">_info)</span>
        <span class="s1">reg = sorted(comp.registeredUtilities()</span><span class="s3">, </span><span class="s1">key=</span><span class="s3">lambda </span><span class="s1">r: r.name)</span>
        <span class="s1">self.assertEqual(len(reg)</span><span class="s3">, </span><span class="s5">2</span><span class="s1">)</span>
        <span class="s1">self.assertTrue(isinstance(reg[</span><span class="s5">0</span><span class="s1">]</span><span class="s3">, </span><span class="s1">UtilityRegistration))</span>
        <span class="s1">self.assertTrue(reg[</span><span class="s5">0</span><span class="s1">].registry </span><span class="s3">is </span><span class="s1">comp)</span>
        <span class="s1">self.assertTrue(reg[</span><span class="s5">0</span><span class="s1">].provided </span><span class="s3">is </span><span class="s1">ifoo)</span>
        <span class="s1">self.assertTrue(reg[</span><span class="s5">0</span><span class="s1">].name </span><span class="s3">is </span><span class="s1">_name1)</span>
        <span class="s1">self.assertTrue(reg[</span><span class="s5">0</span><span class="s1">].component </span><span class="s3">is </span><span class="s1">_to_reg)</span>
        <span class="s1">self.assertTrue(reg[</span><span class="s5">0</span><span class="s1">].info </span><span class="s3">is </span><span class="s1">_info)</span>
        <span class="s1">self.assertTrue(reg[</span><span class="s5">0</span><span class="s1">].factory </span><span class="s3">is None</span><span class="s1">)</span>
        <span class="s1">self.assertTrue(isinstance(reg[</span><span class="s5">1</span><span class="s1">]</span><span class="s3">, </span><span class="s1">UtilityRegistration))</span>
        <span class="s1">self.assertTrue(reg[</span><span class="s5">1</span><span class="s1">].registry </span><span class="s3">is </span><span class="s1">comp)</span>
        <span class="s1">self.assertTrue(reg[</span><span class="s5">1</span><span class="s1">].provided </span><span class="s3">is </span><span class="s1">ifoo)</span>
        <span class="s1">self.assertTrue(reg[</span><span class="s5">1</span><span class="s1">].name </span><span class="s3">is </span><span class="s1">_name2)</span>
        <span class="s1">self.assertTrue(reg[</span><span class="s5">1</span><span class="s1">].component </span><span class="s3">is </span><span class="s1">_to_reg)</span>
        <span class="s1">self.assertTrue(reg[</span><span class="s5">1</span><span class="s1">].info </span><span class="s3">is </span><span class="s1">_info)</span>
        <span class="s1">self.assertTrue(reg[</span><span class="s5">1</span><span class="s1">].factory </span><span class="s3">is None</span><span class="s1">)</span>

    <span class="s3">def </span><span class="s1">test_queryUtility_miss_no_default(self):</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">InterfaceClass</span>
        <span class="s3">class </span><span class="s1">IFoo(InterfaceClass):</span>
            <span class="s3">pass</span>
        <span class="s1">ifoo = IFoo(</span><span class="s4">'IFoo'</span><span class="s1">)</span>
        <span class="s1">comp = self._makeOne()</span>
        <span class="s1">self.assertTrue(comp.queryUtility(ifoo) </span><span class="s3">is None</span><span class="s1">)</span>

    <span class="s3">def </span><span class="s1">test_queryUtility_miss_w_default(self):</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">InterfaceClass</span>
        <span class="s3">class </span><span class="s1">IFoo(InterfaceClass):</span>
            <span class="s3">pass</span>
        <span class="s1">ifoo = IFoo(</span><span class="s4">'IFoo'</span><span class="s1">)</span>
        <span class="s1">comp = self._makeOne()</span>
        <span class="s1">_default = object()</span>
        <span class="s1">self.assertTrue(comp.queryUtility(ifoo</span><span class="s3">, </span><span class="s1">default=_default) </span><span class="s3">is </span><span class="s1">_default)</span>

    <span class="s3">def </span><span class="s1">test_queryUtility_hit(self):</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">InterfaceClass</span>
        <span class="s3">class </span><span class="s1">IFoo(InterfaceClass):</span>
            <span class="s3">pass</span>
        <span class="s1">ifoo = IFoo(</span><span class="s4">'IFoo'</span><span class="s1">)</span>
        <span class="s1">_to_reg = object()</span>
        <span class="s1">comp = self._makeOne()</span>
        <span class="s1">comp.registerUtility(_to_reg</span><span class="s3">, </span><span class="s1">ifoo)</span>
        <span class="s1">self.assertTrue(comp.queryUtility(ifoo) </span><span class="s3">is </span><span class="s1">_to_reg)</span>

    <span class="s3">def </span><span class="s1">test_getUtility_miss(self):</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">InterfaceClass</span>
        <span class="s3">from </span><span class="s1">zope.interface.interfaces </span><span class="s3">import </span><span class="s1">ComponentLookupError</span>
        <span class="s3">class </span><span class="s1">IFoo(InterfaceClass):</span>
            <span class="s3">pass</span>
        <span class="s1">ifoo = IFoo(</span><span class="s4">'IFoo'</span><span class="s1">)</span>
        <span class="s1">comp = self._makeOne()</span>
        <span class="s1">self.assertRaises(ComponentLookupError</span><span class="s3">, </span><span class="s1">comp.getUtility</span><span class="s3">, </span><span class="s1">ifoo)</span>

    <span class="s3">def </span><span class="s1">test_getUtility_hit(self):</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">InterfaceClass</span>
        <span class="s3">class </span><span class="s1">IFoo(InterfaceClass):</span>
            <span class="s3">pass</span>
        <span class="s1">ifoo = IFoo(</span><span class="s4">'IFoo'</span><span class="s1">)</span>
        <span class="s1">_to_reg = object()</span>
        <span class="s1">comp = self._makeOne()</span>
        <span class="s1">comp.registerUtility(_to_reg</span><span class="s3">, </span><span class="s1">ifoo)</span>
        <span class="s1">self.assertTrue(comp.getUtility(ifoo) </span><span class="s3">is </span><span class="s1">_to_reg)</span>

    <span class="s3">def </span><span class="s1">test_getUtilitiesFor_miss(self):</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">InterfaceClass</span>
        <span class="s3">class </span><span class="s1">IFoo(InterfaceClass):</span>
            <span class="s3">pass</span>
        <span class="s1">ifoo = IFoo(</span><span class="s4">'IFoo'</span><span class="s1">)</span>
        <span class="s1">comp = self._makeOne()</span>
        <span class="s1">self.assertEqual(list(comp.getUtilitiesFor(ifoo))</span><span class="s3">, </span><span class="s1">[])</span>

    <span class="s3">def </span><span class="s1">test_getUtilitiesFor_hit(self):</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">InterfaceClass</span>

        <span class="s3">class </span><span class="s1">IFoo(InterfaceClass):</span>
            <span class="s3">pass</span>
        <span class="s1">ifoo = IFoo(</span><span class="s4">'IFoo'</span><span class="s1">)</span>
        <span class="s1">_name1 = </span><span class="s4">u'name1'</span>
        <span class="s1">_name2 = </span><span class="s4">u'name2'</span>
        <span class="s1">_to_reg = object()</span>
        <span class="s1">comp = self._makeOne()</span>
        <span class="s1">comp.registerUtility(_to_reg</span><span class="s3">, </span><span class="s1">ifoo</span><span class="s3">, </span><span class="s1">name=_name1)</span>
        <span class="s1">comp.registerUtility(_to_reg</span><span class="s3">, </span><span class="s1">ifoo</span><span class="s3">, </span><span class="s1">name=_name2)</span>
        <span class="s1">self.assertEqual(sorted(comp.getUtilitiesFor(ifoo))</span><span class="s3">,</span>
                         <span class="s1">[(_name1</span><span class="s3">, </span><span class="s1">_to_reg)</span><span class="s3">, </span><span class="s1">(_name2</span><span class="s3">, </span><span class="s1">_to_reg)])</span>

    <span class="s3">def </span><span class="s1">test_getAllUtilitiesRegisteredFor_miss(self):</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">InterfaceClass</span>
        <span class="s3">class </span><span class="s1">IFoo(InterfaceClass):</span>
            <span class="s3">pass</span>
        <span class="s1">ifoo = IFoo(</span><span class="s4">'IFoo'</span><span class="s1">)</span>
        <span class="s1">comp = self._makeOne()</span>
        <span class="s1">self.assertEqual(list(comp.getAllUtilitiesRegisteredFor(ifoo))</span><span class="s3">, </span><span class="s1">[])</span>

    <span class="s3">def </span><span class="s1">test_getAllUtilitiesRegisteredFor_hit(self):</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">InterfaceClass</span>

        <span class="s3">class </span><span class="s1">IFoo(InterfaceClass):</span>
            <span class="s3">pass</span>
        <span class="s1">ifoo = IFoo(</span><span class="s4">'IFoo'</span><span class="s1">)</span>
        <span class="s1">_name1 = </span><span class="s4">u'name1'</span>
        <span class="s1">_name2 = </span><span class="s4">u'name2'</span>
        <span class="s1">_to_reg = object()</span>
        <span class="s1">comp = self._makeOne()</span>
        <span class="s1">comp.registerUtility(_to_reg</span><span class="s3">, </span><span class="s1">ifoo</span><span class="s3">, </span><span class="s1">name=_name1)</span>
        <span class="s1">comp.registerUtility(_to_reg</span><span class="s3">, </span><span class="s1">ifoo</span><span class="s3">, </span><span class="s1">name=_name2)</span>
        <span class="s1">self.assertEqual(list(comp.getAllUtilitiesRegisteredFor(ifoo))</span><span class="s3">,</span>
                         <span class="s1">[_to_reg])</span>

    <span class="s3">def </span><span class="s1">test_registerAdapter_with_component_name(self):</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">named</span><span class="s3">, </span><span class="s1">InterfaceClass</span>


        <span class="s3">class </span><span class="s1">IFoo(InterfaceClass):</span>
            <span class="s3">pass</span>
        <span class="s1">ifoo = IFoo(</span><span class="s4">'IFoo'</span><span class="s1">)</span>
        <span class="s1">ibar = IFoo(</span><span class="s4">'IBar'</span><span class="s1">)</span>

        <span class="s1">@named(</span><span class="s4">u'foo'</span><span class="s1">)</span>
        <span class="s3">class </span><span class="s1">Foo(object):</span>
            <span class="s3">pass</span>
        <span class="s1">_info = </span><span class="s4">u'info'</span>

        <span class="s1">comp = self._makeOne()</span>
        <span class="s1">comp.registerAdapter(Foo</span><span class="s3">, </span><span class="s1">(ibar</span><span class="s3">,</span><span class="s1">)</span><span class="s3">, </span><span class="s1">ifoo</span><span class="s3">, </span><span class="s1">info=_info)</span>

        <span class="s1">self.assertEqual(</span>
            <span class="s1">comp._adapter_registrations[(ibar</span><span class="s3">,</span><span class="s1">)</span><span class="s3">, </span><span class="s1">ifoo</span><span class="s3">, </span><span class="s4">u'foo'</span><span class="s1">]</span><span class="s3">,</span>
            <span class="s1">(Foo</span><span class="s3">, </span><span class="s1">_info))</span>

    <span class="s3">def </span><span class="s1">test_registerAdapter_w_explicit_provided_and_required(self):</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">InterfaceClass</span>
        <span class="s3">from </span><span class="s1">zope.interface.interfaces </span><span class="s3">import </span><span class="s1">Registered</span>
        <span class="s3">from </span><span class="s1">zope.interface.registry </span><span class="s3">import </span><span class="s1">AdapterRegistration</span>

        <span class="s3">class </span><span class="s1">IFoo(InterfaceClass):</span>
            <span class="s3">pass</span>
        <span class="s1">ifoo = IFoo(</span><span class="s4">'IFoo'</span><span class="s1">)</span>
        <span class="s1">ibar = IFoo(</span><span class="s4">'IBar'</span><span class="s1">)</span>
        <span class="s1">_info = </span><span class="s4">u'info'</span>
        <span class="s1">_name = </span><span class="s4">u'name'</span>

        <span class="s3">def </span><span class="s1">_factory(context):</span>
            <span class="s3">raise </span><span class="s1">NotImplementedError()</span>
        <span class="s1">comp = self._makeOne()</span>
        <span class="s1">_monkey</span><span class="s3">, </span><span class="s1">_events = self._wrapEvents()</span>
        <span class="s3">with </span><span class="s1">_monkey:</span>
            <span class="s1">comp.registerAdapter(_factory</span><span class="s3">, </span><span class="s1">(ibar</span><span class="s3">,</span><span class="s1">)</span><span class="s3">, </span><span class="s1">ifoo</span><span class="s3">, </span><span class="s1">_name</span><span class="s3">, </span><span class="s1">_info)</span>
        <span class="s1">self.assertTrue(comp.adapters._adapters[</span><span class="s5">1</span><span class="s1">][ibar][ifoo][_name]</span>
                        <span class="s3">is </span><span class="s1">_factory)</span>
        <span class="s1">self.assertEqual(comp._adapter_registrations[(ibar</span><span class="s3">,</span><span class="s1">)</span><span class="s3">, </span><span class="s1">ifoo</span><span class="s3">, </span><span class="s1">_name]</span><span class="s3">,</span>
                         <span class="s1">(_factory</span><span class="s3">, </span><span class="s1">_info))</span>
        <span class="s1">self.assertEqual(len(_events)</span><span class="s3">, </span><span class="s5">1</span><span class="s1">)</span>
        <span class="s1">args</span><span class="s3">, </span><span class="s1">kw = _events[</span><span class="s5">0</span><span class="s1">]</span>
        <span class="s1">event</span><span class="s3">, </span><span class="s1">= args</span>
        <span class="s1">self.assertEqual(kw</span><span class="s3">, </span><span class="s1">{})</span>
        <span class="s1">self.assertTrue(isinstance(event</span><span class="s3">, </span><span class="s1">Registered))</span>
        <span class="s1">self.assertTrue(isinstance(event.object</span><span class="s3">, </span><span class="s1">AdapterRegistration))</span>
        <span class="s1">self.assertTrue(event.object.registry </span><span class="s3">is </span><span class="s1">comp)</span>
        <span class="s1">self.assertTrue(event.object.provided </span><span class="s3">is </span><span class="s1">ifoo)</span>
        <span class="s1">self.assertEqual(event.object.required</span><span class="s3">, </span><span class="s1">(ibar</span><span class="s3">,</span><span class="s1">))</span>
        <span class="s1">self.assertTrue(event.object.name </span><span class="s3">is </span><span class="s1">_name)</span>
        <span class="s1">self.assertTrue(event.object.info </span><span class="s3">is </span><span class="s1">_info)</span>
        <span class="s1">self.assertTrue(event.object.factory </span><span class="s3">is </span><span class="s1">_factory)</span>

    <span class="s3">def </span><span class="s1">test_registerAdapter_no_provided_available(self):</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">InterfaceClass</span>

        <span class="s3">class </span><span class="s1">IFoo(InterfaceClass):</span>
            <span class="s3">pass</span>

        <span class="s1">ibar = IFoo(</span><span class="s4">'IBar'</span><span class="s1">)</span>
        <span class="s1">_info = </span><span class="s4">u'info'</span>
        <span class="s1">_name = </span><span class="s4">u'name'</span>

        <span class="s3">class </span><span class="s1">_Factory(object):</span>
            <span class="s3">pass</span>

        <span class="s1">comp = self._makeOne()</span>
        <span class="s1">self.assertRaises(TypeError</span><span class="s3">, </span><span class="s1">comp.registerAdapter</span><span class="s3">, </span><span class="s1">_Factory</span><span class="s3">, </span><span class="s1">(ibar</span><span class="s3">,</span><span class="s1">)</span><span class="s3">,</span>
                          <span class="s1">name=_name</span><span class="s3">, </span><span class="s1">info=_info)</span>

    <span class="s3">def </span><span class="s1">test_registerAdapter_wo_explicit_provided(self):</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">InterfaceClass</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">implementer</span>
        <span class="s3">from </span><span class="s1">zope.interface.interfaces </span><span class="s3">import </span><span class="s1">Registered</span>
        <span class="s3">from </span><span class="s1">zope.interface.registry </span><span class="s3">import </span><span class="s1">AdapterRegistration</span>

        <span class="s3">class </span><span class="s1">IFoo(InterfaceClass):</span>
            <span class="s3">pass</span>
        <span class="s1">ifoo = IFoo(</span><span class="s4">'IFoo'</span><span class="s1">)</span>
        <span class="s1">ibar = IFoo(</span><span class="s4">'IBar'</span><span class="s1">)</span>
        <span class="s1">_info = </span><span class="s4">u'info'</span>
        <span class="s1">_name = </span><span class="s4">u'name'</span>
        <span class="s1">_to_reg = object()</span>

        <span class="s1">@implementer(ifoo)</span>
        <span class="s3">class </span><span class="s1">_Factory(object):</span>
            <span class="s3">pass</span>

        <span class="s1">comp = self._makeOne()</span>
        <span class="s1">_monkey</span><span class="s3">, </span><span class="s1">_events = self._wrapEvents()</span>
        <span class="s3">with </span><span class="s1">_monkey:</span>
            <span class="s1">comp.registerAdapter(_Factory</span><span class="s3">, </span><span class="s1">(ibar</span><span class="s3">,</span><span class="s1">)</span><span class="s3">, </span><span class="s1">name=_name</span><span class="s3">, </span><span class="s1">info=_info)</span>
        <span class="s1">self.assertTrue(comp.adapters._adapters[</span><span class="s5">1</span><span class="s1">][ibar][ifoo][_name]</span>
                        <span class="s3">is </span><span class="s1">_Factory)</span>
        <span class="s1">self.assertEqual(comp._adapter_registrations[(ibar</span><span class="s3">,</span><span class="s1">)</span><span class="s3">, </span><span class="s1">ifoo</span><span class="s3">, </span><span class="s1">_name]</span><span class="s3">,</span>
                         <span class="s1">(_Factory</span><span class="s3">, </span><span class="s1">_info))</span>
        <span class="s1">self.assertEqual(len(_events)</span><span class="s3">, </span><span class="s5">1</span><span class="s1">)</span>
        <span class="s1">args</span><span class="s3">, </span><span class="s1">kw = _events[</span><span class="s5">0</span><span class="s1">]</span>
        <span class="s1">event</span><span class="s3">, </span><span class="s1">= args</span>
        <span class="s1">self.assertEqual(kw</span><span class="s3">, </span><span class="s1">{})</span>
        <span class="s1">self.assertTrue(isinstance(event</span><span class="s3">, </span><span class="s1">Registered))</span>
        <span class="s1">self.assertTrue(isinstance(event.object</span><span class="s3">, </span><span class="s1">AdapterRegistration))</span>
        <span class="s1">self.assertTrue(event.object.registry </span><span class="s3">is </span><span class="s1">comp)</span>
        <span class="s1">self.assertTrue(event.object.provided </span><span class="s3">is </span><span class="s1">ifoo)</span>
        <span class="s1">self.assertEqual(event.object.required</span><span class="s3">, </span><span class="s1">(ibar</span><span class="s3">,</span><span class="s1">))</span>
        <span class="s1">self.assertTrue(event.object.name </span><span class="s3">is </span><span class="s1">_name)</span>
        <span class="s1">self.assertTrue(event.object.info </span><span class="s3">is </span><span class="s1">_info)</span>
        <span class="s1">self.assertTrue(event.object.factory </span><span class="s3">is </span><span class="s1">_Factory)</span>

    <span class="s3">def </span><span class="s1">test_registerAdapter_no_required_available(self):</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">InterfaceClass</span>

        <span class="s3">class </span><span class="s1">IFoo(InterfaceClass):</span>
            <span class="s3">pass</span>
        <span class="s1">ifoo = IFoo(</span><span class="s4">'IFoo'</span><span class="s1">)</span>

        <span class="s1">_info = </span><span class="s4">u'info'</span>
        <span class="s1">_name = </span><span class="s4">u'name'</span>
        <span class="s3">class </span><span class="s1">_Factory(object):</span>
           <span class="s3">pass</span>

        <span class="s1">comp = self._makeOne()</span>
        <span class="s1">self.assertRaises(TypeError</span><span class="s3">, </span><span class="s1">comp.registerAdapter</span><span class="s3">, </span><span class="s1">_Factory</span><span class="s3">,</span>
                          <span class="s1">provided=ifoo</span><span class="s3">, </span><span class="s1">name=_name</span><span class="s3">, </span><span class="s1">info=_info)</span>

    <span class="s3">def </span><span class="s1">test_registerAdapter_w_invalid_required(self):</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">InterfaceClass</span>

        <span class="s3">class </span><span class="s1">IFoo(InterfaceClass):</span>
            <span class="s3">pass</span>
        <span class="s1">ifoo = IFoo(</span><span class="s4">'IFoo'</span><span class="s1">)</span>
        <span class="s1">ibar = IFoo(</span><span class="s4">'IBar'</span><span class="s1">)</span>
        <span class="s1">_info = </span><span class="s4">u'info'</span>
        <span class="s1">_name = </span><span class="s4">u'name'</span>
        <span class="s3">class </span><span class="s1">_Factory(object):</span>
            <span class="s3">pass</span>
        <span class="s1">comp = self._makeOne()</span>
        <span class="s1">self.assertRaises(TypeError</span><span class="s3">, </span><span class="s1">comp.registerAdapter</span><span class="s3">, </span><span class="s1">_Factory</span><span class="s3">,</span>
                          <span class="s1">ibar</span><span class="s3">, </span><span class="s1">provided=ifoo</span><span class="s3">, </span><span class="s1">name=_name</span><span class="s3">, </span><span class="s1">info=_info)</span>

    <span class="s3">def </span><span class="s1">test_registerAdapter_w_required_containing_None(self):</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">InterfaceClass</span>
        <span class="s3">from </span><span class="s1">zope.interface.interface </span><span class="s3">import </span><span class="s1">Interface</span>
        <span class="s3">from </span><span class="s1">zope.interface.interfaces </span><span class="s3">import </span><span class="s1">Registered</span>
        <span class="s3">from </span><span class="s1">zope.interface.registry </span><span class="s3">import </span><span class="s1">AdapterRegistration</span>

        <span class="s3">class </span><span class="s1">IFoo(InterfaceClass):</span>
            <span class="s3">pass</span>
        <span class="s1">ifoo = IFoo(</span><span class="s4">'IFoo'</span><span class="s1">)</span>
        <span class="s1">_info = </span><span class="s4">u'info'</span>
        <span class="s1">_name = </span><span class="s4">u'name'</span>
        <span class="s3">class </span><span class="s1">_Factory(object):</span>
            <span class="s3">pass</span>
        <span class="s1">comp = self._makeOne()</span>
        <span class="s1">_monkey</span><span class="s3">, </span><span class="s1">_events = self._wrapEvents()</span>
        <span class="s3">with </span><span class="s1">_monkey:</span>
            <span class="s1">comp.registerAdapter(_Factory</span><span class="s3">, </span><span class="s1">[</span><span class="s3">None</span><span class="s1">]</span><span class="s3">, </span><span class="s1">provided=ifoo</span><span class="s3">,</span>
                                 <span class="s1">name=_name</span><span class="s3">, </span><span class="s1">info=_info)</span>
        <span class="s1">self.assertTrue(comp.adapters._adapters[</span><span class="s5">1</span><span class="s1">][Interface][ifoo][_name]</span>
                        <span class="s3">is </span><span class="s1">_Factory)</span>
        <span class="s1">self.assertEqual(comp._adapter_registrations[(Interface</span><span class="s3">,</span><span class="s1">)</span><span class="s3">, </span><span class="s1">ifoo</span><span class="s3">, </span><span class="s1">_name]</span><span class="s3">,</span>
                         <span class="s1">(_Factory</span><span class="s3">, </span><span class="s1">_info))</span>
        <span class="s1">self.assertEqual(len(_events)</span><span class="s3">, </span><span class="s5">1</span><span class="s1">)</span>
        <span class="s1">args</span><span class="s3">, </span><span class="s1">kw = _events[</span><span class="s5">0</span><span class="s1">]</span>
        <span class="s1">event</span><span class="s3">, </span><span class="s1">= args</span>
        <span class="s1">self.assertEqual(kw</span><span class="s3">, </span><span class="s1">{})</span>
        <span class="s1">self.assertTrue(isinstance(event</span><span class="s3">, </span><span class="s1">Registered))</span>
        <span class="s1">self.assertTrue(isinstance(event.object</span><span class="s3">, </span><span class="s1">AdapterRegistration))</span>
        <span class="s1">self.assertTrue(event.object.registry </span><span class="s3">is </span><span class="s1">comp)</span>
        <span class="s1">self.assertTrue(event.object.provided </span><span class="s3">is </span><span class="s1">ifoo)</span>
        <span class="s1">self.assertEqual(event.object.required</span><span class="s3">, </span><span class="s1">(Interface</span><span class="s3">,</span><span class="s1">))</span>
        <span class="s1">self.assertTrue(event.object.name </span><span class="s3">is </span><span class="s1">_name)</span>
        <span class="s1">self.assertTrue(event.object.info </span><span class="s3">is </span><span class="s1">_info)</span>
        <span class="s1">self.assertTrue(event.object.factory </span><span class="s3">is </span><span class="s1">_Factory)</span>

    <span class="s3">def </span><span class="s1">test_registerAdapter_w_required_containing_class(self):</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">InterfaceClass</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">implementer</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">implementedBy</span>
        <span class="s3">from </span><span class="s1">zope.interface.interfaces </span><span class="s3">import </span><span class="s1">Registered</span>
        <span class="s3">from </span><span class="s1">zope.interface.registry </span><span class="s3">import </span><span class="s1">AdapterRegistration</span>

        <span class="s3">class </span><span class="s1">IFoo(InterfaceClass):</span>
            <span class="s3">pass</span>
        <span class="s1">ifoo = IFoo(</span><span class="s4">'IFoo'</span><span class="s1">)</span>
        <span class="s1">ibar = IFoo(</span><span class="s4">'IBar'</span><span class="s1">)</span>
        <span class="s1">_info = </span><span class="s4">u'info'</span>
        <span class="s1">_name = </span><span class="s4">u'name'</span>
        <span class="s3">class </span><span class="s1">_Factory(object):</span>
            <span class="s3">pass</span>

        <span class="s1">@implementer(ibar)</span>
        <span class="s3">class </span><span class="s1">_Context(object):</span>
            <span class="s3">pass</span>
        <span class="s1">_ctx_impl = implementedBy(_Context)</span>
        <span class="s1">comp = self._makeOne()</span>
        <span class="s1">_monkey</span><span class="s3">, </span><span class="s1">_events = self._wrapEvents()</span>
        <span class="s3">with </span><span class="s1">_monkey:</span>
            <span class="s1">comp.registerAdapter(_Factory</span><span class="s3">, </span><span class="s1">[_Context]</span><span class="s3">, </span><span class="s1">provided=ifoo</span><span class="s3">,</span>
                                 <span class="s1">name=_name</span><span class="s3">, </span><span class="s1">info=_info)</span>
        <span class="s1">self.assertTrue(comp.adapters._adapters[</span><span class="s5">1</span><span class="s1">][_ctx_impl][ifoo][_name]</span>
                        <span class="s3">is </span><span class="s1">_Factory)</span>
        <span class="s1">self.assertEqual(comp._adapter_registrations[(_ctx_impl</span><span class="s3">,</span><span class="s1">)</span><span class="s3">, </span><span class="s1">ifoo</span><span class="s3">, </span><span class="s1">_name]</span><span class="s3">,</span>
                         <span class="s1">(_Factory</span><span class="s3">, </span><span class="s1">_info))</span>
        <span class="s1">self.assertEqual(len(_events)</span><span class="s3">, </span><span class="s5">1</span><span class="s1">)</span>
        <span class="s1">args</span><span class="s3">, </span><span class="s1">kw = _events[</span><span class="s5">0</span><span class="s1">]</span>
        <span class="s1">event</span><span class="s3">, </span><span class="s1">= args</span>
        <span class="s1">self.assertEqual(kw</span><span class="s3">, </span><span class="s1">{})</span>
        <span class="s1">self.assertTrue(isinstance(event</span><span class="s3">, </span><span class="s1">Registered))</span>
        <span class="s1">self.assertTrue(isinstance(event.object</span><span class="s3">, </span><span class="s1">AdapterRegistration))</span>
        <span class="s1">self.assertTrue(event.object.registry </span><span class="s3">is </span><span class="s1">comp)</span>
        <span class="s1">self.assertTrue(event.object.provided </span><span class="s3">is </span><span class="s1">ifoo)</span>
        <span class="s1">self.assertEqual(event.object.required</span><span class="s3">, </span><span class="s1">(_ctx_impl</span><span class="s3">,</span><span class="s1">))</span>
        <span class="s1">self.assertTrue(event.object.name </span><span class="s3">is </span><span class="s1">_name)</span>
        <span class="s1">self.assertTrue(event.object.info </span><span class="s3">is </span><span class="s1">_info)</span>
        <span class="s1">self.assertTrue(event.object.factory </span><span class="s3">is </span><span class="s1">_Factory)</span>

    <span class="s3">def </span><span class="s1">test_registerAdapter_w_required_containing_junk(self):</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">InterfaceClass</span>

        <span class="s3">class </span><span class="s1">IFoo(InterfaceClass):</span>
            <span class="s3">pass</span>
        <span class="s1">ifoo = IFoo(</span><span class="s4">'IFoo'</span><span class="s1">)</span>

        <span class="s1">_info = </span><span class="s4">u'info'</span>
        <span class="s1">_name = </span><span class="s4">u'name'</span>
        <span class="s3">class </span><span class="s1">_Factory(object):</span>
            <span class="s3">pass</span>
        <span class="s1">comp = self._makeOne()</span>
        <span class="s1">self.assertRaises(TypeError</span><span class="s3">, </span><span class="s1">comp.registerAdapter</span><span class="s3">, </span><span class="s1">_Factory</span><span class="s3">, </span><span class="s1">[object()]</span><span class="s3">,</span>
                          <span class="s1">provided=ifoo</span><span class="s3">, </span><span class="s1">name=_name</span><span class="s3">, </span><span class="s1">info=_info)</span>

    <span class="s3">def </span><span class="s1">test_registerAdapter_wo_explicit_required(self):</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">InterfaceClass</span>
        <span class="s3">from </span><span class="s1">zope.interface.interfaces </span><span class="s3">import </span><span class="s1">Registered</span>
        <span class="s3">from </span><span class="s1">zope.interface.registry </span><span class="s3">import </span><span class="s1">AdapterRegistration</span>

        <span class="s3">class </span><span class="s1">IFoo(InterfaceClass):</span>
            <span class="s3">pass</span>
        <span class="s1">ifoo = IFoo(</span><span class="s4">'IFoo'</span><span class="s1">)</span>
        <span class="s1">ibar = IFoo(</span><span class="s4">'IBar'</span><span class="s1">)</span>
        <span class="s1">_info = </span><span class="s4">u'info'</span>
        <span class="s1">_name = </span><span class="s4">u'name'</span>
        <span class="s3">class </span><span class="s1">_Factory(object):</span>
            <span class="s1">__component_adapts__ = (ibar</span><span class="s3">,</span><span class="s1">)</span>

        <span class="s1">comp = self._makeOne()</span>
        <span class="s1">_monkey</span><span class="s3">, </span><span class="s1">_events = self._wrapEvents()</span>
        <span class="s3">with </span><span class="s1">_monkey:</span>
            <span class="s1">comp.registerAdapter(_Factory</span><span class="s3">, </span><span class="s1">provided=ifoo</span><span class="s3">, </span><span class="s1">name=_name</span><span class="s3">,</span>
                                 <span class="s1">info=_info)</span>
        <span class="s1">self.assertTrue(comp.adapters._adapters[</span><span class="s5">1</span><span class="s1">][ibar][ifoo][_name]</span>
                        <span class="s3">is </span><span class="s1">_Factory)</span>
        <span class="s1">self.assertEqual(comp._adapter_registrations[(ibar</span><span class="s3">,</span><span class="s1">)</span><span class="s3">, </span><span class="s1">ifoo</span><span class="s3">, </span><span class="s1">_name]</span><span class="s3">,</span>
                         <span class="s1">(_Factory</span><span class="s3">, </span><span class="s1">_info))</span>
        <span class="s1">self.assertEqual(len(_events)</span><span class="s3">, </span><span class="s5">1</span><span class="s1">)</span>
        <span class="s1">args</span><span class="s3">, </span><span class="s1">kw = _events[</span><span class="s5">0</span><span class="s1">]</span>
        <span class="s1">event</span><span class="s3">, </span><span class="s1">= args</span>
        <span class="s1">self.assertEqual(kw</span><span class="s3">, </span><span class="s1">{})</span>
        <span class="s1">self.assertTrue(isinstance(event</span><span class="s3">, </span><span class="s1">Registered))</span>
        <span class="s1">self.assertTrue(isinstance(event.object</span><span class="s3">, </span><span class="s1">AdapterRegistration))</span>
        <span class="s1">self.assertTrue(event.object.registry </span><span class="s3">is </span><span class="s1">comp)</span>
        <span class="s1">self.assertTrue(event.object.provided </span><span class="s3">is </span><span class="s1">ifoo)</span>
        <span class="s1">self.assertEqual(event.object.required</span><span class="s3">, </span><span class="s1">(ibar</span><span class="s3">,</span><span class="s1">))</span>
        <span class="s1">self.assertTrue(event.object.name </span><span class="s3">is </span><span class="s1">_name)</span>
        <span class="s1">self.assertTrue(event.object.info </span><span class="s3">is </span><span class="s1">_info)</span>
        <span class="s1">self.assertTrue(event.object.factory </span><span class="s3">is </span><span class="s1">_Factory)</span>

    <span class="s3">def </span><span class="s1">test_registerAdapter_wo_event(self):</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">InterfaceClass</span>

        <span class="s3">class </span><span class="s1">IFoo(InterfaceClass):</span>
            <span class="s3">pass</span>
        <span class="s1">ifoo = IFoo(</span><span class="s4">'IFoo'</span><span class="s1">)</span>
        <span class="s1">ibar = IFoo(</span><span class="s4">'IBar'</span><span class="s1">)</span>
        <span class="s1">_info = </span><span class="s4">u'info'</span>
        <span class="s1">_name = </span><span class="s4">u'name'</span>

        <span class="s3">def </span><span class="s1">_factory(context):</span>
            <span class="s3">raise </span><span class="s1">NotImplementedError()</span>
        <span class="s1">comp = self._makeOne()</span>
        <span class="s1">_monkey</span><span class="s3">, </span><span class="s1">_events = self._wrapEvents()</span>
        <span class="s3">with </span><span class="s1">_monkey:</span>
            <span class="s1">comp.registerAdapter(_factory</span><span class="s3">, </span><span class="s1">(ibar</span><span class="s3">,</span><span class="s1">)</span><span class="s3">, </span><span class="s1">ifoo</span><span class="s3">, </span><span class="s1">_name</span><span class="s3">, </span><span class="s1">_info</span><span class="s3">,</span>
                                 <span class="s1">event=</span><span class="s3">False</span><span class="s1">)</span>
        <span class="s1">self.assertEqual(len(_events)</span><span class="s3">, </span><span class="s5">0</span><span class="s1">)</span>

    <span class="s3">def </span><span class="s1">test_unregisterAdapter_neither_factory_nor_provided(self):</span>
        <span class="s1">comp = self._makeOne()</span>
        <span class="s1">self.assertRaises(TypeError</span><span class="s3">, </span><span class="s1">comp.unregisterAdapter</span><span class="s3">,</span>
                          <span class="s1">factory=</span><span class="s3">None, </span><span class="s1">provided=</span><span class="s3">None</span><span class="s1">)</span>

    <span class="s3">def </span><span class="s1">test_unregisterAdapter_neither_factory_nor_required(self):</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">InterfaceClass</span>
        <span class="s3">class </span><span class="s1">IFoo(InterfaceClass):</span>
            <span class="s3">pass</span>
        <span class="s1">ifoo = IFoo(</span><span class="s4">'IFoo'</span><span class="s1">)</span>
        <span class="s1">comp = self._makeOne()</span>
        <span class="s1">self.assertRaises(TypeError</span><span class="s3">, </span><span class="s1">comp.unregisterAdapter</span><span class="s3">,</span>
                          <span class="s1">factory=</span><span class="s3">None, </span><span class="s1">provided=ifoo</span><span class="s3">, </span><span class="s1">required=</span><span class="s3">None</span><span class="s1">)</span>

    <span class="s3">def </span><span class="s1">test_unregisterAdapter_miss(self):</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">InterfaceClass</span>
        <span class="s3">class </span><span class="s1">IFoo(InterfaceClass):</span>
            <span class="s3">pass</span>
        <span class="s1">ifoo = IFoo(</span><span class="s4">'IFoo'</span><span class="s1">)</span>
        <span class="s1">ibar = IFoo(</span><span class="s4">'IBar'</span><span class="s1">)</span>
        <span class="s3">class </span><span class="s1">_Factory(object):</span>
            <span class="s3">pass</span>

        <span class="s1">comp = self._makeOne()</span>
        <span class="s1">_monkey</span><span class="s3">, </span><span class="s1">_events = self._wrapEvents()</span>
        <span class="s3">with </span><span class="s1">_monkey:</span>
            <span class="s1">unreg = comp.unregisterAdapter(_Factory</span><span class="s3">, </span><span class="s1">(ibar</span><span class="s3">,</span><span class="s1">)</span><span class="s3">, </span><span class="s1">ifoo)</span>
        <span class="s1">self.assertFalse(unreg)</span>

    <span class="s3">def </span><span class="s1">test_unregisterAdapter_hit_w_explicit_provided_and_required(self):</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">InterfaceClass</span>
        <span class="s3">from </span><span class="s1">zope.interface.interfaces </span><span class="s3">import </span><span class="s1">Unregistered</span>
        <span class="s3">from </span><span class="s1">zope.interface.registry </span><span class="s3">import </span><span class="s1">AdapterRegistration</span>
        <span class="s3">class </span><span class="s1">IFoo(InterfaceClass):</span>
            <span class="s3">pass</span>
        <span class="s1">ifoo = IFoo(</span><span class="s4">'IFoo'</span><span class="s1">)</span>
        <span class="s1">ibar = IFoo(</span><span class="s4">'IBar'</span><span class="s1">)</span>
        <span class="s3">class </span><span class="s1">_Factory(object):</span>
            <span class="s3">pass</span>

        <span class="s1">comp = self._makeOne()</span>
        <span class="s1">comp.registerAdapter(_Factory</span><span class="s3">, </span><span class="s1">(ibar</span><span class="s3">,</span><span class="s1">)</span><span class="s3">, </span><span class="s1">ifoo)</span>
        <span class="s1">_monkey</span><span class="s3">, </span><span class="s1">_events = self._wrapEvents()</span>
        <span class="s3">with </span><span class="s1">_monkey:</span>
            <span class="s1">unreg = comp.unregisterAdapter(_Factory</span><span class="s3">, </span><span class="s1">(ibar</span><span class="s3">,</span><span class="s1">)</span><span class="s3">, </span><span class="s1">ifoo)</span>
        <span class="s1">self.assertTrue(unreg)</span>
        <span class="s1">self.assertFalse(comp.adapters._adapters)</span>
        <span class="s1">self.assertFalse(comp._adapter_registrations)</span>
        <span class="s1">self.assertEqual(len(_events)</span><span class="s3">, </span><span class="s5">1</span><span class="s1">)</span>
        <span class="s1">args</span><span class="s3">, </span><span class="s1">kw = _events[</span><span class="s5">0</span><span class="s1">]</span>
        <span class="s1">event</span><span class="s3">, </span><span class="s1">= args</span>
        <span class="s1">self.assertEqual(kw</span><span class="s3">, </span><span class="s1">{})</span>
        <span class="s1">self.assertTrue(isinstance(event</span><span class="s3">, </span><span class="s1">Unregistered))</span>
        <span class="s1">self.assertTrue(isinstance(event.object</span><span class="s3">, </span><span class="s1">AdapterRegistration))</span>
        <span class="s1">self.assertTrue(event.object.registry </span><span class="s3">is </span><span class="s1">comp)</span>
        <span class="s1">self.assertTrue(event.object.provided </span><span class="s3">is </span><span class="s1">ifoo)</span>
        <span class="s1">self.assertEqual(event.object.required</span><span class="s3">, </span><span class="s1">(ibar</span><span class="s3">,</span><span class="s1">))</span>
        <span class="s1">self.assertEqual(event.object.name</span><span class="s3">, </span><span class="s4">''</span><span class="s1">)</span>
        <span class="s1">self.assertEqual(event.object.info</span><span class="s3">, </span><span class="s4">''</span><span class="s1">)</span>
        <span class="s1">self.assertTrue(event.object.factory </span><span class="s3">is </span><span class="s1">_Factory)</span>

    <span class="s3">def </span><span class="s1">test_unregisterAdapter_wo_explicit_provided(self):</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">InterfaceClass</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">implementer</span>
        <span class="s3">from </span><span class="s1">zope.interface.interfaces </span><span class="s3">import </span><span class="s1">Unregistered</span>
        <span class="s3">from </span><span class="s1">zope.interface.registry </span><span class="s3">import </span><span class="s1">AdapterRegistration</span>
        <span class="s3">class </span><span class="s1">IFoo(InterfaceClass):</span>
            <span class="s3">pass</span>
        <span class="s1">ifoo = IFoo(</span><span class="s4">'IFoo'</span><span class="s1">)</span>
        <span class="s1">ibar = IFoo(</span><span class="s4">'IBar'</span><span class="s1">)</span>
        <span class="s1">@implementer(ifoo)</span>
        <span class="s3">class </span><span class="s1">_Factory(object):</span>
            <span class="s3">pass</span>

        <span class="s1">comp = self._makeOne()</span>
        <span class="s1">comp.registerAdapter(_Factory</span><span class="s3">, </span><span class="s1">(ibar</span><span class="s3">,</span><span class="s1">)</span><span class="s3">, </span><span class="s1">ifoo)</span>
        <span class="s1">_monkey</span><span class="s3">, </span><span class="s1">_events = self._wrapEvents()</span>
        <span class="s3">with </span><span class="s1">_monkey:</span>
            <span class="s1">unreg = comp.unregisterAdapter(_Factory</span><span class="s3">, </span><span class="s1">(ibar</span><span class="s3">,</span><span class="s1">))</span>
        <span class="s1">self.assertTrue(unreg)</span>
        <span class="s1">self.assertEqual(len(_events)</span><span class="s3">, </span><span class="s5">1</span><span class="s1">)</span>
        <span class="s1">args</span><span class="s3">, </span><span class="s1">kw = _events[</span><span class="s5">0</span><span class="s1">]</span>
        <span class="s1">event</span><span class="s3">, </span><span class="s1">= args</span>
        <span class="s1">self.assertEqual(kw</span><span class="s3">, </span><span class="s1">{})</span>
        <span class="s1">self.assertTrue(isinstance(event</span><span class="s3">, </span><span class="s1">Unregistered))</span>
        <span class="s1">self.assertTrue(isinstance(event.object</span><span class="s3">, </span><span class="s1">AdapterRegistration))</span>
        <span class="s1">self.assertTrue(event.object.registry </span><span class="s3">is </span><span class="s1">comp)</span>
        <span class="s1">self.assertTrue(event.object.provided </span><span class="s3">is </span><span class="s1">ifoo)</span>
        <span class="s1">self.assertEqual(event.object.required</span><span class="s3">, </span><span class="s1">(ibar</span><span class="s3">,</span><span class="s1">))</span>
        <span class="s1">self.assertEqual(event.object.name</span><span class="s3">, </span><span class="s4">''</span><span class="s1">)</span>
        <span class="s1">self.assertEqual(event.object.info</span><span class="s3">, </span><span class="s4">''</span><span class="s1">)</span>
        <span class="s1">self.assertTrue(event.object.factory </span><span class="s3">is </span><span class="s1">_Factory)</span>

    <span class="s3">def </span><span class="s1">test_unregisterAdapter_wo_explicit_required(self):</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">InterfaceClass</span>
        <span class="s3">from </span><span class="s1">zope.interface.interfaces </span><span class="s3">import </span><span class="s1">Unregistered</span>
        <span class="s3">from </span><span class="s1">zope.interface.registry </span><span class="s3">import </span><span class="s1">AdapterRegistration</span>
        <span class="s3">class </span><span class="s1">IFoo(InterfaceClass):</span>
            <span class="s3">pass</span>
        <span class="s1">ifoo = IFoo(</span><span class="s4">'IFoo'</span><span class="s1">)</span>
        <span class="s1">ibar = IFoo(</span><span class="s4">'IBar'</span><span class="s1">)</span>
        <span class="s3">class </span><span class="s1">_Factory(object):</span>
            <span class="s1">__component_adapts__ = (ibar</span><span class="s3">,</span><span class="s1">)</span>

        <span class="s1">comp = self._makeOne()</span>
        <span class="s1">comp.registerAdapter(_Factory</span><span class="s3">, </span><span class="s1">(ibar</span><span class="s3">,</span><span class="s1">)</span><span class="s3">, </span><span class="s1">ifoo)</span>
        <span class="s1">_monkey</span><span class="s3">, </span><span class="s1">_events = self._wrapEvents()</span>
        <span class="s3">with </span><span class="s1">_monkey:</span>
            <span class="s1">unreg = comp.unregisterAdapter(_Factory</span><span class="s3">, </span><span class="s1">provided=ifoo)</span>
        <span class="s1">self.assertTrue(unreg)</span>
        <span class="s1">self.assertEqual(len(_events)</span><span class="s3">, </span><span class="s5">1</span><span class="s1">)</span>
        <span class="s1">args</span><span class="s3">, </span><span class="s1">kw = _events[</span><span class="s5">0</span><span class="s1">]</span>
        <span class="s1">event</span><span class="s3">, </span><span class="s1">= args</span>
        <span class="s1">self.assertEqual(kw</span><span class="s3">, </span><span class="s1">{})</span>
        <span class="s1">self.assertTrue(isinstance(event</span><span class="s3">, </span><span class="s1">Unregistered))</span>
        <span class="s1">self.assertTrue(isinstance(event.object</span><span class="s3">, </span><span class="s1">AdapterRegistration))</span>
        <span class="s1">self.assertTrue(event.object.registry </span><span class="s3">is </span><span class="s1">comp)</span>
        <span class="s1">self.assertTrue(event.object.provided </span><span class="s3">is </span><span class="s1">ifoo)</span>
        <span class="s1">self.assertEqual(event.object.required</span><span class="s3">, </span><span class="s1">(ibar</span><span class="s3">,</span><span class="s1">))</span>
        <span class="s1">self.assertEqual(event.object.name</span><span class="s3">, </span><span class="s4">''</span><span class="s1">)</span>
        <span class="s1">self.assertEqual(event.object.info</span><span class="s3">, </span><span class="s4">''</span><span class="s1">)</span>
        <span class="s1">self.assertTrue(event.object.factory </span><span class="s3">is </span><span class="s1">_Factory)</span>

    <span class="s3">def </span><span class="s1">test_registeredAdapters_empty(self):</span>
        <span class="s1">comp = self._makeOne()</span>
        <span class="s1">self.assertEqual(list(comp.registeredAdapters())</span><span class="s3">, </span><span class="s1">[])</span>

    <span class="s3">def </span><span class="s1">test_registeredAdapters_notempty(self):</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">InterfaceClass</span>

        <span class="s3">from </span><span class="s1">zope.interface.registry </span><span class="s3">import </span><span class="s1">AdapterRegistration</span>
        <span class="s3">class </span><span class="s1">IFoo(InterfaceClass):</span>
            <span class="s3">pass</span>
        <span class="s1">ifoo = IFoo(</span><span class="s4">'IFoo'</span><span class="s1">)</span>
        <span class="s1">ibar = IFoo(</span><span class="s4">'IFoo'</span><span class="s1">)</span>
        <span class="s1">_info = </span><span class="s4">u'info'</span>
        <span class="s1">_name1 = </span><span class="s4">u'name1'</span>
        <span class="s1">_name2 = </span><span class="s4">u'name2'</span>
        <span class="s3">class </span><span class="s1">_Factory(object):</span>
            <span class="s3">pass</span>

        <span class="s1">comp = self._makeOne()</span>
        <span class="s1">comp.registerAdapter(_Factory</span><span class="s3">, </span><span class="s1">(ibar</span><span class="s3">,</span><span class="s1">)</span><span class="s3">, </span><span class="s1">ifoo</span><span class="s3">, </span><span class="s1">_name1</span><span class="s3">, </span><span class="s1">_info)</span>
        <span class="s1">comp.registerAdapter(_Factory</span><span class="s3">, </span><span class="s1">(ibar</span><span class="s3">,</span><span class="s1">)</span><span class="s3">, </span><span class="s1">ifoo</span><span class="s3">, </span><span class="s1">_name2</span><span class="s3">, </span><span class="s1">_info)</span>
        <span class="s1">reg = sorted(comp.registeredAdapters()</span><span class="s3">, </span><span class="s1">key=</span><span class="s3">lambda </span><span class="s1">r: r.name)</span>
        <span class="s1">self.assertEqual(len(reg)</span><span class="s3">, </span><span class="s5">2</span><span class="s1">)</span>
        <span class="s1">self.assertTrue(isinstance(reg[</span><span class="s5">0</span><span class="s1">]</span><span class="s3">, </span><span class="s1">AdapterRegistration))</span>
        <span class="s1">self.assertTrue(reg[</span><span class="s5">0</span><span class="s1">].registry </span><span class="s3">is </span><span class="s1">comp)</span>
        <span class="s1">self.assertTrue(reg[</span><span class="s5">0</span><span class="s1">].provided </span><span class="s3">is </span><span class="s1">ifoo)</span>
        <span class="s1">self.assertEqual(reg[</span><span class="s5">0</span><span class="s1">].required</span><span class="s3">, </span><span class="s1">(ibar</span><span class="s3">,</span><span class="s1">))</span>
        <span class="s1">self.assertTrue(reg[</span><span class="s5">0</span><span class="s1">].name </span><span class="s3">is </span><span class="s1">_name1)</span>
        <span class="s1">self.assertTrue(reg[</span><span class="s5">0</span><span class="s1">].info </span><span class="s3">is </span><span class="s1">_info)</span>
        <span class="s1">self.assertTrue(reg[</span><span class="s5">0</span><span class="s1">].factory </span><span class="s3">is </span><span class="s1">_Factory)</span>
        <span class="s1">self.assertTrue(isinstance(reg[</span><span class="s5">1</span><span class="s1">]</span><span class="s3">, </span><span class="s1">AdapterRegistration))</span>
        <span class="s1">self.assertTrue(reg[</span><span class="s5">1</span><span class="s1">].registry </span><span class="s3">is </span><span class="s1">comp)</span>
        <span class="s1">self.assertTrue(reg[</span><span class="s5">1</span><span class="s1">].provided </span><span class="s3">is </span><span class="s1">ifoo)</span>
        <span class="s1">self.assertEqual(reg[</span><span class="s5">1</span><span class="s1">].required</span><span class="s3">, </span><span class="s1">(ibar</span><span class="s3">,</span><span class="s1">))</span>
        <span class="s1">self.assertTrue(reg[</span><span class="s5">1</span><span class="s1">].name </span><span class="s3">is </span><span class="s1">_name2)</span>
        <span class="s1">self.assertTrue(reg[</span><span class="s5">1</span><span class="s1">].info </span><span class="s3">is </span><span class="s1">_info)</span>
        <span class="s1">self.assertTrue(reg[</span><span class="s5">1</span><span class="s1">].factory </span><span class="s3">is </span><span class="s1">_Factory)</span>

    <span class="s3">def </span><span class="s1">test_queryAdapter_miss_no_default(self):</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">InterfaceClass</span>
        <span class="s3">class </span><span class="s1">IFoo(InterfaceClass):</span>
            <span class="s3">pass</span>
        <span class="s1">ifoo = IFoo(</span><span class="s4">'IFoo'</span><span class="s1">)</span>
        <span class="s1">comp = self._makeOne()</span>
        <span class="s1">_context = object()</span>
        <span class="s1">self.assertTrue(comp.queryAdapter(_context</span><span class="s3">, </span><span class="s1">ifoo) </span><span class="s3">is None</span><span class="s1">)</span>

    <span class="s3">def </span><span class="s1">test_queryAdapter_miss_w_default(self):</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">InterfaceClass</span>
        <span class="s3">class </span><span class="s1">IFoo(InterfaceClass):</span>
            <span class="s3">pass</span>
        <span class="s1">ifoo = IFoo(</span><span class="s4">'IFoo'</span><span class="s1">)</span>
        <span class="s1">comp = self._makeOne()</span>
        <span class="s1">_context = object()</span>
        <span class="s1">_default = object()</span>
        <span class="s1">self.assertTrue(</span>
            <span class="s1">comp.queryAdapter(_context</span><span class="s3">, </span><span class="s1">ifoo</span><span class="s3">, </span><span class="s1">default=_default) </span><span class="s3">is </span><span class="s1">_default)</span>

    <span class="s3">def </span><span class="s1">test_queryAdapter_hit(self):</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">InterfaceClass</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">implementer</span>
        <span class="s3">class </span><span class="s1">IFoo(InterfaceClass):</span>
            <span class="s3">pass</span>
        <span class="s1">ifoo = IFoo(</span><span class="s4">'IFoo'</span><span class="s1">)</span>
        <span class="s1">ibar = IFoo(</span><span class="s4">'IBar'</span><span class="s1">)</span>
        <span class="s3">class </span><span class="s1">_Factory(object):</span>
            <span class="s3">def </span><span class="s1">__init__(self</span><span class="s3">, </span><span class="s1">context):</span>
                <span class="s1">self.context = context</span>
        <span class="s1">@implementer(ibar)</span>
        <span class="s3">class </span><span class="s1">_Context(object):</span>
            <span class="s3">pass</span>
        <span class="s1">_context = _Context()</span>
        <span class="s1">comp = self._makeOne()</span>
        <span class="s1">comp.registerAdapter(_Factory</span><span class="s3">, </span><span class="s1">(ibar</span><span class="s3">,</span><span class="s1">)</span><span class="s3">, </span><span class="s1">ifoo)</span>
        <span class="s1">adapter = comp.queryAdapter(_context</span><span class="s3">, </span><span class="s1">ifoo)</span>
        <span class="s1">self.assertTrue(isinstance(adapter</span><span class="s3">, </span><span class="s1">_Factory))</span>
        <span class="s1">self.assertTrue(adapter.context </span><span class="s3">is </span><span class="s1">_context)</span>

    <span class="s3">def </span><span class="s1">test_getAdapter_miss(self):</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">InterfaceClass</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">implementer</span>
        <span class="s3">from </span><span class="s1">zope.interface.interfaces </span><span class="s3">import </span><span class="s1">ComponentLookupError</span>
        <span class="s3">class </span><span class="s1">IFoo(InterfaceClass):</span>
            <span class="s3">pass</span>
        <span class="s1">ifoo = IFoo(</span><span class="s4">'IFoo'</span><span class="s1">)</span>
        <span class="s1">ibar = IFoo(</span><span class="s4">'IBar'</span><span class="s1">)</span>
        <span class="s1">@implementer(ibar)</span>
        <span class="s3">class </span><span class="s1">_Context(object):</span>
            <span class="s3">pass</span>
        <span class="s1">_context = _Context()</span>
        <span class="s1">comp = self._makeOne()</span>
        <span class="s1">self.assertRaises(ComponentLookupError</span><span class="s3">,</span>
                          <span class="s1">comp.getAdapter</span><span class="s3">, </span><span class="s1">_context</span><span class="s3">, </span><span class="s1">ifoo)</span>

    <span class="s3">def </span><span class="s1">test_getAdapter_hit(self):</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">InterfaceClass</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">implementer</span>
        <span class="s3">class </span><span class="s1">IFoo(InterfaceClass):</span>
            <span class="s3">pass</span>
        <span class="s1">ifoo = IFoo(</span><span class="s4">'IFoo'</span><span class="s1">)</span>
        <span class="s1">ibar = IFoo(</span><span class="s4">'IBar'</span><span class="s1">)</span>
        <span class="s3">class </span><span class="s1">_Factory(object):</span>
            <span class="s3">def </span><span class="s1">__init__(self</span><span class="s3">, </span><span class="s1">context):</span>
                <span class="s1">self.context = context</span>
        <span class="s1">@implementer(ibar)</span>
        <span class="s3">class </span><span class="s1">_Context(object):</span>
            <span class="s3">pass</span>
        <span class="s1">_context = _Context()</span>
        <span class="s1">comp = self._makeOne()</span>
        <span class="s1">comp.registerAdapter(_Factory</span><span class="s3">, </span><span class="s1">(ibar</span><span class="s3">,</span><span class="s1">)</span><span class="s3">, </span><span class="s1">ifoo)</span>
        <span class="s1">adapter = comp.getAdapter(_context</span><span class="s3">, </span><span class="s1">ifoo)</span>
        <span class="s1">self.assertIsInstance(adapter</span><span class="s3">, </span><span class="s1">_Factory)</span>
        <span class="s1">self.assertIs(adapter.context</span><span class="s3">, </span><span class="s1">_context)</span>

    <span class="s3">def </span><span class="s1">test_getAdapter_hit_super(self):</span>
        <span class="s3">from </span><span class="s1">zope.interface </span><span class="s3">import </span><span class="s1">Interface</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">implementer</span>

        <span class="s3">class </span><span class="s1">IBase(Interface):</span>
            <span class="s3">pass</span>

        <span class="s3">class </span><span class="s1">IDerived(IBase):</span>
            <span class="s3">pass</span>

        <span class="s3">class </span><span class="s1">IFoo(Interface):</span>
            <span class="s3">pass</span>

        <span class="s1">@implementer(IBase)</span>
        <span class="s3">class </span><span class="s1">Base(object):</span>
            <span class="s3">pass</span>

        <span class="s1">@implementer(IDerived)</span>
        <span class="s3">class </span><span class="s1">Derived(Base):</span>
            <span class="s3">pass</span>

        <span class="s3">class </span><span class="s1">AdapterBase(object):</span>
            <span class="s3">def </span><span class="s1">__init__(self</span><span class="s3">, </span><span class="s1">context):</span>
                <span class="s1">self.context = context</span>

        <span class="s3">class </span><span class="s1">AdapterDerived(object):</span>
            <span class="s3">def </span><span class="s1">__init__(self</span><span class="s3">, </span><span class="s1">context):</span>
                <span class="s1">self.context = context</span>

        <span class="s1">comp = self._makeOne()</span>
        <span class="s1">comp.registerAdapter(AdapterDerived</span><span class="s3">, </span><span class="s1">(IDerived</span><span class="s3">,</span><span class="s1">)</span><span class="s3">, </span><span class="s1">IFoo)</span>
        <span class="s1">comp.registerAdapter(AdapterBase</span><span class="s3">, </span><span class="s1">(IBase</span><span class="s3">,</span><span class="s1">)</span><span class="s3">, </span><span class="s1">IFoo)</span>
        <span class="s1">self._should_not_change(comp)</span>

        <span class="s1">derived = Derived()</span>
        <span class="s1">adapter = comp.getAdapter(derived</span><span class="s3">, </span><span class="s1">IFoo)</span>
        <span class="s1">self.assertIsInstance(adapter</span><span class="s3">, </span><span class="s1">AdapterDerived)</span>
        <span class="s1">self.assertIs(adapter.context</span><span class="s3">, </span><span class="s1">derived)</span>

        <span class="s1">supe = super(Derived</span><span class="s3">, </span><span class="s1">derived)</span>
        <span class="s1">adapter = comp.getAdapter(supe</span><span class="s3">, </span><span class="s1">IFoo)</span>
        <span class="s1">self.assertIsInstance(adapter</span><span class="s3">, </span><span class="s1">AdapterBase)</span>
        <span class="s1">self.assertIs(adapter.context</span><span class="s3">, </span><span class="s1">derived)</span>

    <span class="s3">def </span><span class="s1">test_getAdapter_hit_super_when_parent_implements_interface_diamond(self):</span>
        <span class="s3">from </span><span class="s1">zope.interface </span><span class="s3">import </span><span class="s1">Interface</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">implementer</span>

        <span class="s3">class </span><span class="s1">IBase(Interface):</span>
            <span class="s3">pass</span>

        <span class="s3">class </span><span class="s1">IDerived(IBase):</span>
            <span class="s3">pass</span>

        <span class="s3">class </span><span class="s1">IFoo(Interface):</span>
            <span class="s3">pass</span>

        <span class="s3">class </span><span class="s1">Base(object):</span>
            <span class="s3">pass</span>

        <span class="s3">class </span><span class="s1">Child1(Base):</span>
            <span class="s3">pass</span>

        <span class="s1">@implementer(IBase)</span>
        <span class="s3">class </span><span class="s1">Child2(Base):</span>
            <span class="s3">pass</span>

        <span class="s1">@implementer(IDerived)</span>
        <span class="s3">class </span><span class="s1">Derived(Child1</span><span class="s3">, </span><span class="s1">Child2):</span>
            <span class="s3">pass</span>

        <span class="s3">class </span><span class="s1">AdapterBase(object):</span>
            <span class="s3">def </span><span class="s1">__init__(self</span><span class="s3">, </span><span class="s1">context):</span>
                <span class="s1">self.context = context</span>

        <span class="s3">class </span><span class="s1">AdapterDerived(object):</span>
            <span class="s3">def </span><span class="s1">__init__(self</span><span class="s3">, </span><span class="s1">context):</span>
                <span class="s1">self.context = context</span>

        <span class="s1">comp = self._makeOne()</span>
        <span class="s1">comp.registerAdapter(AdapterDerived</span><span class="s3">, </span><span class="s1">(IDerived</span><span class="s3">,</span><span class="s1">)</span><span class="s3">, </span><span class="s1">IFoo)</span>
        <span class="s1">comp.registerAdapter(AdapterBase</span><span class="s3">, </span><span class="s1">(IBase</span><span class="s3">,</span><span class="s1">)</span><span class="s3">, </span><span class="s1">IFoo)</span>
        <span class="s1">self._should_not_change(comp)</span>

        <span class="s1">derived = Derived()</span>
        <span class="s1">adapter = comp.getAdapter(derived</span><span class="s3">, </span><span class="s1">IFoo)</span>
        <span class="s1">self.assertIsInstance(adapter</span><span class="s3">, </span><span class="s1">AdapterDerived)</span>
        <span class="s1">self.assertIs(adapter.context</span><span class="s3">, </span><span class="s1">derived)</span>

        <span class="s1">supe = super(Derived</span><span class="s3">, </span><span class="s1">derived)</span>
        <span class="s1">adapter = comp.getAdapter(supe</span><span class="s3">, </span><span class="s1">IFoo)</span>
        <span class="s1">self.assertIsInstance(adapter</span><span class="s3">, </span><span class="s1">AdapterBase)</span>
        <span class="s1">self.assertIs(adapter.context</span><span class="s3">, </span><span class="s1">derived)</span>

    <span class="s3">def </span><span class="s1">test_queryMultiAdapter_miss(self):</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">InterfaceClass</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">implementer</span>
        <span class="s3">class </span><span class="s1">IFoo(InterfaceClass):</span>
            <span class="s3">pass</span>
        <span class="s1">ifoo = IFoo(</span><span class="s4">'IFoo'</span><span class="s1">)</span>
        <span class="s1">ibar = IFoo(</span><span class="s4">'IBar'</span><span class="s1">)</span>
        <span class="s1">ibaz = IFoo(</span><span class="s4">'IBaz'</span><span class="s1">)</span>
        <span class="s1">@implementer(ibar)</span>
        <span class="s3">class </span><span class="s1">_Context1(object):</span>
            <span class="s3">pass</span>
        <span class="s1">@implementer(ibaz)</span>
        <span class="s3">class </span><span class="s1">_Context2(object):</span>
            <span class="s3">pass</span>
        <span class="s1">_context1 = _Context1()</span>
        <span class="s1">_context2 = _Context2()</span>
        <span class="s1">comp = self._makeOne()</span>
        <span class="s1">self.assertEqual(comp.queryMultiAdapter((_context1</span><span class="s3">, </span><span class="s1">_context2)</span><span class="s3">, </span><span class="s1">ifoo)</span><span class="s3">,</span>
                         <span class="s3">None</span><span class="s1">)</span>

    <span class="s3">def </span><span class="s1">test_queryMultiAdapter_miss_w_default(self):</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">InterfaceClass</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">implementer</span>
        <span class="s3">class </span><span class="s1">IFoo(InterfaceClass):</span>
            <span class="s3">pass</span>
        <span class="s1">ifoo = IFoo(</span><span class="s4">'IFoo'</span><span class="s1">)</span>
        <span class="s1">ibar = IFoo(</span><span class="s4">'IBar'</span><span class="s1">)</span>
        <span class="s1">ibaz = IFoo(</span><span class="s4">'IBaz'</span><span class="s1">)</span>
        <span class="s1">@implementer(ibar)</span>
        <span class="s3">class </span><span class="s1">_Context1(object):</span>
            <span class="s3">pass</span>
        <span class="s1">@implementer(ibaz)</span>
        <span class="s3">class </span><span class="s1">_Context2(object):</span>
            <span class="s3">pass</span>
        <span class="s1">_context1 = _Context1()</span>
        <span class="s1">_context2 = _Context2()</span>
        <span class="s1">_default = object()</span>
        <span class="s1">comp = self._makeOne()</span>
        <span class="s1">self.assertTrue(</span>
            <span class="s1">comp.queryMultiAdapter((_context1</span><span class="s3">, </span><span class="s1">_context2)</span><span class="s3">, </span><span class="s1">ifoo</span><span class="s3">,</span>
                                   <span class="s1">default=_default) </span><span class="s3">is </span><span class="s1">_default)</span>

    <span class="s3">def </span><span class="s1">test_queryMultiAdapter_hit(self):</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">InterfaceClass</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">implementer</span>
        <span class="s3">class </span><span class="s1">IFoo(InterfaceClass):</span>
            <span class="s3">pass</span>
        <span class="s1">ifoo = IFoo(</span><span class="s4">'IFoo'</span><span class="s1">)</span>
        <span class="s1">ibar = IFoo(</span><span class="s4">'IBar'</span><span class="s1">)</span>
        <span class="s1">ibaz = IFoo(</span><span class="s4">'IBaz'</span><span class="s1">)</span>
        <span class="s1">@implementer(ibar)</span>
        <span class="s3">class </span><span class="s1">_Context1(object):</span>
            <span class="s3">pass</span>
        <span class="s1">@implementer(ibaz)</span>
        <span class="s3">class </span><span class="s1">_Context2(object):</span>
            <span class="s3">pass</span>
        <span class="s1">_context1 = _Context1()</span>
        <span class="s1">_context2 = _Context2()</span>
        <span class="s3">class </span><span class="s1">_Factory(object):</span>
            <span class="s3">def </span><span class="s1">__init__(self</span><span class="s3">, </span><span class="s1">context1</span><span class="s3">, </span><span class="s1">context2):</span>
                <span class="s1">self.context = context1</span><span class="s3">, </span><span class="s1">context2</span>
        <span class="s1">comp = self._makeOne()</span>
        <span class="s1">comp.registerAdapter(_Factory</span><span class="s3">, </span><span class="s1">(ibar</span><span class="s3">, </span><span class="s1">ibaz)</span><span class="s3">, </span><span class="s1">ifoo)</span>
        <span class="s1">adapter = comp.queryMultiAdapter((_context1</span><span class="s3">, </span><span class="s1">_context2)</span><span class="s3">, </span><span class="s1">ifoo)</span>
        <span class="s1">self.assertTrue(isinstance(adapter</span><span class="s3">, </span><span class="s1">_Factory))</span>
        <span class="s1">self.assertEqual(adapter.context</span><span class="s3">, </span><span class="s1">(_context1</span><span class="s3">, </span><span class="s1">_context2))</span>

    <span class="s3">def </span><span class="s1">test_getMultiAdapter_miss(self):</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">InterfaceClass</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">implementer</span>
        <span class="s3">from </span><span class="s1">zope.interface.interfaces </span><span class="s3">import </span><span class="s1">ComponentLookupError</span>
        <span class="s3">class </span><span class="s1">IFoo(InterfaceClass):</span>
            <span class="s3">pass</span>
        <span class="s1">ifoo = IFoo(</span><span class="s4">'IFoo'</span><span class="s1">)</span>
        <span class="s1">ibar = IFoo(</span><span class="s4">'IBar'</span><span class="s1">)</span>
        <span class="s1">ibaz = IFoo(</span><span class="s4">'IBaz'</span><span class="s1">)</span>
        <span class="s1">@implementer(ibar)</span>
        <span class="s3">class </span><span class="s1">_Context1(object):</span>
            <span class="s3">pass</span>
        <span class="s1">@implementer(ibaz)</span>
        <span class="s3">class </span><span class="s1">_Context2(object):</span>
            <span class="s3">pass</span>
        <span class="s1">_context1 = _Context1()</span>
        <span class="s1">_context2 = _Context2()</span>
        <span class="s1">comp = self._makeOne()</span>
        <span class="s1">self.assertRaises(ComponentLookupError</span><span class="s3">,</span>
                          <span class="s1">comp.getMultiAdapter</span><span class="s3">, </span><span class="s1">(_context1</span><span class="s3">, </span><span class="s1">_context2)</span><span class="s3">, </span><span class="s1">ifoo)</span>

    <span class="s3">def </span><span class="s1">test_getMultiAdapter_hit(self):</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">InterfaceClass</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">implementer</span>
        <span class="s3">class </span><span class="s1">IFoo(InterfaceClass):</span>
            <span class="s3">pass</span>
        <span class="s1">ifoo = IFoo(</span><span class="s4">'IFoo'</span><span class="s1">)</span>
        <span class="s1">ibar = IFoo(</span><span class="s4">'IBar'</span><span class="s1">)</span>
        <span class="s1">ibaz = IFoo(</span><span class="s4">'IBaz'</span><span class="s1">)</span>
        <span class="s1">@implementer(ibar)</span>
        <span class="s3">class </span><span class="s1">_Context1(object):</span>
            <span class="s3">pass</span>
        <span class="s1">@implementer(ibaz)</span>
        <span class="s3">class </span><span class="s1">_Context2(object):</span>
            <span class="s3">pass</span>
        <span class="s1">_context1 = _Context1()</span>
        <span class="s1">_context2 = _Context2()</span>
        <span class="s3">class </span><span class="s1">_Factory(object):</span>
            <span class="s3">def </span><span class="s1">__init__(self</span><span class="s3">, </span><span class="s1">context1</span><span class="s3">, </span><span class="s1">context2):</span>
                <span class="s1">self.context = context1</span><span class="s3">, </span><span class="s1">context2</span>
        <span class="s1">comp = self._makeOne()</span>
        <span class="s1">comp.registerAdapter(_Factory</span><span class="s3">, </span><span class="s1">(ibar</span><span class="s3">, </span><span class="s1">ibaz)</span><span class="s3">, </span><span class="s1">ifoo)</span>
        <span class="s1">adapter = comp.getMultiAdapter((_context1</span><span class="s3">, </span><span class="s1">_context2)</span><span class="s3">, </span><span class="s1">ifoo)</span>
        <span class="s1">self.assertTrue(isinstance(adapter</span><span class="s3">, </span><span class="s1">_Factory))</span>
        <span class="s1">self.assertEqual(adapter.context</span><span class="s3">, </span><span class="s1">(_context1</span><span class="s3">, </span><span class="s1">_context2))</span>

    <span class="s3">def </span><span class="s1">_should_not_change(self</span><span class="s3">, </span><span class="s1">comp):</span>
        <span class="s0"># Be sure that none of the underlying structures</span>
        <span class="s0"># get told that they have changed during this process</span>
        <span class="s0"># because that invalidates caches.</span>
        <span class="s3">def </span><span class="s1">no_changes(*args):</span>
            <span class="s1">self.fail(</span><span class="s4">&quot;Nothing should get changed&quot;</span><span class="s1">)</span>
        <span class="s1">comp.changed = no_changes</span>
        <span class="s1">comp.adapters.changed = no_changes</span>
        <span class="s1">comp.adapters._v_lookup.changed = no_changes</span>

    <span class="s3">def </span><span class="s1">test_getMultiAdapter_hit_super(self):</span>
        <span class="s3">from </span><span class="s1">zope.interface </span><span class="s3">import </span><span class="s1">Interface</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">implementer</span>

        <span class="s3">class </span><span class="s1">IBase(Interface):</span>
            <span class="s3">pass</span>

        <span class="s3">class </span><span class="s1">IDerived(IBase):</span>
            <span class="s3">pass</span>

        <span class="s3">class </span><span class="s1">IFoo(Interface):</span>
            <span class="s3">pass</span>

        <span class="s1">@implementer(IBase)</span>
        <span class="s3">class </span><span class="s1">Base(object):</span>
            <span class="s3">pass</span>

        <span class="s1">@implementer(IDerived)</span>
        <span class="s3">class </span><span class="s1">Derived(Base):</span>
            <span class="s3">pass</span>

        <span class="s3">class </span><span class="s1">AdapterBase(object):</span>
            <span class="s3">def </span><span class="s1">__init__(self</span><span class="s3">, </span><span class="s1">context1</span><span class="s3">, </span><span class="s1">context2):</span>
                <span class="s1">self.context1 = context1</span>
                <span class="s1">self.context2 = context2</span>

        <span class="s3">class </span><span class="s1">AdapterDerived(AdapterBase):</span>
            <span class="s3">pass</span>

        <span class="s1">comp = self._makeOne()</span>
        <span class="s1">comp.registerAdapter(AdapterDerived</span><span class="s3">, </span><span class="s1">(IDerived</span><span class="s3">, </span><span class="s1">IDerived)</span><span class="s3">, </span><span class="s1">IFoo)</span>
        <span class="s1">comp.registerAdapter(AdapterBase</span><span class="s3">, </span><span class="s1">(IBase</span><span class="s3">, </span><span class="s1">IDerived)</span><span class="s3">, </span><span class="s1">IFoo)</span>
        <span class="s1">self._should_not_change(comp)</span>

        <span class="s1">derived = Derived()</span>
        <span class="s1">adapter = comp.getMultiAdapter((derived</span><span class="s3">, </span><span class="s1">derived)</span><span class="s3">, </span><span class="s1">IFoo)</span>
        <span class="s1">self.assertIsInstance(adapter</span><span class="s3">, </span><span class="s1">AdapterDerived)</span>
        <span class="s1">self.assertIs(adapter.context1</span><span class="s3">, </span><span class="s1">derived)</span>
        <span class="s1">self.assertIs(adapter.context2</span><span class="s3">, </span><span class="s1">derived)</span>

        <span class="s1">supe = super(Derived</span><span class="s3">, </span><span class="s1">derived)</span>
        <span class="s1">adapter = comp.getMultiAdapter((supe</span><span class="s3">, </span><span class="s1">derived)</span><span class="s3">, </span><span class="s1">IFoo)</span>
        <span class="s1">self.assertIsInstance(adapter</span><span class="s3">, </span><span class="s1">AdapterBase)</span>
        <span class="s1">self.assertNotIsInstance(adapter</span><span class="s3">, </span><span class="s1">AdapterDerived)</span>
        <span class="s1">self.assertIs(adapter.context1</span><span class="s3">, </span><span class="s1">derived)</span>
        <span class="s1">self.assertIs(adapter.context2</span><span class="s3">, </span><span class="s1">derived)</span>

    <span class="s3">def </span><span class="s1">test_getAdapters_empty(self):</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">InterfaceClass</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">implementer</span>
        <span class="s3">class </span><span class="s1">IFoo(InterfaceClass):</span>
            <span class="s3">pass</span>
        <span class="s1">ifoo = IFoo(</span><span class="s4">'IFoo'</span><span class="s1">)</span>
        <span class="s1">ibar = IFoo(</span><span class="s4">'IBar'</span><span class="s1">)</span>
        <span class="s1">ibaz = IFoo(</span><span class="s4">'IBaz'</span><span class="s1">)</span>
        <span class="s1">@implementer(ibar)</span>
        <span class="s3">class </span><span class="s1">_Context1(object):</span>
            <span class="s3">pass</span>
        <span class="s1">@implementer(ibaz)</span>
        <span class="s3">class </span><span class="s1">_Context2(object):</span>
            <span class="s3">pass</span>
        <span class="s1">_context1 = _Context1()</span>
        <span class="s1">_context2 = _Context2()</span>
        <span class="s1">comp = self._makeOne()</span>
        <span class="s1">self.assertEqual(</span>
            <span class="s1">list(comp.getAdapters((_context1</span><span class="s3">, </span><span class="s1">_context2)</span><span class="s3">, </span><span class="s1">ifoo))</span><span class="s3">, </span><span class="s1">[])</span>

    <span class="s3">def </span><span class="s1">test_getAdapters_factory_returns_None(self):</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">InterfaceClass</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">implementer</span>
        <span class="s3">class </span><span class="s1">IFoo(InterfaceClass):</span>
            <span class="s3">pass</span>
        <span class="s1">ifoo = IFoo(</span><span class="s4">'IFoo'</span><span class="s1">)</span>
        <span class="s1">ibar = IFoo(</span><span class="s4">'IBar'</span><span class="s1">)</span>
        <span class="s1">ibaz = IFoo(</span><span class="s4">'IBaz'</span><span class="s1">)</span>
        <span class="s1">@implementer(ibar)</span>
        <span class="s3">class </span><span class="s1">_Context1(object):</span>
            <span class="s3">pass</span>
        <span class="s1">@implementer(ibaz)</span>
        <span class="s3">class </span><span class="s1">_Context2(object):</span>
            <span class="s3">pass</span>
        <span class="s1">_context1 = _Context1()</span>
        <span class="s1">_context2 = _Context2()</span>
        <span class="s1">comp = self._makeOne()</span>
        <span class="s1">_called_with = []</span>
        <span class="s3">def </span><span class="s1">_side_effect_only(context1</span><span class="s3">, </span><span class="s1">context2):</span>
            <span class="s1">_called_with.append((context1</span><span class="s3">, </span><span class="s1">context2))</span>
            <span class="s3">return None</span>
        <span class="s1">comp.registerAdapter(_side_effect_only</span><span class="s3">, </span><span class="s1">(ibar</span><span class="s3">, </span><span class="s1">ibaz)</span><span class="s3">, </span><span class="s1">ifoo)</span>
        <span class="s1">self.assertEqual(</span>
            <span class="s1">list(comp.getAdapters((_context1</span><span class="s3">, </span><span class="s1">_context2)</span><span class="s3">, </span><span class="s1">ifoo))</span><span class="s3">, </span><span class="s1">[])</span>
        <span class="s1">self.assertEqual(_called_with</span><span class="s3">, </span><span class="s1">[(_context1</span><span class="s3">, </span><span class="s1">_context2)])</span>

    <span class="s3">def </span><span class="s1">test_getAdapters_non_empty(self):</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">InterfaceClass</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">implementer</span>

        <span class="s3">class </span><span class="s1">IFoo(InterfaceClass):</span>
            <span class="s3">pass</span>
        <span class="s1">ifoo = IFoo(</span><span class="s4">'IFoo'</span><span class="s1">)</span>
        <span class="s1">ibar = IFoo(</span><span class="s4">'IBar'</span><span class="s1">)</span>
        <span class="s1">ibaz = IFoo(</span><span class="s4">'IBaz'</span><span class="s1">)</span>
        <span class="s1">@implementer(ibar)</span>
        <span class="s3">class </span><span class="s1">_Context1(object):</span>
            <span class="s3">pass</span>
        <span class="s1">@implementer(ibaz)</span>
        <span class="s3">class </span><span class="s1">_Context2(object):</span>
            <span class="s3">pass</span>
        <span class="s1">_context1 = _Context1()</span>
        <span class="s1">_context2 = _Context2()</span>
        <span class="s3">class </span><span class="s1">_Factory1(object):</span>
            <span class="s3">def </span><span class="s1">__init__(self</span><span class="s3">, </span><span class="s1">context1</span><span class="s3">, </span><span class="s1">context2):</span>
                <span class="s1">self.context = context1</span><span class="s3">, </span><span class="s1">context2</span>
        <span class="s3">class </span><span class="s1">_Factory2(object):</span>
            <span class="s3">def </span><span class="s1">__init__(self</span><span class="s3">, </span><span class="s1">context1</span><span class="s3">, </span><span class="s1">context2):</span>
                <span class="s1">self.context = context1</span><span class="s3">, </span><span class="s1">context2</span>
        <span class="s1">_name1 = </span><span class="s4">u'name1'</span>
        <span class="s1">_name2 = </span><span class="s4">u'name2'</span>
        <span class="s1">comp = self._makeOne()</span>
        <span class="s1">comp.registerAdapter(_Factory1</span><span class="s3">, </span><span class="s1">(ibar</span><span class="s3">, </span><span class="s1">ibaz)</span><span class="s3">, </span><span class="s1">ifoo</span><span class="s3">, </span><span class="s1">name=_name1)</span>
        <span class="s1">comp.registerAdapter(_Factory2</span><span class="s3">, </span><span class="s1">(ibar</span><span class="s3">, </span><span class="s1">ibaz)</span><span class="s3">, </span><span class="s1">ifoo</span><span class="s3">, </span><span class="s1">name=_name2)</span>
        <span class="s1">found = sorted(comp.getAdapters((_context1</span><span class="s3">, </span><span class="s1">_context2)</span><span class="s3">, </span><span class="s1">ifoo))</span>
        <span class="s1">self.assertEqual(len(found)</span><span class="s3">, </span><span class="s5">2</span><span class="s1">)</span>
        <span class="s1">self.assertEqual(found[</span><span class="s5">0</span><span class="s1">][</span><span class="s5">0</span><span class="s1">]</span><span class="s3">, </span><span class="s1">_name1)</span>
        <span class="s1">self.assertTrue(isinstance(found[</span><span class="s5">0</span><span class="s1">][</span><span class="s5">1</span><span class="s1">]</span><span class="s3">, </span><span class="s1">_Factory1))</span>
        <span class="s1">self.assertEqual(found[</span><span class="s5">1</span><span class="s1">][</span><span class="s5">0</span><span class="s1">]</span><span class="s3">, </span><span class="s1">_name2)</span>
        <span class="s1">self.assertTrue(isinstance(found[</span><span class="s5">1</span><span class="s1">][</span><span class="s5">1</span><span class="s1">]</span><span class="s3">, </span><span class="s1">_Factory2))</span>

    <span class="s3">def </span><span class="s1">test_registerSubscriptionAdapter_w_nonblank_name(self):</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">InterfaceClass</span>

        <span class="s3">class </span><span class="s1">IFoo(InterfaceClass):</span>
            <span class="s3">pass</span>
        <span class="s1">ifoo = IFoo(</span><span class="s4">'IFoo'</span><span class="s1">)</span>
        <span class="s1">ibar = IFoo(</span><span class="s4">'IBar'</span><span class="s1">)</span>
        <span class="s1">_name = </span><span class="s4">u'name'</span>
        <span class="s1">_info = </span><span class="s4">u'info'</span>
        <span class="s3">def </span><span class="s1">_factory(context):</span>
            <span class="s3">raise </span><span class="s1">NotImplementedError()</span>

        <span class="s1">comp = self._makeOne()</span>
        <span class="s1">self.assertRaises(TypeError</span><span class="s3">, </span><span class="s1">comp.registerSubscriptionAdapter</span><span class="s3">,</span>
                          <span class="s1">_factory</span><span class="s3">, </span><span class="s1">(ibar</span><span class="s3">,</span><span class="s1">)</span><span class="s3">, </span><span class="s1">ifoo</span><span class="s3">, </span><span class="s1">_name</span><span class="s3">, </span><span class="s1">_info)</span>

    <span class="s3">def </span><span class="s1">test_registerSubscriptionAdapter_w_explicit_provided_and_required(self):</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">InterfaceClass</span>
        <span class="s3">from </span><span class="s1">zope.interface.interfaces </span><span class="s3">import </span><span class="s1">Registered</span>
        <span class="s3">from </span><span class="s1">zope.interface.registry </span><span class="s3">import </span><span class="s1">SubscriptionRegistration</span>

        <span class="s3">class </span><span class="s1">IFoo(InterfaceClass):</span>
            <span class="s3">pass</span>
        <span class="s1">ifoo = IFoo(</span><span class="s4">'IFoo'</span><span class="s1">)</span>
        <span class="s1">ibar = IFoo(</span><span class="s4">'IBar'</span><span class="s1">)</span>
        <span class="s1">_blank = </span><span class="s4">u''</span>
        <span class="s1">_info = </span><span class="s4">u'info'</span>
        <span class="s3">def </span><span class="s1">_factory(context):</span>
            <span class="s3">raise </span><span class="s1">NotImplementedError()</span>
        <span class="s1">comp = self._makeOne()</span>
        <span class="s1">_monkey</span><span class="s3">, </span><span class="s1">_events = self._wrapEvents()</span>
        <span class="s3">with </span><span class="s1">_monkey:</span>
            <span class="s1">comp.registerSubscriptionAdapter(_factory</span><span class="s3">, </span><span class="s1">(ibar</span><span class="s3">,</span><span class="s1">)</span><span class="s3">, </span><span class="s1">ifoo</span><span class="s3">,</span>
                                             <span class="s1">info=_info)</span>
        <span class="s1">reg = comp.adapters._subscribers[</span><span class="s5">1</span><span class="s1">][ibar][ifoo][_blank]</span>
        <span class="s1">self.assertEqual(len(reg)</span><span class="s3">, </span><span class="s5">1</span><span class="s1">)</span>
        <span class="s1">self.assertTrue(reg[</span><span class="s5">0</span><span class="s1">] </span><span class="s3">is </span><span class="s1">_factory)</span>
        <span class="s1">self.assertEqual(comp._subscription_registrations</span><span class="s3">,</span>
                         <span class="s1">[((ibar</span><span class="s3">,</span><span class="s1">)</span><span class="s3">, </span><span class="s1">ifoo</span><span class="s3">, </span><span class="s1">_blank</span><span class="s3">, </span><span class="s1">_factory</span><span class="s3">, </span><span class="s1">_info)])</span>
        <span class="s1">self.assertEqual(len(_events)</span><span class="s3">, </span><span class="s5">1</span><span class="s1">)</span>
        <span class="s1">args</span><span class="s3">, </span><span class="s1">kw = _events[</span><span class="s5">0</span><span class="s1">]</span>
        <span class="s1">event</span><span class="s3">, </span><span class="s1">= args</span>
        <span class="s1">self.assertEqual(kw</span><span class="s3">, </span><span class="s1">{})</span>
        <span class="s1">self.assertTrue(isinstance(event</span><span class="s3">, </span><span class="s1">Registered))</span>
        <span class="s1">self.assertTrue(isinstance(event.object</span><span class="s3">, </span><span class="s1">SubscriptionRegistration))</span>
        <span class="s1">self.assertTrue(event.object.registry </span><span class="s3">is </span><span class="s1">comp)</span>
        <span class="s1">self.assertTrue(event.object.provided </span><span class="s3">is </span><span class="s1">ifoo)</span>
        <span class="s1">self.assertEqual(event.object.required</span><span class="s3">, </span><span class="s1">(ibar</span><span class="s3">,</span><span class="s1">))</span>
        <span class="s1">self.assertEqual(event.object.name</span><span class="s3">, </span><span class="s1">_blank)</span>
        <span class="s1">self.assertTrue(event.object.info </span><span class="s3">is </span><span class="s1">_info)</span>
        <span class="s1">self.assertTrue(event.object.factory </span><span class="s3">is </span><span class="s1">_factory)</span>

    <span class="s3">def </span><span class="s1">test_registerSubscriptionAdapter_wo_explicit_provided(self):</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">InterfaceClass</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">implementer</span>
        <span class="s3">from </span><span class="s1">zope.interface.interfaces </span><span class="s3">import </span><span class="s1">Registered</span>
        <span class="s3">from </span><span class="s1">zope.interface.registry </span><span class="s3">import </span><span class="s1">SubscriptionRegistration</span>

        <span class="s3">class </span><span class="s1">IFoo(InterfaceClass):</span>
            <span class="s3">pass</span>
        <span class="s1">ifoo = IFoo(</span><span class="s4">'IFoo'</span><span class="s1">)</span>
        <span class="s1">ibar = IFoo(</span><span class="s4">'IBar'</span><span class="s1">)</span>
        <span class="s1">_info = </span><span class="s4">u'info'</span>
        <span class="s1">_blank = </span><span class="s4">u''</span>

        <span class="s1">@implementer(ifoo)</span>
        <span class="s3">class </span><span class="s1">_Factory(object):</span>
            <span class="s3">pass</span>

        <span class="s1">comp = self._makeOne()</span>
        <span class="s1">_monkey</span><span class="s3">, </span><span class="s1">_events = self._wrapEvents()</span>
        <span class="s3">with </span><span class="s1">_monkey:</span>
            <span class="s1">comp.registerSubscriptionAdapter(_Factory</span><span class="s3">, </span><span class="s1">(ibar</span><span class="s3">,</span><span class="s1">)</span><span class="s3">, </span><span class="s1">info=_info)</span>
        <span class="s1">reg = comp.adapters._subscribers[</span><span class="s5">1</span><span class="s1">][ibar][ifoo][_blank]</span>
        <span class="s1">self.assertEqual(len(reg)</span><span class="s3">, </span><span class="s5">1</span><span class="s1">)</span>
        <span class="s1">self.assertTrue(reg[</span><span class="s5">0</span><span class="s1">] </span><span class="s3">is </span><span class="s1">_Factory)</span>
        <span class="s1">self.assertEqual(comp._subscription_registrations</span><span class="s3">,</span>
                         <span class="s1">[((ibar</span><span class="s3">,</span><span class="s1">)</span><span class="s3">, </span><span class="s1">ifoo</span><span class="s3">, </span><span class="s1">_blank</span><span class="s3">, </span><span class="s1">_Factory</span><span class="s3">, </span><span class="s1">_info)])</span>
        <span class="s1">self.assertEqual(len(_events)</span><span class="s3">, </span><span class="s5">1</span><span class="s1">)</span>
        <span class="s1">args</span><span class="s3">, </span><span class="s1">kw = _events[</span><span class="s5">0</span><span class="s1">]</span>
        <span class="s1">event</span><span class="s3">, </span><span class="s1">= args</span>
        <span class="s1">self.assertEqual(kw</span><span class="s3">, </span><span class="s1">{})</span>
        <span class="s1">self.assertTrue(isinstance(event</span><span class="s3">, </span><span class="s1">Registered))</span>
        <span class="s1">self.assertTrue(isinstance(event.object</span><span class="s3">, </span><span class="s1">SubscriptionRegistration))</span>
        <span class="s1">self.assertTrue(event.object.registry </span><span class="s3">is </span><span class="s1">comp)</span>
        <span class="s1">self.assertTrue(event.object.provided </span><span class="s3">is </span><span class="s1">ifoo)</span>
        <span class="s1">self.assertEqual(event.object.required</span><span class="s3">, </span><span class="s1">(ibar</span><span class="s3">,</span><span class="s1">))</span>
        <span class="s1">self.assertEqual(event.object.name</span><span class="s3">, </span><span class="s1">_blank)</span>
        <span class="s1">self.assertTrue(event.object.info </span><span class="s3">is </span><span class="s1">_info)</span>
        <span class="s1">self.assertTrue(event.object.factory </span><span class="s3">is </span><span class="s1">_Factory)</span>

    <span class="s3">def </span><span class="s1">test_registerSubscriptionAdapter_wo_explicit_required(self):</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">InterfaceClass</span>
        <span class="s3">from </span><span class="s1">zope.interface.interfaces </span><span class="s3">import </span><span class="s1">Registered</span>
        <span class="s3">from </span><span class="s1">zope.interface.registry </span><span class="s3">import </span><span class="s1">SubscriptionRegistration</span>

        <span class="s3">class </span><span class="s1">IFoo(InterfaceClass):</span>
            <span class="s3">pass</span>
        <span class="s1">ifoo = IFoo(</span><span class="s4">'IFoo'</span><span class="s1">)</span>
        <span class="s1">ibar = IFoo(</span><span class="s4">'IBar'</span><span class="s1">)</span>
        <span class="s1">_info = </span><span class="s4">u'info'</span>
        <span class="s1">_blank = </span><span class="s4">u''</span>
        <span class="s3">class </span><span class="s1">_Factory(object):</span>
            <span class="s1">__component_adapts__ = (ibar</span><span class="s3">,</span><span class="s1">)</span>

        <span class="s1">comp = self._makeOne()</span>
        <span class="s1">_monkey</span><span class="s3">, </span><span class="s1">_events = self._wrapEvents()</span>
        <span class="s3">with </span><span class="s1">_monkey:</span>
            <span class="s1">comp.registerSubscriptionAdapter(</span>
                    <span class="s1">_Factory</span><span class="s3">, </span><span class="s1">provided=ifoo</span><span class="s3">, </span><span class="s1">info=_info)</span>
        <span class="s1">reg = comp.adapters._subscribers[</span><span class="s5">1</span><span class="s1">][ibar][ifoo][_blank]</span>
        <span class="s1">self.assertEqual(len(reg)</span><span class="s3">, </span><span class="s5">1</span><span class="s1">)</span>
        <span class="s1">self.assertTrue(reg[</span><span class="s5">0</span><span class="s1">] </span><span class="s3">is </span><span class="s1">_Factory)</span>
        <span class="s1">self.assertEqual(comp._subscription_registrations</span><span class="s3">,</span>
                         <span class="s1">[((ibar</span><span class="s3">,</span><span class="s1">)</span><span class="s3">, </span><span class="s1">ifoo</span><span class="s3">, </span><span class="s1">_blank</span><span class="s3">, </span><span class="s1">_Factory</span><span class="s3">, </span><span class="s1">_info)])</span>
        <span class="s1">self.assertEqual(len(_events)</span><span class="s3">, </span><span class="s5">1</span><span class="s1">)</span>
        <span class="s1">args</span><span class="s3">, </span><span class="s1">kw = _events[</span><span class="s5">0</span><span class="s1">]</span>
        <span class="s1">event</span><span class="s3">, </span><span class="s1">= args</span>
        <span class="s1">self.assertEqual(kw</span><span class="s3">, </span><span class="s1">{})</span>
        <span class="s1">self.assertTrue(isinstance(event</span><span class="s3">, </span><span class="s1">Registered))</span>
        <span class="s1">self.assertTrue(isinstance(event.object</span><span class="s3">, </span><span class="s1">SubscriptionRegistration))</span>
        <span class="s1">self.assertTrue(event.object.registry </span><span class="s3">is </span><span class="s1">comp)</span>
        <span class="s1">self.assertTrue(event.object.provided </span><span class="s3">is </span><span class="s1">ifoo)</span>
        <span class="s1">self.assertEqual(event.object.required</span><span class="s3">, </span><span class="s1">(ibar</span><span class="s3">,</span><span class="s1">))</span>
        <span class="s1">self.assertEqual(event.object.name</span><span class="s3">, </span><span class="s1">_blank)</span>
        <span class="s1">self.assertTrue(event.object.info </span><span class="s3">is </span><span class="s1">_info)</span>
        <span class="s1">self.assertTrue(event.object.factory </span><span class="s3">is </span><span class="s1">_Factory)</span>

    <span class="s3">def </span><span class="s1">test_registerSubscriptionAdapter_wo_event(self):</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">InterfaceClass</span>

        <span class="s3">class </span><span class="s1">IFoo(InterfaceClass):</span>
            <span class="s3">pass</span>
        <span class="s1">ifoo = IFoo(</span><span class="s4">'IFoo'</span><span class="s1">)</span>
        <span class="s1">ibar = IFoo(</span><span class="s4">'IBar'</span><span class="s1">)</span>
        <span class="s1">_blank = </span><span class="s4">u''</span>
        <span class="s1">_info = </span><span class="s4">u'info'</span>

        <span class="s3">def </span><span class="s1">_factory(context):</span>
            <span class="s3">raise </span><span class="s1">NotImplementedError()</span>

        <span class="s1">comp = self._makeOne()</span>
        <span class="s1">_monkey</span><span class="s3">, </span><span class="s1">_events = self._wrapEvents()</span>
        <span class="s3">with </span><span class="s1">_monkey:</span>
            <span class="s1">comp.registerSubscriptionAdapter(_factory</span><span class="s3">, </span><span class="s1">(ibar</span><span class="s3">,</span><span class="s1">)</span><span class="s3">, </span><span class="s1">ifoo</span><span class="s3">,</span>
                                             <span class="s1">info=_info</span><span class="s3">, </span><span class="s1">event=</span><span class="s3">False</span><span class="s1">)</span>
        <span class="s1">self.assertEqual(len(_events)</span><span class="s3">, </span><span class="s5">0</span><span class="s1">)</span>

    <span class="s3">def </span><span class="s1">test_registeredSubscriptionAdapters_empty(self):</span>
        <span class="s1">comp = self._makeOne()</span>
        <span class="s1">self.assertEqual(list(comp.registeredSubscriptionAdapters())</span><span class="s3">, </span><span class="s1">[])</span>

    <span class="s3">def </span><span class="s1">test_registeredSubscriptionAdapters_notempty(self):</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">InterfaceClass</span>

        <span class="s3">from </span><span class="s1">zope.interface.registry </span><span class="s3">import </span><span class="s1">SubscriptionRegistration</span>
        <span class="s3">class </span><span class="s1">IFoo(InterfaceClass):</span>
            <span class="s3">pass</span>
        <span class="s1">ifoo = IFoo(</span><span class="s4">'IFoo'</span><span class="s1">)</span>
        <span class="s1">ibar = IFoo(</span><span class="s4">'IFoo'</span><span class="s1">)</span>
        <span class="s1">_info = </span><span class="s4">u'info'</span>
        <span class="s1">_blank = </span><span class="s4">u''</span>
        <span class="s3">class </span><span class="s1">_Factory(object):</span>
            <span class="s3">pass</span>

        <span class="s1">comp = self._makeOne()</span>
        <span class="s1">comp.registerSubscriptionAdapter(_Factory</span><span class="s3">, </span><span class="s1">(ibar</span><span class="s3">,</span><span class="s1">)</span><span class="s3">, </span><span class="s1">ifoo</span><span class="s3">, </span><span class="s1">info=_info)</span>
        <span class="s1">comp.registerSubscriptionAdapter(_Factory</span><span class="s3">, </span><span class="s1">(ibar</span><span class="s3">,</span><span class="s1">)</span><span class="s3">, </span><span class="s1">ifoo</span><span class="s3">, </span><span class="s1">info=_info)</span>
        <span class="s1">reg = list(comp.registeredSubscriptionAdapters())</span>
        <span class="s1">self.assertEqual(len(reg)</span><span class="s3">, </span><span class="s5">2</span><span class="s1">)</span>
        <span class="s1">self.assertTrue(isinstance(reg[</span><span class="s5">0</span><span class="s1">]</span><span class="s3">, </span><span class="s1">SubscriptionRegistration))</span>
        <span class="s1">self.assertTrue(reg[</span><span class="s5">0</span><span class="s1">].registry </span><span class="s3">is </span><span class="s1">comp)</span>
        <span class="s1">self.assertTrue(reg[</span><span class="s5">0</span><span class="s1">].provided </span><span class="s3">is </span><span class="s1">ifoo)</span>
        <span class="s1">self.assertEqual(reg[</span><span class="s5">0</span><span class="s1">].required</span><span class="s3">, </span><span class="s1">(ibar</span><span class="s3">,</span><span class="s1">))</span>
        <span class="s1">self.assertEqual(reg[</span><span class="s5">0</span><span class="s1">].name</span><span class="s3">, </span><span class="s1">_blank)</span>
        <span class="s1">self.assertTrue(reg[</span><span class="s5">0</span><span class="s1">].info </span><span class="s3">is </span><span class="s1">_info)</span>
        <span class="s1">self.assertTrue(reg[</span><span class="s5">0</span><span class="s1">].factory </span><span class="s3">is </span><span class="s1">_Factory)</span>
        <span class="s1">self.assertTrue(isinstance(reg[</span><span class="s5">1</span><span class="s1">]</span><span class="s3">, </span><span class="s1">SubscriptionRegistration))</span>
        <span class="s1">self.assertTrue(reg[</span><span class="s5">1</span><span class="s1">].registry </span><span class="s3">is </span><span class="s1">comp)</span>
        <span class="s1">self.assertTrue(reg[</span><span class="s5">1</span><span class="s1">].provided </span><span class="s3">is </span><span class="s1">ifoo)</span>
        <span class="s1">self.assertEqual(reg[</span><span class="s5">1</span><span class="s1">].required</span><span class="s3">, </span><span class="s1">(ibar</span><span class="s3">,</span><span class="s1">))</span>
        <span class="s1">self.assertEqual(reg[</span><span class="s5">1</span><span class="s1">].name</span><span class="s3">, </span><span class="s1">_blank)</span>
        <span class="s1">self.assertTrue(reg[</span><span class="s5">1</span><span class="s1">].info </span><span class="s3">is </span><span class="s1">_info)</span>
        <span class="s1">self.assertTrue(reg[</span><span class="s5">1</span><span class="s1">].factory </span><span class="s3">is </span><span class="s1">_Factory)</span>

    <span class="s3">def </span><span class="s1">test_unregisterSubscriptionAdapter_w_nonblank_name(self):</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">InterfaceClass</span>

        <span class="s3">class </span><span class="s1">IFoo(InterfaceClass):</span>
            <span class="s3">pass</span>
        <span class="s1">ifoo = IFoo(</span><span class="s4">'IFoo'</span><span class="s1">)</span>
        <span class="s1">ibar = IFoo(</span><span class="s4">'IBar'</span><span class="s1">)</span>
        <span class="s1">_nonblank = </span><span class="s4">u'nonblank'</span>
        <span class="s1">comp = self._makeOne()</span>
        <span class="s1">self.assertRaises(TypeError</span><span class="s3">, </span><span class="s1">comp.unregisterSubscriptionAdapter</span><span class="s3">,</span>
                          <span class="s1">required=ifoo</span><span class="s3">, </span><span class="s1">provided=ibar</span><span class="s3">, </span><span class="s1">name=_nonblank)</span>

    <span class="s3">def </span><span class="s1">test_unregisterSubscriptionAdapter_neither_factory_nor_provided(self):</span>
        <span class="s1">comp = self._makeOne()</span>
        <span class="s1">self.assertRaises(TypeError</span><span class="s3">, </span><span class="s1">comp.unregisterSubscriptionAdapter</span><span class="s3">,</span>
                          <span class="s1">factory=</span><span class="s3">None, </span><span class="s1">provided=</span><span class="s3">None</span><span class="s1">)</span>

    <span class="s3">def </span><span class="s1">test_unregisterSubscriptionAdapter_neither_factory_nor_required(self):</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">InterfaceClass</span>
        <span class="s3">class </span><span class="s1">IFoo(InterfaceClass):</span>
            <span class="s3">pass</span>
        <span class="s1">ifoo = IFoo(</span><span class="s4">'IFoo'</span><span class="s1">)</span>
        <span class="s1">comp = self._makeOne()</span>
        <span class="s1">self.assertRaises(TypeError</span><span class="s3">, </span><span class="s1">comp.unregisterSubscriptionAdapter</span><span class="s3">,</span>
                          <span class="s1">factory=</span><span class="s3">None, </span><span class="s1">provided=ifoo</span><span class="s3">, </span><span class="s1">required=</span><span class="s3">None</span><span class="s1">)</span>

    <span class="s3">def </span><span class="s1">test_unregisterSubscriptionAdapter_miss(self):</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">InterfaceClass</span>
        <span class="s3">class </span><span class="s1">IFoo(InterfaceClass):</span>
            <span class="s3">pass</span>
        <span class="s1">ifoo = IFoo(</span><span class="s4">'IFoo'</span><span class="s1">)</span>
        <span class="s1">ibar = IFoo(</span><span class="s4">'IBar'</span><span class="s1">)</span>
        <span class="s3">class </span><span class="s1">_Factory(object):</span>
            <span class="s3">pass</span>

        <span class="s1">comp = self._makeOne()</span>
        <span class="s1">_monkey</span><span class="s3">, </span><span class="s1">_events = self._wrapEvents()</span>
        <span class="s3">with </span><span class="s1">_monkey:</span>
            <span class="s1">unreg = comp.unregisterSubscriptionAdapter(_Factory</span><span class="s3">, </span><span class="s1">(ibar</span><span class="s3">,</span><span class="s1">)</span><span class="s3">, </span><span class="s1">ifoo)</span>
        <span class="s1">self.assertFalse(unreg)</span>
        <span class="s1">self.assertFalse(_events)</span>

    <span class="s3">def </span><span class="s1">test_unregisterSubscriptionAdapter_hit_wo_factory(self):</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">InterfaceClass</span>
        <span class="s3">from </span><span class="s1">zope.interface.interfaces </span><span class="s3">import </span><span class="s1">Unregistered</span>
        <span class="s3">from </span><span class="s1">zope.interface.registry </span><span class="s3">import </span><span class="s1">SubscriptionRegistration</span>
        <span class="s3">class </span><span class="s1">IFoo(InterfaceClass):</span>
            <span class="s3">pass</span>
        <span class="s1">ifoo = IFoo(</span><span class="s4">'IFoo'</span><span class="s1">)</span>
        <span class="s1">ibar = IFoo(</span><span class="s4">'IBar'</span><span class="s1">)</span>
        <span class="s3">class </span><span class="s1">_Factory(object):</span>
            <span class="s3">pass</span>

        <span class="s1">comp = self._makeOne()</span>
        <span class="s1">comp.registerSubscriptionAdapter(_Factory</span><span class="s3">, </span><span class="s1">(ibar</span><span class="s3">,</span><span class="s1">)</span><span class="s3">, </span><span class="s1">ifoo)</span>
        <span class="s1">_monkey</span><span class="s3">, </span><span class="s1">_events = self._wrapEvents()</span>
        <span class="s3">with </span><span class="s1">_monkey:</span>
            <span class="s1">unreg = comp.unregisterSubscriptionAdapter(</span><span class="s3">None, </span><span class="s1">(ibar</span><span class="s3">,</span><span class="s1">)</span><span class="s3">, </span><span class="s1">ifoo)</span>
        <span class="s1">self.assertTrue(unreg)</span>
        <span class="s1">self.assertFalse(comp.adapters._subscribers)</span>
        <span class="s1">self.assertFalse(comp._subscription_registrations)</span>
        <span class="s1">self.assertEqual(len(_events)</span><span class="s3">, </span><span class="s5">1</span><span class="s1">)</span>
        <span class="s1">args</span><span class="s3">, </span><span class="s1">kw = _events[</span><span class="s5">0</span><span class="s1">]</span>
        <span class="s1">event</span><span class="s3">, </span><span class="s1">= args</span>
        <span class="s1">self.assertEqual(kw</span><span class="s3">, </span><span class="s1">{})</span>
        <span class="s1">self.assertTrue(isinstance(event</span><span class="s3">, </span><span class="s1">Unregistered))</span>
        <span class="s1">self.assertTrue(isinstance(event.object</span><span class="s3">, </span><span class="s1">SubscriptionRegistration))</span>
        <span class="s1">self.assertTrue(event.object.registry </span><span class="s3">is </span><span class="s1">comp)</span>
        <span class="s1">self.assertTrue(event.object.provided </span><span class="s3">is </span><span class="s1">ifoo)</span>
        <span class="s1">self.assertEqual(event.object.required</span><span class="s3">, </span><span class="s1">(ibar</span><span class="s3">,</span><span class="s1">))</span>
        <span class="s1">self.assertEqual(event.object.name</span><span class="s3">, </span><span class="s4">''</span><span class="s1">)</span>
        <span class="s1">self.assertEqual(event.object.info</span><span class="s3">, </span><span class="s4">''</span><span class="s1">)</span>
        <span class="s1">self.assertTrue(event.object.factory </span><span class="s3">is None</span><span class="s1">)</span>

    <span class="s3">def </span><span class="s1">test_unregisterSubscriptionAdapter_hit_w_factory(self):</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">InterfaceClass</span>
        <span class="s3">from </span><span class="s1">zope.interface.interfaces </span><span class="s3">import </span><span class="s1">Unregistered</span>
        <span class="s3">from </span><span class="s1">zope.interface.registry </span><span class="s3">import </span><span class="s1">SubscriptionRegistration</span>
        <span class="s3">class </span><span class="s1">IFoo(InterfaceClass):</span>
            <span class="s3">pass</span>
        <span class="s1">ifoo = IFoo(</span><span class="s4">'IFoo'</span><span class="s1">)</span>
        <span class="s1">ibar = IFoo(</span><span class="s4">'IBar'</span><span class="s1">)</span>
        <span class="s3">class </span><span class="s1">_Factory(object):</span>
            <span class="s3">pass</span>

        <span class="s1">comp = self._makeOne()</span>
        <span class="s1">comp.registerSubscriptionAdapter(_Factory</span><span class="s3">, </span><span class="s1">(ibar</span><span class="s3">,</span><span class="s1">)</span><span class="s3">, </span><span class="s1">ifoo)</span>
        <span class="s1">_monkey</span><span class="s3">, </span><span class="s1">_events = self._wrapEvents()</span>
        <span class="s3">with </span><span class="s1">_monkey:</span>
            <span class="s1">unreg = comp.unregisterSubscriptionAdapter(_Factory</span><span class="s3">, </span><span class="s1">(ibar</span><span class="s3">,</span><span class="s1">)</span><span class="s3">, </span><span class="s1">ifoo)</span>
        <span class="s1">self.assertTrue(unreg)</span>
        <span class="s1">self.assertFalse(comp.adapters._subscribers)</span>
        <span class="s1">self.assertFalse(comp._subscription_registrations)</span>
        <span class="s1">self.assertEqual(len(_events)</span><span class="s3">, </span><span class="s5">1</span><span class="s1">)</span>
        <span class="s1">args</span><span class="s3">, </span><span class="s1">kw = _events[</span><span class="s5">0</span><span class="s1">]</span>
        <span class="s1">event</span><span class="s3">, </span><span class="s1">= args</span>
        <span class="s1">self.assertEqual(kw</span><span class="s3">, </span><span class="s1">{})</span>
        <span class="s1">self.assertTrue(isinstance(event</span><span class="s3">, </span><span class="s1">Unregistered))</span>
        <span class="s1">self.assertTrue(isinstance(event.object</span><span class="s3">, </span><span class="s1">SubscriptionRegistration))</span>
        <span class="s1">self.assertTrue(event.object.registry </span><span class="s3">is </span><span class="s1">comp)</span>
        <span class="s1">self.assertTrue(event.object.provided </span><span class="s3">is </span><span class="s1">ifoo)</span>
        <span class="s1">self.assertEqual(event.object.required</span><span class="s3">, </span><span class="s1">(ibar</span><span class="s3">,</span><span class="s1">))</span>
        <span class="s1">self.assertEqual(event.object.name</span><span class="s3">, </span><span class="s4">''</span><span class="s1">)</span>
        <span class="s1">self.assertEqual(event.object.info</span><span class="s3">, </span><span class="s4">''</span><span class="s1">)</span>
        <span class="s1">self.assertTrue(event.object.factory </span><span class="s3">is </span><span class="s1">_Factory)</span>

    <span class="s3">def </span><span class="s1">test_unregisterSubscriptionAdapter_wo_explicit_provided(self):</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">InterfaceClass</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">implementer</span>
        <span class="s3">from </span><span class="s1">zope.interface.interfaces </span><span class="s3">import </span><span class="s1">Unregistered</span>
        <span class="s3">from </span><span class="s1">zope.interface.registry </span><span class="s3">import </span><span class="s1">SubscriptionRegistration</span>
        <span class="s3">class </span><span class="s1">IFoo(InterfaceClass):</span>
            <span class="s3">pass</span>
        <span class="s1">ifoo = IFoo(</span><span class="s4">'IFoo'</span><span class="s1">)</span>
        <span class="s1">ibar = IFoo(</span><span class="s4">'IBar'</span><span class="s1">)</span>
        <span class="s1">@implementer(ifoo)</span>
        <span class="s3">class </span><span class="s1">_Factory(object):</span>
            <span class="s3">pass</span>

        <span class="s1">comp = self._makeOne()</span>
        <span class="s1">comp.registerSubscriptionAdapter(_Factory</span><span class="s3">, </span><span class="s1">(ibar</span><span class="s3">,</span><span class="s1">)</span><span class="s3">, </span><span class="s1">ifoo)</span>
        <span class="s1">_monkey</span><span class="s3">, </span><span class="s1">_events = self._wrapEvents()</span>
        <span class="s3">with </span><span class="s1">_monkey:</span>
            <span class="s1">unreg = comp.unregisterSubscriptionAdapter(_Factory</span><span class="s3">, </span><span class="s1">(ibar</span><span class="s3">,</span><span class="s1">))</span>
        <span class="s1">self.assertTrue(unreg)</span>
        <span class="s1">self.assertEqual(len(_events)</span><span class="s3">, </span><span class="s5">1</span><span class="s1">)</span>
        <span class="s1">args</span><span class="s3">, </span><span class="s1">kw = _events[</span><span class="s5">0</span><span class="s1">]</span>
        <span class="s1">event</span><span class="s3">, </span><span class="s1">= args</span>
        <span class="s1">self.assertEqual(kw</span><span class="s3">, </span><span class="s1">{})</span>
        <span class="s1">self.assertTrue(isinstance(event</span><span class="s3">, </span><span class="s1">Unregistered))</span>
        <span class="s1">self.assertTrue(isinstance(event.object</span><span class="s3">, </span><span class="s1">SubscriptionRegistration))</span>
        <span class="s1">self.assertTrue(event.object.registry </span><span class="s3">is </span><span class="s1">comp)</span>
        <span class="s1">self.assertTrue(event.object.provided </span><span class="s3">is </span><span class="s1">ifoo)</span>
        <span class="s1">self.assertEqual(event.object.required</span><span class="s3">, </span><span class="s1">(ibar</span><span class="s3">,</span><span class="s1">))</span>
        <span class="s1">self.assertEqual(event.object.name</span><span class="s3">, </span><span class="s4">''</span><span class="s1">)</span>
        <span class="s1">self.assertEqual(event.object.info</span><span class="s3">, </span><span class="s4">''</span><span class="s1">)</span>
        <span class="s1">self.assertTrue(event.object.factory </span><span class="s3">is </span><span class="s1">_Factory)</span>

    <span class="s3">def </span><span class="s1">test_unregisterSubscriptionAdapter_wo_explicit_required(self):</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">InterfaceClass</span>
        <span class="s3">from </span><span class="s1">zope.interface.interfaces </span><span class="s3">import </span><span class="s1">Unregistered</span>
        <span class="s3">from </span><span class="s1">zope.interface.registry </span><span class="s3">import </span><span class="s1">SubscriptionRegistration</span>
        <span class="s3">class </span><span class="s1">IFoo(InterfaceClass):</span>
            <span class="s3">pass</span>
        <span class="s1">ifoo = IFoo(</span><span class="s4">'IFoo'</span><span class="s1">)</span>
        <span class="s1">ibar = IFoo(</span><span class="s4">'IBar'</span><span class="s1">)</span>
        <span class="s3">class </span><span class="s1">_Factory(object):</span>
            <span class="s1">__component_adapts__ = (ibar</span><span class="s3">,</span><span class="s1">)</span>

        <span class="s1">comp = self._makeOne()</span>
        <span class="s1">comp.registerSubscriptionAdapter(_Factory</span><span class="s3">, </span><span class="s1">(ibar</span><span class="s3">,</span><span class="s1">)</span><span class="s3">, </span><span class="s1">ifoo)</span>
        <span class="s1">_monkey</span><span class="s3">, </span><span class="s1">_events = self._wrapEvents()</span>
        <span class="s3">with </span><span class="s1">_monkey:</span>
            <span class="s1">unreg = comp.unregisterSubscriptionAdapter(_Factory</span><span class="s3">, </span><span class="s1">provided=ifoo)</span>
        <span class="s1">self.assertTrue(unreg)</span>
        <span class="s1">self.assertEqual(len(_events)</span><span class="s3">, </span><span class="s5">1</span><span class="s1">)</span>
        <span class="s1">args</span><span class="s3">, </span><span class="s1">kw = _events[</span><span class="s5">0</span><span class="s1">]</span>
        <span class="s1">event</span><span class="s3">, </span><span class="s1">= args</span>
        <span class="s1">self.assertEqual(kw</span><span class="s3">, </span><span class="s1">{})</span>
        <span class="s1">self.assertTrue(isinstance(event</span><span class="s3">, </span><span class="s1">Unregistered))</span>
        <span class="s1">self.assertTrue(isinstance(event.object</span><span class="s3">, </span><span class="s1">SubscriptionRegistration))</span>
        <span class="s1">self.assertTrue(event.object.registry </span><span class="s3">is </span><span class="s1">comp)</span>
        <span class="s1">self.assertTrue(event.object.provided </span><span class="s3">is </span><span class="s1">ifoo)</span>
        <span class="s1">self.assertEqual(event.object.required</span><span class="s3">, </span><span class="s1">(ibar</span><span class="s3">,</span><span class="s1">))</span>
        <span class="s1">self.assertEqual(event.object.name</span><span class="s3">, </span><span class="s4">''</span><span class="s1">)</span>
        <span class="s1">self.assertEqual(event.object.info</span><span class="s3">, </span><span class="s4">''</span><span class="s1">)</span>
        <span class="s1">self.assertTrue(event.object.factory </span><span class="s3">is </span><span class="s1">_Factory)</span>

    <span class="s3">def </span><span class="s1">test_subscribers_empty(self):</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">InterfaceClass</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">implementer</span>
        <span class="s3">class </span><span class="s1">IFoo(InterfaceClass):</span>
            <span class="s3">pass</span>
        <span class="s1">ifoo = IFoo(</span><span class="s4">'IFoo'</span><span class="s1">)</span>
        <span class="s1">ibar = IFoo(</span><span class="s4">'IBar'</span><span class="s1">)</span>
        <span class="s1">comp = self._makeOne()</span>
        <span class="s1">@implementer(ibar)</span>
        <span class="s3">class </span><span class="s1">Bar(object):</span>
            <span class="s3">pass</span>
        <span class="s1">bar = Bar()</span>
        <span class="s1">self.assertEqual(list(comp.subscribers((bar</span><span class="s3">,</span><span class="s1">)</span><span class="s3">, </span><span class="s1">ifoo))</span><span class="s3">, </span><span class="s1">[])</span>

    <span class="s3">def </span><span class="s1">test_subscribers_non_empty(self):</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">InterfaceClass</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">implementer</span>
        <span class="s3">class </span><span class="s1">IFoo(InterfaceClass):</span>
            <span class="s3">pass</span>
        <span class="s1">ifoo = IFoo(</span><span class="s4">'IFoo'</span><span class="s1">)</span>
        <span class="s1">ibar = IFoo(</span><span class="s4">'IBar'</span><span class="s1">)</span>
        <span class="s3">class </span><span class="s1">_Factory(object):</span>
            <span class="s1">__component_adapts__ = (ibar</span><span class="s3">,</span><span class="s1">)</span>
            <span class="s3">def </span><span class="s1">__init__(self</span><span class="s3">, </span><span class="s1">context):</span>
                <span class="s1">self._context = context</span>
        <span class="s3">class </span><span class="s1">_Derived(_Factory):</span>
            <span class="s3">pass</span>
        <span class="s1">comp = self._makeOne()</span>
        <span class="s1">comp.registerSubscriptionAdapter(_Factory</span><span class="s3">, </span><span class="s1">(ibar</span><span class="s3">,</span><span class="s1">)</span><span class="s3">, </span><span class="s1">ifoo)</span>
        <span class="s1">comp.registerSubscriptionAdapter(_Derived</span><span class="s3">, </span><span class="s1">(ibar</span><span class="s3">,</span><span class="s1">)</span><span class="s3">, </span><span class="s1">ifoo)</span>
        <span class="s1">@implementer(ibar)</span>
        <span class="s3">class </span><span class="s1">Bar(object):</span>
            <span class="s3">pass</span>
        <span class="s1">bar = Bar()</span>
        <span class="s1">subscribers = comp.subscribers((bar</span><span class="s3">,</span><span class="s1">)</span><span class="s3">, </span><span class="s1">ifoo)</span>
        <span class="s3">def </span><span class="s1">_klassname(x):</span>
            <span class="s3">return </span><span class="s1">x.__class__.__name__</span>
        <span class="s1">subscribers = sorted(subscribers</span><span class="s3">, </span><span class="s1">key=_klassname)</span>
        <span class="s1">self.assertEqual(len(subscribers)</span><span class="s3">, </span><span class="s5">2</span><span class="s1">)</span>
        <span class="s1">self.assertTrue(isinstance(subscribers[</span><span class="s5">0</span><span class="s1">]</span><span class="s3">, </span><span class="s1">_Derived))</span>
        <span class="s1">self.assertTrue(isinstance(subscribers[</span><span class="s5">1</span><span class="s1">]</span><span class="s3">, </span><span class="s1">_Factory))</span>

    <span class="s3">def </span><span class="s1">test_registerHandler_w_nonblank_name(self):</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">InterfaceClass</span>

        <span class="s3">class </span><span class="s1">IFoo(InterfaceClass):</span>
            <span class="s3">pass</span>
        <span class="s1">ifoo = IFoo(</span><span class="s4">'IFoo'</span><span class="s1">)</span>
        <span class="s1">_nonblank = </span><span class="s4">u'nonblank'</span>
        <span class="s1">comp = self._makeOne()</span>
        <span class="s3">def </span><span class="s1">_factory(context):</span>
            <span class="s3">raise </span><span class="s1">NotImplementedError()</span>

        <span class="s1">self.assertRaises(TypeError</span><span class="s3">, </span><span class="s1">comp.registerHandler</span><span class="s3">, </span><span class="s1">_factory</span><span class="s3">,</span>
                          <span class="s1">required=ifoo</span><span class="s3">, </span><span class="s1">name=_nonblank)</span>

    <span class="s3">def </span><span class="s1">test_registerHandler_w_explicit_required(self):</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">InterfaceClass</span>
        <span class="s3">from </span><span class="s1">zope.interface.interfaces </span><span class="s3">import </span><span class="s1">Registered</span>
        <span class="s3">from </span><span class="s1">zope.interface.registry </span><span class="s3">import </span><span class="s1">HandlerRegistration</span>

        <span class="s3">class </span><span class="s1">IFoo(InterfaceClass):</span>
            <span class="s3">pass</span>
        <span class="s1">ifoo = IFoo(</span><span class="s4">'IFoo'</span><span class="s1">)</span>
        <span class="s1">_blank = </span><span class="s4">u''</span>
        <span class="s1">_info = </span><span class="s4">u'info'</span>
        <span class="s3">def </span><span class="s1">_factory(context):</span>
            <span class="s3">raise </span><span class="s1">NotImplementedError()</span>

        <span class="s1">comp = self._makeOne()</span>
        <span class="s1">_monkey</span><span class="s3">, </span><span class="s1">_events = self._wrapEvents()</span>
        <span class="s3">with </span><span class="s1">_monkey:</span>
            <span class="s1">comp.registerHandler(_factory</span><span class="s3">, </span><span class="s1">(ifoo</span><span class="s3">,</span><span class="s1">)</span><span class="s3">, </span><span class="s1">info=_info)</span>
        <span class="s1">reg = comp.adapters._subscribers[</span><span class="s5">1</span><span class="s1">][ifoo][</span><span class="s3">None</span><span class="s1">][_blank]</span>
        <span class="s1">self.assertEqual(len(reg)</span><span class="s3">, </span><span class="s5">1</span><span class="s1">)</span>
        <span class="s1">self.assertTrue(reg[</span><span class="s5">0</span><span class="s1">] </span><span class="s3">is </span><span class="s1">_factory)</span>
        <span class="s1">self.assertEqual(comp._handler_registrations</span><span class="s3">,</span>
                         <span class="s1">[((ifoo</span><span class="s3">,</span><span class="s1">)</span><span class="s3">, </span><span class="s1">_blank</span><span class="s3">, </span><span class="s1">_factory</span><span class="s3">, </span><span class="s1">_info)])</span>
        <span class="s1">self.assertEqual(len(_events)</span><span class="s3">, </span><span class="s5">1</span><span class="s1">)</span>
        <span class="s1">args</span><span class="s3">, </span><span class="s1">kw = _events[</span><span class="s5">0</span><span class="s1">]</span>
        <span class="s1">event</span><span class="s3">, </span><span class="s1">= args</span>
        <span class="s1">self.assertEqual(kw</span><span class="s3">, </span><span class="s1">{})</span>
        <span class="s1">self.assertTrue(isinstance(event</span><span class="s3">, </span><span class="s1">Registered))</span>
        <span class="s1">self.assertTrue(isinstance(event.object</span><span class="s3">, </span><span class="s1">HandlerRegistration))</span>
        <span class="s1">self.assertTrue(event.object.registry </span><span class="s3">is </span><span class="s1">comp)</span>
        <span class="s1">self.assertEqual(event.object.required</span><span class="s3">, </span><span class="s1">(ifoo</span><span class="s3">,</span><span class="s1">))</span>
        <span class="s1">self.assertEqual(event.object.name</span><span class="s3">, </span><span class="s1">_blank)</span>
        <span class="s1">self.assertTrue(event.object.info </span><span class="s3">is </span><span class="s1">_info)</span>
        <span class="s1">self.assertTrue(event.object.factory </span><span class="s3">is </span><span class="s1">_factory)</span>

    <span class="s3">def </span><span class="s1">test_registerHandler_wo_explicit_required_no_event(self):</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">InterfaceClass</span>

        <span class="s3">class </span><span class="s1">IFoo(InterfaceClass):</span>
            <span class="s3">pass</span>
        <span class="s1">ifoo = IFoo(</span><span class="s4">'IFoo'</span><span class="s1">)</span>
        <span class="s1">_info = </span><span class="s4">u'info'</span>
        <span class="s1">_blank = </span><span class="s4">u''</span>
        <span class="s3">class </span><span class="s1">_Factory(object):</span>
            <span class="s1">__component_adapts__ = (ifoo</span><span class="s3">,</span><span class="s1">)</span>
            <span class="s3">pass</span>

        <span class="s1">comp = self._makeOne()</span>
        <span class="s1">_monkey</span><span class="s3">, </span><span class="s1">_events = self._wrapEvents()</span>
        <span class="s3">with </span><span class="s1">_monkey:</span>
            <span class="s1">comp.registerHandler(_Factory</span><span class="s3">, </span><span class="s1">info=_info</span><span class="s3">, </span><span class="s1">event=</span><span class="s3">False</span><span class="s1">)</span>
        <span class="s1">reg = comp.adapters._subscribers[</span><span class="s5">1</span><span class="s1">][ifoo][</span><span class="s3">None</span><span class="s1">][_blank]</span>
        <span class="s1">self.assertEqual(len(reg)</span><span class="s3">, </span><span class="s5">1</span><span class="s1">)</span>
        <span class="s1">self.assertTrue(reg[</span><span class="s5">0</span><span class="s1">] </span><span class="s3">is </span><span class="s1">_Factory)</span>
        <span class="s1">self.assertEqual(comp._handler_registrations</span><span class="s3">,</span>
                         <span class="s1">[((ifoo</span><span class="s3">,</span><span class="s1">)</span><span class="s3">, </span><span class="s1">_blank</span><span class="s3">, </span><span class="s1">_Factory</span><span class="s3">, </span><span class="s1">_info)])</span>
        <span class="s1">self.assertEqual(len(_events)</span><span class="s3">, </span><span class="s5">0</span><span class="s1">)</span>

    <span class="s3">def </span><span class="s1">test_registeredHandlers_empty(self):</span>
        <span class="s1">comp = self._makeOne()</span>
        <span class="s1">self.assertFalse(list(comp.registeredHandlers()))</span>

    <span class="s3">def </span><span class="s1">test_registeredHandlers_non_empty(self):</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">InterfaceClass</span>
        <span class="s3">from </span><span class="s1">zope.interface.registry </span><span class="s3">import </span><span class="s1">HandlerRegistration</span>
        <span class="s3">class </span><span class="s1">IFoo(InterfaceClass):</span>
            <span class="s3">pass</span>
        <span class="s1">ifoo = IFoo(</span><span class="s4">'IFoo'</span><span class="s1">)</span>
        <span class="s3">def </span><span class="s1">_factory1(context):</span>
            <span class="s3">raise </span><span class="s1">NotImplementedError()</span>
        <span class="s3">def </span><span class="s1">_factory2(context):</span>
            <span class="s3">raise </span><span class="s1">NotImplementedError()</span>
        <span class="s1">comp = self._makeOne()</span>
        <span class="s1">comp.registerHandler(_factory1</span><span class="s3">, </span><span class="s1">(ifoo</span><span class="s3">,</span><span class="s1">))</span>
        <span class="s1">comp.registerHandler(_factory2</span><span class="s3">, </span><span class="s1">(ifoo</span><span class="s3">,</span><span class="s1">))</span>
        <span class="s3">def </span><span class="s1">_factory_name(x):</span>
            <span class="s3">return </span><span class="s1">x.factory.__code__.co_name</span>
        <span class="s1">subscribers = sorted(comp.registeredHandlers()</span><span class="s3">, </span><span class="s1">key=_factory_name)</span>
        <span class="s1">self.assertEqual(len(subscribers)</span><span class="s3">, </span><span class="s5">2</span><span class="s1">)</span>
        <span class="s1">self.assertTrue(isinstance(subscribers[</span><span class="s5">0</span><span class="s1">]</span><span class="s3">, </span><span class="s1">HandlerRegistration))</span>
        <span class="s1">self.assertEqual(subscribers[</span><span class="s5">0</span><span class="s1">].required</span><span class="s3">, </span><span class="s1">(ifoo</span><span class="s3">,</span><span class="s1">))</span>
        <span class="s1">self.assertEqual(subscribers[</span><span class="s5">0</span><span class="s1">].name</span><span class="s3">, </span><span class="s4">''</span><span class="s1">)</span>
        <span class="s1">self.assertEqual(subscribers[</span><span class="s5">0</span><span class="s1">].factory</span><span class="s3">, </span><span class="s1">_factory1)</span>
        <span class="s1">self.assertEqual(subscribers[</span><span class="s5">0</span><span class="s1">].info</span><span class="s3">, </span><span class="s4">''</span><span class="s1">)</span>
        <span class="s1">self.assertTrue(isinstance(subscribers[</span><span class="s5">1</span><span class="s1">]</span><span class="s3">, </span><span class="s1">HandlerRegistration))</span>
        <span class="s1">self.assertEqual(subscribers[</span><span class="s5">1</span><span class="s1">].required</span><span class="s3">, </span><span class="s1">(ifoo</span><span class="s3">,</span><span class="s1">))</span>
        <span class="s1">self.assertEqual(subscribers[</span><span class="s5">1</span><span class="s1">].name</span><span class="s3">, </span><span class="s4">''</span><span class="s1">)</span>
        <span class="s1">self.assertEqual(subscribers[</span><span class="s5">1</span><span class="s1">].factory</span><span class="s3">, </span><span class="s1">_factory2)</span>
        <span class="s1">self.assertEqual(subscribers[</span><span class="s5">1</span><span class="s1">].info</span><span class="s3">, </span><span class="s4">''</span><span class="s1">)</span>

    <span class="s3">def </span><span class="s1">test_unregisterHandler_w_nonblank_name(self):</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">InterfaceClass</span>

        <span class="s3">class </span><span class="s1">IFoo(InterfaceClass):</span>
            <span class="s3">pass</span>
        <span class="s1">ifoo = IFoo(</span><span class="s4">'IFoo'</span><span class="s1">)</span>
        <span class="s1">_nonblank = </span><span class="s4">u'nonblank'</span>
        <span class="s1">comp = self._makeOne()</span>
        <span class="s1">self.assertRaises(TypeError</span><span class="s3">, </span><span class="s1">comp.unregisterHandler</span><span class="s3">,</span>
                          <span class="s1">required=(ifoo</span><span class="s3">,</span><span class="s1">)</span><span class="s3">, </span><span class="s1">name=_nonblank)</span>

    <span class="s3">def </span><span class="s1">test_unregisterHandler_neither_factory_nor_required(self):</span>
        <span class="s1">comp = self._makeOne()</span>
        <span class="s1">self.assertRaises(TypeError</span><span class="s3">, </span><span class="s1">comp.unregisterHandler)</span>

    <span class="s3">def </span><span class="s1">test_unregisterHandler_miss(self):</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">InterfaceClass</span>
        <span class="s3">class </span><span class="s1">IFoo(InterfaceClass):</span>
            <span class="s3">pass</span>
        <span class="s1">ifoo = IFoo(</span><span class="s4">'IFoo'</span><span class="s1">)</span>
        <span class="s1">comp = self._makeOne()</span>
        <span class="s1">unreg = comp.unregisterHandler(required=(ifoo</span><span class="s3">,</span><span class="s1">))</span>
        <span class="s1">self.assertFalse(unreg)</span>

    <span class="s3">def </span><span class="s1">test_unregisterHandler_hit_w_factory_and_explicit_provided(self):</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">InterfaceClass</span>
        <span class="s3">from </span><span class="s1">zope.interface.interfaces </span><span class="s3">import </span><span class="s1">Unregistered</span>
        <span class="s3">from </span><span class="s1">zope.interface.registry </span><span class="s3">import </span><span class="s1">HandlerRegistration</span>
        <span class="s3">class </span><span class="s1">IFoo(InterfaceClass):</span>
            <span class="s3">pass</span>
        <span class="s1">ifoo = IFoo(</span><span class="s4">'IFoo'</span><span class="s1">)</span>
        <span class="s1">comp = self._makeOne()</span>
        <span class="s3">def </span><span class="s1">_factory(context):</span>
            <span class="s3">raise </span><span class="s1">NotImplementedError()</span>
        <span class="s1">comp = self._makeOne()</span>
        <span class="s1">comp.registerHandler(_factory</span><span class="s3">, </span><span class="s1">(ifoo</span><span class="s3">,</span><span class="s1">))</span>
        <span class="s1">_monkey</span><span class="s3">, </span><span class="s1">_events = self._wrapEvents()</span>
        <span class="s3">with </span><span class="s1">_monkey:</span>
            <span class="s1">unreg = comp.unregisterHandler(_factory</span><span class="s3">, </span><span class="s1">(ifoo</span><span class="s3">,</span><span class="s1">))</span>
        <span class="s1">self.assertTrue(unreg)</span>
        <span class="s1">self.assertEqual(len(_events)</span><span class="s3">, </span><span class="s5">1</span><span class="s1">)</span>
        <span class="s1">args</span><span class="s3">, </span><span class="s1">kw = _events[</span><span class="s5">0</span><span class="s1">]</span>
        <span class="s1">event</span><span class="s3">, </span><span class="s1">= args</span>
        <span class="s1">self.assertEqual(kw</span><span class="s3">, </span><span class="s1">{})</span>
        <span class="s1">self.assertTrue(isinstance(event</span><span class="s3">, </span><span class="s1">Unregistered))</span>
        <span class="s1">self.assertTrue(isinstance(event.object</span><span class="s3">, </span><span class="s1">HandlerRegistration))</span>
        <span class="s1">self.assertTrue(event.object.registry </span><span class="s3">is </span><span class="s1">comp)</span>
        <span class="s1">self.assertEqual(event.object.required</span><span class="s3">, </span><span class="s1">(ifoo</span><span class="s3">,</span><span class="s1">))</span>
        <span class="s1">self.assertEqual(event.object.name</span><span class="s3">, </span><span class="s4">''</span><span class="s1">)</span>
        <span class="s1">self.assertTrue(event.object.factory </span><span class="s3">is </span><span class="s1">_factory)</span>

    <span class="s3">def </span><span class="s1">test_unregisterHandler_hit_w_only_explicit_provided(self):</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">InterfaceClass</span>
        <span class="s3">from </span><span class="s1">zope.interface.interfaces </span><span class="s3">import </span><span class="s1">Unregistered</span>
        <span class="s3">from </span><span class="s1">zope.interface.registry </span><span class="s3">import </span><span class="s1">HandlerRegistration</span>
        <span class="s3">class </span><span class="s1">IFoo(InterfaceClass):</span>
            <span class="s3">pass</span>
        <span class="s1">ifoo = IFoo(</span><span class="s4">'IFoo'</span><span class="s1">)</span>
        <span class="s1">comp = self._makeOne()</span>
        <span class="s3">def </span><span class="s1">_factory(context):</span>
            <span class="s3">raise </span><span class="s1">NotImplementedError()</span>
        <span class="s1">comp = self._makeOne()</span>
        <span class="s1">comp.registerHandler(_factory</span><span class="s3">, </span><span class="s1">(ifoo</span><span class="s3">,</span><span class="s1">))</span>
        <span class="s1">_monkey</span><span class="s3">, </span><span class="s1">_events = self._wrapEvents()</span>
        <span class="s3">with </span><span class="s1">_monkey:</span>
            <span class="s1">unreg = comp.unregisterHandler(required=(ifoo</span><span class="s3">,</span><span class="s1">))</span>
        <span class="s1">self.assertTrue(unreg)</span>
        <span class="s1">self.assertEqual(len(_events)</span><span class="s3">, </span><span class="s5">1</span><span class="s1">)</span>
        <span class="s1">args</span><span class="s3">, </span><span class="s1">kw = _events[</span><span class="s5">0</span><span class="s1">]</span>
        <span class="s1">event</span><span class="s3">, </span><span class="s1">= args</span>
        <span class="s1">self.assertEqual(kw</span><span class="s3">, </span><span class="s1">{})</span>
        <span class="s1">self.assertTrue(isinstance(event</span><span class="s3">, </span><span class="s1">Unregistered))</span>
        <span class="s1">self.assertTrue(isinstance(event.object</span><span class="s3">, </span><span class="s1">HandlerRegistration))</span>
        <span class="s1">self.assertTrue(event.object.registry </span><span class="s3">is </span><span class="s1">comp)</span>
        <span class="s1">self.assertEqual(event.object.required</span><span class="s3">, </span><span class="s1">(ifoo</span><span class="s3">,</span><span class="s1">))</span>
        <span class="s1">self.assertEqual(event.object.name</span><span class="s3">, </span><span class="s4">''</span><span class="s1">)</span>
        <span class="s1">self.assertTrue(event.object.factory </span><span class="s3">is None</span><span class="s1">)</span>

    <span class="s3">def </span><span class="s1">test_unregisterHandler_wo_explicit_required(self):</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">InterfaceClass</span>
        <span class="s3">from </span><span class="s1">zope.interface.interfaces </span><span class="s3">import </span><span class="s1">Unregistered</span>
        <span class="s3">from </span><span class="s1">zope.interface.registry </span><span class="s3">import </span><span class="s1">HandlerRegistration</span>
        <span class="s3">class </span><span class="s1">IFoo(InterfaceClass):</span>
            <span class="s3">pass</span>
        <span class="s1">ifoo = IFoo(</span><span class="s4">'IFoo'</span><span class="s1">)</span>
        <span class="s3">class </span><span class="s1">_Factory(object):</span>
            <span class="s1">__component_adapts__ = (ifoo</span><span class="s3">,</span><span class="s1">)</span>

        <span class="s1">comp = self._makeOne()</span>
        <span class="s1">comp.registerHandler(_Factory)</span>
        <span class="s1">_monkey</span><span class="s3">, </span><span class="s1">_events = self._wrapEvents()</span>
        <span class="s3">with </span><span class="s1">_monkey:</span>
            <span class="s1">unreg = comp.unregisterHandler(_Factory)</span>
        <span class="s1">self.assertTrue(unreg)</span>
        <span class="s1">self.assertEqual(len(_events)</span><span class="s3">, </span><span class="s5">1</span><span class="s1">)</span>
        <span class="s1">args</span><span class="s3">, </span><span class="s1">kw = _events[</span><span class="s5">0</span><span class="s1">]</span>
        <span class="s1">event</span><span class="s3">, </span><span class="s1">= args</span>
        <span class="s1">self.assertEqual(kw</span><span class="s3">, </span><span class="s1">{})</span>
        <span class="s1">self.assertTrue(isinstance(event</span><span class="s3">, </span><span class="s1">Unregistered))</span>
        <span class="s1">self.assertTrue(isinstance(event.object</span><span class="s3">, </span><span class="s1">HandlerRegistration))</span>
        <span class="s1">self.assertTrue(event.object.registry </span><span class="s3">is </span><span class="s1">comp)</span>
        <span class="s1">self.assertEqual(event.object.required</span><span class="s3">, </span><span class="s1">(ifoo</span><span class="s3">,</span><span class="s1">))</span>
        <span class="s1">self.assertEqual(event.object.name</span><span class="s3">, </span><span class="s4">''</span><span class="s1">)</span>
        <span class="s1">self.assertEqual(event.object.info</span><span class="s3">, </span><span class="s4">''</span><span class="s1">)</span>
        <span class="s1">self.assertTrue(event.object.factory </span><span class="s3">is </span><span class="s1">_Factory)</span>

    <span class="s3">def </span><span class="s1">test_handle_empty(self):</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">InterfaceClass</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">implementer</span>
        <span class="s3">class </span><span class="s1">IFoo(InterfaceClass):</span>
            <span class="s3">pass</span>
        <span class="s1">ifoo = IFoo(</span><span class="s4">'IFoo'</span><span class="s1">)</span>
        <span class="s1">comp = self._makeOne()</span>
        <span class="s1">@implementer(ifoo)</span>
        <span class="s3">class </span><span class="s1">Bar(object):</span>
            <span class="s3">pass</span>
        <span class="s1">bar = Bar()</span>
        <span class="s1">comp.handle((bar</span><span class="s3">,</span><span class="s1">)) </span><span class="s0"># doesn't raise</span>

    <span class="s3">def </span><span class="s1">test_handle_non_empty(self):</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">InterfaceClass</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">implementer</span>
        <span class="s3">class </span><span class="s1">IFoo(InterfaceClass):</span>
            <span class="s3">pass</span>
        <span class="s1">ifoo = IFoo(</span><span class="s4">'IFoo'</span><span class="s1">)</span>
        <span class="s1">_called_1 = []</span>
        <span class="s3">def </span><span class="s1">_factory_1(context):</span>
                <span class="s1">_called_1.append(context)</span>
        <span class="s1">_called_2 = []</span>
        <span class="s3">def </span><span class="s1">_factory_2(context):</span>
                <span class="s1">_called_2.append(context)</span>
        <span class="s1">comp = self._makeOne()</span>
        <span class="s1">comp.registerHandler(_factory_1</span><span class="s3">, </span><span class="s1">(ifoo</span><span class="s3">,</span><span class="s1">))</span>
        <span class="s1">comp.registerHandler(_factory_2</span><span class="s3">, </span><span class="s1">(ifoo</span><span class="s3">,</span><span class="s1">))</span>
        <span class="s1">@implementer(ifoo)</span>
        <span class="s3">class </span><span class="s1">Bar(object):</span>
            <span class="s3">pass</span>
        <span class="s1">bar = Bar()</span>
        <span class="s1">comp.handle(bar)</span>
        <span class="s1">self.assertEqual(_called_1</span><span class="s3">, </span><span class="s1">[bar])</span>
        <span class="s1">self.assertEqual(_called_2</span><span class="s3">, </span><span class="s1">[bar])</span>

    <span class="s3">def </span><span class="s1">test_register_unregister_identical_objects_provided(self</span><span class="s3">, </span><span class="s1">identical=</span><span class="s3">True</span><span class="s1">):</span>
        <span class="s0"># https://github.com/zopefoundation/zope.interface/issues/227</span>
        <span class="s3">class </span><span class="s1">IFoo(Interface):</span>
            <span class="s3">pass</span>

        <span class="s1">comp = self._makeOne()</span>
        <span class="s1">first = object()</span>
        <span class="s1">second = first </span><span class="s3">if </span><span class="s1">identical </span><span class="s3">else </span><span class="s1">object()</span>

        <span class="s1">comp.registerUtility(first</span><span class="s3">, </span><span class="s1">provided=IFoo)</span>
        <span class="s1">comp.registerUtility(second</span><span class="s3">, </span><span class="s1">provided=IFoo</span><span class="s3">, </span><span class="s1">name=</span><span class="s4">'bar'</span><span class="s1">)</span>

        <span class="s1">self.assertEqual(len(comp.utilities._subscribers)</span><span class="s3">, </span><span class="s5">1</span><span class="s1">)</span>
        <span class="s1">self.assertEqual(comp.utilities._subscribers</span><span class="s3">, </span><span class="s1">[{</span>
            <span class="s1">IFoo: {</span><span class="s4">''</span><span class="s1">: (first</span><span class="s3">, </span><span class="s1">) </span><span class="s3">if </span><span class="s1">identical </span><span class="s3">else </span><span class="s1">(first</span><span class="s3">, </span><span class="s1">second)}</span>
        <span class="s1">}])</span>
        <span class="s1">self.assertEqual(comp.utilities._provided</span><span class="s3">, </span><span class="s1">{</span>
            <span class="s1">IFoo: </span><span class="s5">3 </span><span class="s3">if </span><span class="s1">identical </span><span class="s3">else </span><span class="s5">4</span>
        <span class="s1">})</span>

        <span class="s1">res = comp.unregisterUtility(first</span><span class="s3">, </span><span class="s1">provided=IFoo)</span>
        <span class="s1">self.assertTrue(res)</span>
        <span class="s1">res = comp.unregisterUtility(second</span><span class="s3">, </span><span class="s1">provided=IFoo</span><span class="s3">, </span><span class="s1">name=</span><span class="s4">'bar'</span><span class="s1">)</span>
        <span class="s1">self.assertTrue(res)</span>

        <span class="s1">self.assertEqual(comp.utilities._provided</span><span class="s3">, </span><span class="s1">{})</span>
        <span class="s1">self.assertEqual(len(comp.utilities._subscribers)</span><span class="s3">, </span><span class="s5">0</span><span class="s1">)</span>

    <span class="s3">def </span><span class="s1">test_register_unregister_nonequal_objects_provided(self):</span>
        <span class="s1">self.test_register_unregister_identical_objects_provided(identical=</span><span class="s3">False</span><span class="s1">)</span>

    <span class="s3">def </span><span class="s1">test_rebuildUtilityRegistryFromLocalCache(self):</span>
        <span class="s3">class </span><span class="s1">IFoo(Interface):</span>
            <span class="s2">&quot;Does nothing&quot;</span>

        <span class="s3">class </span><span class="s1">UtilityImplementingFoo(object):</span>
            <span class="s2">&quot;Does nothing&quot;</span>

        <span class="s1">comps = self._makeOne()</span>

        <span class="s3">for </span><span class="s1">i </span><span class="s3">in </span><span class="s1">range(</span><span class="s5">30</span><span class="s1">):</span>
            <span class="s1">comps.registerUtility(UtilityImplementingFoo()</span><span class="s3">, </span><span class="s1">IFoo</span><span class="s3">, </span><span class="s1">name=</span><span class="s4">u'%s' </span><span class="s1">% (i</span><span class="s3">,</span><span class="s1">))</span>

        <span class="s1">orig_generation = comps.utilities._generation</span>

        <span class="s1">orig_adapters = comps.utilities._adapters</span>
        <span class="s1">self.assertEqual(len(orig_adapters)</span><span class="s3">, </span><span class="s5">1</span><span class="s1">)</span>
        <span class="s1">self.assertEqual(len(orig_adapters[</span><span class="s5">0</span><span class="s1">])</span><span class="s3">, </span><span class="s5">1</span><span class="s1">)</span>
        <span class="s1">self.assertEqual(len(orig_adapters[</span><span class="s5">0</span><span class="s1">][IFoo])</span><span class="s3">, </span><span class="s5">30</span><span class="s1">)</span>

        <span class="s1">orig_subscribers = comps.utilities._subscribers</span>
        <span class="s1">self.assertEqual(len(orig_subscribers)</span><span class="s3">, </span><span class="s5">1</span><span class="s1">)</span>
        <span class="s1">self.assertEqual(len(orig_subscribers[</span><span class="s5">0</span><span class="s1">])</span><span class="s3">, </span><span class="s5">1</span><span class="s1">)</span>
        <span class="s1">self.assertEqual(len(orig_subscribers[</span><span class="s5">0</span><span class="s1">][IFoo])</span><span class="s3">, </span><span class="s5">1</span><span class="s1">)</span>
        <span class="s1">self.assertEqual(len(orig_subscribers[</span><span class="s5">0</span><span class="s1">][IFoo][</span><span class="s4">u''</span><span class="s1">])</span><span class="s3">, </span><span class="s5">30</span><span class="s1">)</span>

        <span class="s0"># Blow a bunch of them away, creating artificial corruption</span>
        <span class="s1">new_adapters = comps.utilities._adapters = type(orig_adapters)()</span>
        <span class="s1">new_adapters.append({})</span>
        <span class="s1">d = new_adapters[</span><span class="s5">0</span><span class="s1">][IFoo] = {}</span>
        <span class="s3">for </span><span class="s1">name </span><span class="s3">in </span><span class="s1">range(</span><span class="s5">10</span><span class="s1">):</span>
            <span class="s1">name = type(</span><span class="s4">u''</span><span class="s1">)(str(name))</span>
            <span class="s1">d[name] = orig_adapters[</span><span class="s5">0</span><span class="s1">][IFoo][name]</span>

        <span class="s1">self.assertNotEqual(orig_adapters</span><span class="s3">, </span><span class="s1">new_adapters)</span>

        <span class="s1">new_subscribers = comps.utilities._subscribers = type(orig_subscribers)()</span>
        <span class="s1">new_subscribers.append({})</span>
        <span class="s1">d = new_subscribers[</span><span class="s5">0</span><span class="s1">][IFoo] = {}</span>
        <span class="s1">d[</span><span class="s4">u''</span><span class="s1">] = ()</span>

        <span class="s3">for </span><span class="s1">name </span><span class="s3">in </span><span class="s1">range(</span><span class="s5">5</span><span class="s3">, </span><span class="s5">12</span><span class="s1">): </span><span class="s0"># 12 - 5 = 7</span>
            <span class="s1">name = type(</span><span class="s4">u''</span><span class="s1">)(str(name))</span>
            <span class="s1">comp = orig_adapters[</span><span class="s5">0</span><span class="s1">][IFoo][name]</span>
            <span class="s1">d[</span><span class="s4">u''</span><span class="s1">] += (comp</span><span class="s3">,</span><span class="s1">)</span>

        <span class="s0"># We can preflight (by default) and nothing changes</span>
        <span class="s1">rebuild_results_preflight = comps.rebuildUtilityRegistryFromLocalCache()</span>

        <span class="s1">self.assertEqual(comps.utilities._generation</span><span class="s3">, </span><span class="s1">orig_generation)</span>
        <span class="s1">self.assertEqual(rebuild_results_preflight</span><span class="s3">, </span><span class="s1">{</span>
            <span class="s4">'did_not_register'</span><span class="s1">: </span><span class="s5">10</span><span class="s3">,</span>
            <span class="s4">'needed_registered'</span><span class="s1">: </span><span class="s5">20</span><span class="s3">,</span>

            <span class="s4">'did_not_subscribe'</span><span class="s1">: </span><span class="s5">7</span><span class="s3">,</span>
            <span class="s4">'needed_subscribed'</span><span class="s1">: </span><span class="s5">23</span><span class="s3">,</span>
        <span class="s1">})</span>

        <span class="s0"># Now for real</span>
        <span class="s1">rebuild_results = comps.rebuildUtilityRegistryFromLocalCache(rebuild=</span><span class="s3">True</span><span class="s1">)</span>

        <span class="s0"># The generation only got incremented once</span>
        <span class="s1">self.assertEqual(comps.utilities._generation</span><span class="s3">, </span><span class="s1">orig_generation + </span><span class="s5">1</span><span class="s1">)</span>
        <span class="s0"># The result was the same</span>
        <span class="s1">self.assertEqual(rebuild_results_preflight</span><span class="s3">, </span><span class="s1">rebuild_results)</span>
        <span class="s1">self.assertEqual(new_adapters</span><span class="s3">, </span><span class="s1">orig_adapters)</span>
        <span class="s1">self.assertEqual(</span>
            <span class="s1">len(new_subscribers[</span><span class="s5">0</span><span class="s1">][IFoo][</span><span class="s4">u''</span><span class="s1">])</span><span class="s3">,</span>
            <span class="s1">len(orig_subscribers[</span><span class="s5">0</span><span class="s1">][IFoo][</span><span class="s4">u''</span><span class="s1">]))</span>

        <span class="s3">for </span><span class="s1">orig_subscriber </span><span class="s3">in </span><span class="s1">orig_subscribers[</span><span class="s5">0</span><span class="s1">][IFoo][</span><span class="s4">u''</span><span class="s1">]:</span>
            <span class="s1">self.assertIn(orig_subscriber</span><span class="s3">, </span><span class="s1">new_subscribers[</span><span class="s5">0</span><span class="s1">][IFoo][</span><span class="s4">u''</span><span class="s1">])</span>

        <span class="s0"># Preflighting, rebuilding again produce no changes.</span>
        <span class="s1">preflight_after = comps.rebuildUtilityRegistryFromLocalCache()</span>
        <span class="s1">self.assertEqual(preflight_after</span><span class="s3">, </span><span class="s1">{</span>
            <span class="s4">'did_not_register'</span><span class="s1">: </span><span class="s5">30</span><span class="s3">,</span>
            <span class="s4">'needed_registered'</span><span class="s1">: </span><span class="s5">0</span><span class="s3">,</span>

            <span class="s4">'did_not_subscribe'</span><span class="s1">: </span><span class="s5">30</span><span class="s3">,</span>
            <span class="s4">'needed_subscribed'</span><span class="s1">: </span><span class="s5">0</span><span class="s3">,</span>
        <span class="s1">})</span>

        <span class="s1">rebuild_after = comps.rebuildUtilityRegistryFromLocalCache(rebuild=</span><span class="s3">True</span><span class="s1">)</span>
        <span class="s1">self.assertEqual(rebuild_after</span><span class="s3">, </span><span class="s1">preflight_after)</span>
        <span class="s1">self.assertEqual(comps.utilities._generation</span><span class="s3">, </span><span class="s1">orig_generation + </span><span class="s5">1</span><span class="s1">)</span>


<span class="s3">class </span><span class="s1">UnhashableComponentsTests(ComponentsTests):</span>

    <span class="s3">def </span><span class="s1">_getTargetClass(self):</span>
        <span class="s0"># Mimic what pyramid does to create an unhashable</span>
        <span class="s0"># registry</span>
        <span class="s3">class </span><span class="s1">Components(super(UnhashableComponentsTests</span><span class="s3">, </span><span class="s1">self)._getTargetClass()</span><span class="s3">, </span><span class="s1">dict):</span>
            <span class="s3">pass</span>
        <span class="s3">return </span><span class="s1">Components</span>

<span class="s0"># Test _getUtilityProvided, _getAdapterProvided, _getAdapterRequired via their</span>
<span class="s0"># callers (Component.registerUtility, Component.registerAdapter).</span>


<span class="s3">class </span><span class="s1">UtilityRegistrationTests(unittest.TestCase):</span>

    <span class="s3">def </span><span class="s1">_getTargetClass(self):</span>
        <span class="s3">from </span><span class="s1">zope.interface.registry </span><span class="s3">import </span><span class="s1">UtilityRegistration</span>
        <span class="s3">return </span><span class="s1">UtilityRegistration</span>

    <span class="s3">def </span><span class="s1">_makeOne(self</span><span class="s3">, </span><span class="s1">component=</span><span class="s3">None, </span><span class="s1">factory=</span><span class="s3">None</span><span class="s1">):</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">InterfaceClass</span>

        <span class="s3">class </span><span class="s1">InterfaceClassSubclass(InterfaceClass):</span>
            <span class="s3">pass</span>

        <span class="s1">ifoo = InterfaceClassSubclass(</span><span class="s4">'IFoo'</span><span class="s1">)</span>
        <span class="s3">class </span><span class="s1">_Registry(object):</span>
            <span class="s3">def </span><span class="s1">__repr__(self):</span>
                <span class="s3">return </span><span class="s4">'_REGISTRY'</span>
        <span class="s1">registry = _Registry()</span>
        <span class="s1">name = </span><span class="s4">u'name'</span>
        <span class="s1">doc = </span><span class="s4">'DOCSTRING'</span>
        <span class="s1">klass = self._getTargetClass()</span>
        <span class="s3">return </span><span class="s1">(klass(registry</span><span class="s3">, </span><span class="s1">ifoo</span><span class="s3">, </span><span class="s1">name</span><span class="s3">, </span><span class="s1">component</span><span class="s3">, </span><span class="s1">doc</span><span class="s3">, </span><span class="s1">factory)</span><span class="s3">,</span>
                <span class="s1">registry</span><span class="s3">,</span>
                <span class="s1">name</span><span class="s3">,</span>
               <span class="s1">)</span>

    <span class="s3">def </span><span class="s1">test_class_conforms_to_IUtilityRegistration(self):</span>
        <span class="s3">from </span><span class="s1">zope.interface.verify </span><span class="s3">import </span><span class="s1">verifyClass</span>
        <span class="s3">from </span><span class="s1">zope.interface.interfaces </span><span class="s3">import </span><span class="s1">IUtilityRegistration</span>
        <span class="s1">verifyClass(IUtilityRegistration</span><span class="s3">, </span><span class="s1">self._getTargetClass())</span>

    <span class="s3">def </span><span class="s1">test_instance_conforms_to_IUtilityRegistration(self):</span>
        <span class="s3">from </span><span class="s1">zope.interface.verify </span><span class="s3">import </span><span class="s1">verifyObject</span>
        <span class="s3">from </span><span class="s1">zope.interface.interfaces </span><span class="s3">import </span><span class="s1">IUtilityRegistration</span>
        <span class="s1">ur</span><span class="s3">, </span><span class="s1">_</span><span class="s3">, </span><span class="s1">_ =  self._makeOne()</span>
        <span class="s1">verifyObject(IUtilityRegistration</span><span class="s3">, </span><span class="s1">ur)</span>

    <span class="s3">def </span><span class="s1">test___repr__(self):</span>
        <span class="s3">class </span><span class="s1">_Component(object):</span>
            <span class="s1">__name__ = </span><span class="s4">'TEST'</span>
        <span class="s1">_component = _Component()</span>
        <span class="s1">ur</span><span class="s3">, </span><span class="s1">_registry</span><span class="s3">, </span><span class="s1">_name = self._makeOne(_component)</span>
        <span class="s1">self.assertEqual(repr(ur)</span><span class="s3">,</span>
            <span class="s4">&quot;UtilityRegistration(_REGISTRY, IFoo, %r, TEST, None, 'DOCSTRING')&quot;</span>
                            <span class="s1">% (_name))</span>

    <span class="s3">def </span><span class="s1">test___repr___provided_wo_name(self):</span>
        <span class="s3">class </span><span class="s1">_Component(object):</span>
            <span class="s3">def </span><span class="s1">__repr__(self):</span>
                <span class="s3">return </span><span class="s4">'TEST'</span>
        <span class="s1">_component = _Component()</span>
        <span class="s1">ur</span><span class="s3">, </span><span class="s1">_registry</span><span class="s3">, </span><span class="s1">_name = self._makeOne(_component)</span>
        <span class="s1">ur.provided = object()</span>
        <span class="s1">self.assertEqual(repr(ur)</span><span class="s3">,</span>
            <span class="s4">&quot;UtilityRegistration(_REGISTRY, None, %r, TEST, None, 'DOCSTRING')&quot;</span>
                            <span class="s1">% (_name))</span>

    <span class="s3">def </span><span class="s1">test___repr___component_wo_name(self):</span>
        <span class="s3">class </span><span class="s1">_Component(object):</span>
            <span class="s3">def </span><span class="s1">__repr__(self):</span>
                <span class="s3">return </span><span class="s4">'TEST'</span>
        <span class="s1">_component = _Component()</span>
        <span class="s1">ur</span><span class="s3">, </span><span class="s1">_registry</span><span class="s3">, </span><span class="s1">_name = self._makeOne(_component)</span>
        <span class="s1">ur.provided = object()</span>
        <span class="s1">self.assertEqual(repr(ur)</span><span class="s3">,</span>
            <span class="s4">&quot;UtilityRegistration(_REGISTRY, None, %r, TEST, None, 'DOCSTRING')&quot;</span>
                            <span class="s1">% (_name))</span>

    <span class="s3">def </span><span class="s1">test___hash__(self):</span>
        <span class="s1">_component = object()</span>
        <span class="s1">ur</span><span class="s3">, </span><span class="s1">_registry</span><span class="s3">, </span><span class="s1">_name = self._makeOne(_component)</span>
        <span class="s1">self.assertEqual(ur.__hash__()</span><span class="s3">, </span><span class="s1">id(ur))</span>

    <span class="s3">def </span><span class="s1">test___eq___identity(self):</span>
        <span class="s1">_component = object()</span>
        <span class="s1">ur</span><span class="s3">, </span><span class="s1">_registry</span><span class="s3">, </span><span class="s1">_name = self._makeOne(_component)</span>
        <span class="s1">self.assertTrue(ur == ur)</span>

    <span class="s3">def </span><span class="s1">test___eq___hit(self):</span>
        <span class="s1">_component = object()</span>
        <span class="s1">ur</span><span class="s3">, </span><span class="s1">_registry</span><span class="s3">, </span><span class="s1">_name = self._makeOne(_component)</span>
        <span class="s1">ur2</span><span class="s3">, </span><span class="s1">_</span><span class="s3">, </span><span class="s1">_ = self._makeOne(_component)</span>
        <span class="s1">self.assertTrue(ur == ur2)</span>

    <span class="s3">def </span><span class="s1">test___eq___miss(self):</span>
        <span class="s1">_component = object()</span>
        <span class="s1">_component2 = object()</span>
        <span class="s1">ur</span><span class="s3">, </span><span class="s1">_registry</span><span class="s3">, </span><span class="s1">_name = self._makeOne(_component)</span>
        <span class="s1">ur2</span><span class="s3">, </span><span class="s1">_</span><span class="s3">, </span><span class="s1">_ = self._makeOne(_component2)</span>
        <span class="s1">self.assertFalse(ur == ur2)</span>

    <span class="s3">def </span><span class="s1">test___ne___identity(self):</span>
        <span class="s1">_component = object()</span>
        <span class="s1">ur</span><span class="s3">, </span><span class="s1">_registry</span><span class="s3">, </span><span class="s1">_name = self._makeOne(_component)</span>
        <span class="s1">self.assertFalse(ur != ur)</span>

    <span class="s3">def </span><span class="s1">test___ne___hit(self):</span>
        <span class="s1">_component = object()</span>
        <span class="s1">ur</span><span class="s3">, </span><span class="s1">_registry</span><span class="s3">, </span><span class="s1">_name = self._makeOne(_component)</span>
        <span class="s1">ur2</span><span class="s3">, </span><span class="s1">_</span><span class="s3">, </span><span class="s1">_ = self._makeOne(_component)</span>
        <span class="s1">self.assertFalse(ur != ur2)</span>

    <span class="s3">def </span><span class="s1">test___ne___miss(self):</span>
        <span class="s1">_component = object()</span>
        <span class="s1">_component2 = object()</span>
        <span class="s1">ur</span><span class="s3">, </span><span class="s1">_registry</span><span class="s3">, </span><span class="s1">_name = self._makeOne(_component)</span>
        <span class="s1">ur2</span><span class="s3">, </span><span class="s1">_</span><span class="s3">, </span><span class="s1">_ = self._makeOne(_component2)</span>
        <span class="s1">self.assertTrue(ur != ur2)</span>

    <span class="s3">def </span><span class="s1">test___lt___identity(self):</span>
        <span class="s1">_component = object()</span>
        <span class="s1">ur</span><span class="s3">, </span><span class="s1">_registry</span><span class="s3">, </span><span class="s1">_name = self._makeOne(_component)</span>
        <span class="s1">self.assertFalse(ur &lt; ur)</span>

    <span class="s3">def </span><span class="s1">test___lt___hit(self):</span>
        <span class="s1">_component = object()</span>
        <span class="s1">ur</span><span class="s3">, </span><span class="s1">_registry</span><span class="s3">, </span><span class="s1">_name = self._makeOne(_component)</span>
        <span class="s1">ur2</span><span class="s3">, </span><span class="s1">_</span><span class="s3">, </span><span class="s1">_ = self._makeOne(_component)</span>
        <span class="s1">self.assertFalse(ur &lt; ur2)</span>

    <span class="s3">def </span><span class="s1">test___lt___miss(self):</span>
        <span class="s1">_component = object()</span>
        <span class="s1">_component2 = object()</span>
        <span class="s1">ur</span><span class="s3">, </span><span class="s1">_registry</span><span class="s3">, </span><span class="s1">_name = self._makeOne(_component)</span>
        <span class="s1">ur2</span><span class="s3">, </span><span class="s1">_</span><span class="s3">, </span><span class="s1">_ = self._makeOne(_component2)</span>
        <span class="s1">ur2.name = _name + </span><span class="s4">'2'</span>
        <span class="s1">self.assertTrue(ur &lt; ur2)</span>

    <span class="s3">def </span><span class="s1">test___le___identity(self):</span>
        <span class="s1">_component = object()</span>
        <span class="s1">ur</span><span class="s3">, </span><span class="s1">_registry</span><span class="s3">, </span><span class="s1">_name = self._makeOne(_component)</span>
        <span class="s1">self.assertTrue(ur &lt;= ur)</span>

    <span class="s3">def </span><span class="s1">test___le___hit(self):</span>
        <span class="s1">_component = object()</span>
        <span class="s1">ur</span><span class="s3">, </span><span class="s1">_registry</span><span class="s3">, </span><span class="s1">_name = self._makeOne(_component)</span>
        <span class="s1">ur2</span><span class="s3">, </span><span class="s1">_</span><span class="s3">, </span><span class="s1">_ = self._makeOne(_component)</span>
        <span class="s1">self.assertTrue(ur &lt;= ur2)</span>

    <span class="s3">def </span><span class="s1">test___le___miss(self):</span>
        <span class="s1">_component = object()</span>
        <span class="s1">_component2 = object()</span>
        <span class="s1">ur</span><span class="s3">, </span><span class="s1">_registry</span><span class="s3">, </span><span class="s1">_name = self._makeOne(_component)</span>
        <span class="s1">ur2</span><span class="s3">, </span><span class="s1">_</span><span class="s3">, </span><span class="s1">_ = self._makeOne(_component2)</span>
        <span class="s1">ur2.name = _name + </span><span class="s4">'2'</span>
        <span class="s1">self.assertTrue(ur &lt;= ur2)</span>

    <span class="s3">def </span><span class="s1">test___gt___identity(self):</span>
        <span class="s1">_component = object()</span>
        <span class="s1">ur</span><span class="s3">, </span><span class="s1">_registry</span><span class="s3">, </span><span class="s1">_name = self._makeOne(_component)</span>
        <span class="s1">self.assertFalse(ur &gt; ur)</span>

    <span class="s3">def </span><span class="s1">test___gt___hit(self):</span>
        <span class="s1">_component = object()</span>
        <span class="s1">_component2 = object()</span>
        <span class="s1">ur</span><span class="s3">, </span><span class="s1">_registry</span><span class="s3">, </span><span class="s1">_name = self._makeOne(_component)</span>
        <span class="s1">ur2</span><span class="s3">, </span><span class="s1">_</span><span class="s3">, </span><span class="s1">_ = self._makeOne(_component2)</span>
        <span class="s1">ur2.name = _name + </span><span class="s4">'2'</span>
        <span class="s1">self.assertTrue(ur2 &gt; ur)</span>

    <span class="s3">def </span><span class="s1">test___gt___miss(self):</span>
        <span class="s1">_component = object()</span>
        <span class="s1">ur</span><span class="s3">, </span><span class="s1">_registry</span><span class="s3">, </span><span class="s1">_name = self._makeOne(_component)</span>
        <span class="s1">ur2</span><span class="s3">, </span><span class="s1">_</span><span class="s3">, </span><span class="s1">_ = self._makeOne(_component)</span>
        <span class="s1">self.assertFalse(ur2 &gt; ur)</span>

    <span class="s3">def </span><span class="s1">test___ge___identity(self):</span>
        <span class="s1">_component = object()</span>
        <span class="s1">ur</span><span class="s3">, </span><span class="s1">_registry</span><span class="s3">, </span><span class="s1">_name = self._makeOne(_component)</span>
        <span class="s1">self.assertTrue(ur &gt;= ur)</span>

    <span class="s3">def </span><span class="s1">test___ge___miss(self):</span>
        <span class="s1">_component = object()</span>
        <span class="s1">_component2 = object()</span>
        <span class="s1">ur</span><span class="s3">, </span><span class="s1">_registry</span><span class="s3">, </span><span class="s1">_name = self._makeOne(_component)</span>
        <span class="s1">ur2</span><span class="s3">, </span><span class="s1">_</span><span class="s3">, </span><span class="s1">_ = self._makeOne(_component2)</span>
        <span class="s1">ur2.name = _name + </span><span class="s4">'2'</span>
        <span class="s1">self.assertFalse(ur &gt;= ur2)</span>

    <span class="s3">def </span><span class="s1">test___ge___hit(self):</span>
        <span class="s1">_component = object()</span>
        <span class="s1">ur</span><span class="s3">, </span><span class="s1">_registry</span><span class="s3">, </span><span class="s1">_name = self._makeOne(_component)</span>
        <span class="s1">ur2</span><span class="s3">, </span><span class="s1">_</span><span class="s3">, </span><span class="s1">_ = self._makeOne(_component)</span>
        <span class="s1">ur2.name = _name + </span><span class="s4">'2'</span>
        <span class="s1">self.assertTrue(ur2 &gt;= ur)</span>


<span class="s3">class </span><span class="s1">AdapterRegistrationTests(unittest.TestCase):</span>

    <span class="s3">def </span><span class="s1">_getTargetClass(self):</span>
        <span class="s3">from </span><span class="s1">zope.interface.registry </span><span class="s3">import </span><span class="s1">AdapterRegistration</span>
        <span class="s3">return </span><span class="s1">AdapterRegistration</span>

    <span class="s3">def </span><span class="s1">_makeOne(self</span><span class="s3">, </span><span class="s1">component=</span><span class="s3">None</span><span class="s1">):</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">InterfaceClass</span>

        <span class="s3">class </span><span class="s1">IFoo(InterfaceClass):</span>
            <span class="s3">pass</span>
        <span class="s1">ifoo = IFoo(</span><span class="s4">'IFoo'</span><span class="s1">)</span>
        <span class="s1">ibar = IFoo(</span><span class="s4">'IBar'</span><span class="s1">)</span>
        <span class="s3">class </span><span class="s1">_Registry(object):</span>
            <span class="s3">def </span><span class="s1">__repr__(self):</span>
                <span class="s3">return </span><span class="s4">'_REGISTRY'</span>
        <span class="s1">registry = _Registry()</span>
        <span class="s1">name = </span><span class="s4">u'name'</span>
        <span class="s1">doc = </span><span class="s4">'DOCSTRING'</span>
        <span class="s1">klass = self._getTargetClass()</span>
        <span class="s3">return </span><span class="s1">(klass(registry</span><span class="s3">, </span><span class="s1">(ibar</span><span class="s3">,</span><span class="s1">)</span><span class="s3">, </span><span class="s1">ifoo</span><span class="s3">, </span><span class="s1">name</span><span class="s3">, </span><span class="s1">component</span><span class="s3">, </span><span class="s1">doc)</span><span class="s3">,</span>
                <span class="s1">registry</span><span class="s3">,</span>
                <span class="s1">name</span><span class="s3">,</span>
               <span class="s1">)</span>

    <span class="s3">def </span><span class="s1">test_class_conforms_to_IAdapterRegistration(self):</span>
        <span class="s3">from </span><span class="s1">zope.interface.verify </span><span class="s3">import </span><span class="s1">verifyClass</span>
        <span class="s3">from </span><span class="s1">zope.interface.interfaces </span><span class="s3">import </span><span class="s1">IAdapterRegistration</span>
        <span class="s1">verifyClass(IAdapterRegistration</span><span class="s3">, </span><span class="s1">self._getTargetClass())</span>

    <span class="s3">def </span><span class="s1">test_instance_conforms_to_IAdapterRegistration(self):</span>
        <span class="s3">from </span><span class="s1">zope.interface.verify </span><span class="s3">import </span><span class="s1">verifyObject</span>
        <span class="s3">from </span><span class="s1">zope.interface.interfaces </span><span class="s3">import </span><span class="s1">IAdapterRegistration</span>
        <span class="s1">ar</span><span class="s3">, </span><span class="s1">_</span><span class="s3">, </span><span class="s1">_ =  self._makeOne()</span>
        <span class="s1">verifyObject(IAdapterRegistration</span><span class="s3">, </span><span class="s1">ar)</span>

    <span class="s3">def </span><span class="s1">test___repr__(self):</span>
        <span class="s3">class </span><span class="s1">_Component(object):</span>
            <span class="s1">__name__ = </span><span class="s4">'TEST'</span>
        <span class="s1">_component = _Component()</span>
        <span class="s1">ar</span><span class="s3">, </span><span class="s1">_registry</span><span class="s3">, </span><span class="s1">_name = self._makeOne(_component)</span>
        <span class="s1">self.assertEqual(repr(ar)</span><span class="s3">,</span>
            <span class="s1">(</span><span class="s4">&quot;AdapterRegistration(_REGISTRY, [IBar], IFoo, %r, TEST, &quot;</span>
           <span class="s1">+ </span><span class="s4">&quot;'DOCSTRING')&quot;</span><span class="s1">) % (_name))</span>

    <span class="s3">def </span><span class="s1">test___repr___provided_wo_name(self):</span>
        <span class="s3">class </span><span class="s1">_Component(object):</span>
            <span class="s3">def </span><span class="s1">__repr__(self):</span>
                <span class="s3">return </span><span class="s4">'TEST'</span>
        <span class="s1">_component = _Component()</span>
        <span class="s1">ar</span><span class="s3">, </span><span class="s1">_registry</span><span class="s3">, </span><span class="s1">_name = self._makeOne(_component)</span>
        <span class="s1">ar.provided = object()</span>
        <span class="s1">self.assertEqual(repr(ar)</span><span class="s3">,</span>
            <span class="s1">(</span><span class="s4">&quot;AdapterRegistration(_REGISTRY, [IBar], None, %r, TEST, &quot;</span>
           <span class="s1">+ </span><span class="s4">&quot;'DOCSTRING')&quot;</span><span class="s1">) % (_name))</span>

    <span class="s3">def </span><span class="s1">test___repr___component_wo_name(self):</span>
        <span class="s3">class </span><span class="s1">_Component(object):</span>
            <span class="s3">def </span><span class="s1">__repr__(self):</span>
                <span class="s3">return </span><span class="s4">'TEST'</span>
        <span class="s1">_component = _Component()</span>
        <span class="s1">ar</span><span class="s3">, </span><span class="s1">_registry</span><span class="s3">, </span><span class="s1">_name = self._makeOne(_component)</span>
        <span class="s1">ar.provided = object()</span>
        <span class="s1">self.assertEqual(repr(ar)</span><span class="s3">,</span>
            <span class="s1">(</span><span class="s4">&quot;AdapterRegistration(_REGISTRY, [IBar], None, %r, TEST, &quot;</span>
           <span class="s1">+ </span><span class="s4">&quot;'DOCSTRING')&quot;</span><span class="s1">) % (_name))</span>

    <span class="s3">def </span><span class="s1">test___hash__(self):</span>
        <span class="s1">_component = object()</span>
        <span class="s1">ar</span><span class="s3">, </span><span class="s1">_registry</span><span class="s3">, </span><span class="s1">_name = self._makeOne(_component)</span>
        <span class="s1">self.assertEqual(ar.__hash__()</span><span class="s3">, </span><span class="s1">id(ar))</span>

    <span class="s3">def </span><span class="s1">test___eq___identity(self):</span>
        <span class="s1">_component = object()</span>
        <span class="s1">ar</span><span class="s3">, </span><span class="s1">_registry</span><span class="s3">, </span><span class="s1">_name = self._makeOne(_component)</span>
        <span class="s1">self.assertTrue(ar == ar)</span>

    <span class="s3">def </span><span class="s1">test___eq___hit(self):</span>
        <span class="s1">_component = object()</span>
        <span class="s1">ar</span><span class="s3">, </span><span class="s1">_registry</span><span class="s3">, </span><span class="s1">_name = self._makeOne(_component)</span>
        <span class="s1">ar2</span><span class="s3">, </span><span class="s1">_</span><span class="s3">, </span><span class="s1">_ = self._makeOne(_component)</span>
        <span class="s1">self.assertTrue(ar == ar2)</span>

    <span class="s3">def </span><span class="s1">test___eq___miss(self):</span>
        <span class="s1">_component = object()</span>
        <span class="s1">_component2 = object()</span>
        <span class="s1">ar</span><span class="s3">, </span><span class="s1">_registry</span><span class="s3">, </span><span class="s1">_name = self._makeOne(_component)</span>
        <span class="s1">ar2</span><span class="s3">, </span><span class="s1">_</span><span class="s3">, </span><span class="s1">_ = self._makeOne(_component2)</span>
        <span class="s1">self.assertFalse(ar == ar2)</span>

    <span class="s3">def </span><span class="s1">test___ne___identity(self):</span>
        <span class="s1">_component = object()</span>
        <span class="s1">ar</span><span class="s3">, </span><span class="s1">_registry</span><span class="s3">, </span><span class="s1">_name = self._makeOne(_component)</span>
        <span class="s1">self.assertFalse(ar != ar)</span>

    <span class="s3">def </span><span class="s1">test___ne___miss(self):</span>
        <span class="s1">_component = object()</span>
        <span class="s1">ar</span><span class="s3">, </span><span class="s1">_registry</span><span class="s3">, </span><span class="s1">_name = self._makeOne(_component)</span>
        <span class="s1">ar2</span><span class="s3">, </span><span class="s1">_</span><span class="s3">, </span><span class="s1">_ = self._makeOne(_component)</span>
        <span class="s1">self.assertFalse(ar != ar2)</span>

    <span class="s3">def </span><span class="s1">test___ne___hit_component(self):</span>
        <span class="s1">_component = object()</span>
        <span class="s1">_component2 = object()</span>
        <span class="s1">ar</span><span class="s3">, </span><span class="s1">_registry</span><span class="s3">, </span><span class="s1">_name = self._makeOne(_component)</span>
        <span class="s1">ar2</span><span class="s3">, </span><span class="s1">_</span><span class="s3">, </span><span class="s1">_ = self._makeOne(_component2)</span>
        <span class="s1">self.assertTrue(ar != ar2)</span>

    <span class="s3">def </span><span class="s1">test___ne___hit_provided(self):</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">InterfaceClass</span>
        <span class="s3">class </span><span class="s1">IFoo(InterfaceClass):</span>
            <span class="s3">pass</span>
        <span class="s1">ibaz = IFoo(</span><span class="s4">'IBaz'</span><span class="s1">)</span>
        <span class="s1">_component = object()</span>
        <span class="s1">ar</span><span class="s3">, </span><span class="s1">_registry</span><span class="s3">, </span><span class="s1">_name = self._makeOne(_component)</span>
        <span class="s1">ar2</span><span class="s3">, </span><span class="s1">_</span><span class="s3">, </span><span class="s1">_ = self._makeOne(_component)</span>
        <span class="s1">ar2.provided = ibaz</span>
        <span class="s1">self.assertTrue(ar != ar2)</span>

    <span class="s3">def </span><span class="s1">test___ne___hit_required(self):</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">InterfaceClass</span>
        <span class="s3">class </span><span class="s1">IFoo(InterfaceClass):</span>
            <span class="s3">pass</span>
        <span class="s1">ibaz = IFoo(</span><span class="s4">'IBaz'</span><span class="s1">)</span>
        <span class="s1">_component = object()</span>
        <span class="s1">_component2 = object()</span>
        <span class="s1">ar</span><span class="s3">, </span><span class="s1">_registry</span><span class="s3">, </span><span class="s1">_name = self._makeOne(_component)</span>
        <span class="s1">ar2</span><span class="s3">, </span><span class="s1">_</span><span class="s3">, </span><span class="s1">_ = self._makeOne(_component2)</span>
        <span class="s1">ar2.required = (ibaz</span><span class="s3">,</span><span class="s1">)</span>
        <span class="s1">self.assertTrue(ar != ar2)</span>

    <span class="s3">def </span><span class="s1">test___lt___identity(self):</span>
        <span class="s1">_component = object()</span>
        <span class="s1">ar</span><span class="s3">, </span><span class="s1">_registry</span><span class="s3">, </span><span class="s1">_name = self._makeOne(_component)</span>
        <span class="s1">self.assertFalse(ar &lt; ar)</span>

    <span class="s3">def </span><span class="s1">test___lt___hit(self):</span>
        <span class="s1">_component = object()</span>
        <span class="s1">ar</span><span class="s3">, </span><span class="s1">_registry</span><span class="s3">, </span><span class="s1">_name = self._makeOne(_component)</span>
        <span class="s1">ar2</span><span class="s3">, </span><span class="s1">_</span><span class="s3">, </span><span class="s1">_ = self._makeOne(_component)</span>
        <span class="s1">self.assertFalse(ar &lt; ar2)</span>

    <span class="s3">def </span><span class="s1">test___lt___miss(self):</span>
        <span class="s1">_component = object()</span>
        <span class="s1">_component2 = object()</span>
        <span class="s1">ar</span><span class="s3">, </span><span class="s1">_registry</span><span class="s3">, </span><span class="s1">_name = self._makeOne(_component)</span>
        <span class="s1">ar2</span><span class="s3">, </span><span class="s1">_</span><span class="s3">, </span><span class="s1">_ = self._makeOne(_component2)</span>
        <span class="s1">ar2.name = _name + </span><span class="s4">'2'</span>
        <span class="s1">self.assertTrue(ar &lt; ar2)</span>

    <span class="s3">def </span><span class="s1">test___le___identity(self):</span>
        <span class="s1">_component = object()</span>
        <span class="s1">ar</span><span class="s3">, </span><span class="s1">_registry</span><span class="s3">, </span><span class="s1">_name = self._makeOne(_component)</span>
        <span class="s1">self.assertTrue(ar &lt;= ar)</span>

    <span class="s3">def </span><span class="s1">test___le___hit(self):</span>
        <span class="s1">_component = object()</span>
        <span class="s1">ar</span><span class="s3">, </span><span class="s1">_registry</span><span class="s3">, </span><span class="s1">_name = self._makeOne(_component)</span>
        <span class="s1">ar2</span><span class="s3">, </span><span class="s1">_</span><span class="s3">, </span><span class="s1">_ = self._makeOne(_component)</span>
        <span class="s1">self.assertTrue(ar &lt;= ar2)</span>

    <span class="s3">def </span><span class="s1">test___le___miss(self):</span>
        <span class="s1">_component = object()</span>
        <span class="s1">_component2 = object()</span>
        <span class="s1">ar</span><span class="s3">, </span><span class="s1">_registry</span><span class="s3">, </span><span class="s1">_name = self._makeOne(_component)</span>
        <span class="s1">ar2</span><span class="s3">, </span><span class="s1">_</span><span class="s3">, </span><span class="s1">_ = self._makeOne(_component2)</span>
        <span class="s1">ar2.name = _name + </span><span class="s4">'2'</span>
        <span class="s1">self.assertTrue(ar &lt;= ar2)</span>

    <span class="s3">def </span><span class="s1">test___gt___identity(self):</span>
        <span class="s1">_component = object()</span>
        <span class="s1">ar</span><span class="s3">, </span><span class="s1">_registry</span><span class="s3">, </span><span class="s1">_name = self._makeOne(_component)</span>
        <span class="s1">self.assertFalse(ar &gt; ar)</span>

    <span class="s3">def </span><span class="s1">test___gt___hit(self):</span>
        <span class="s1">_component = object()</span>
        <span class="s1">_component2 = object()</span>
        <span class="s1">ar</span><span class="s3">, </span><span class="s1">_registry</span><span class="s3">, </span><span class="s1">_name = self._makeOne(_component)</span>
        <span class="s1">ar2</span><span class="s3">, </span><span class="s1">_</span><span class="s3">, </span><span class="s1">_ = self._makeOne(_component2)</span>
        <span class="s1">ar2.name = _name + </span><span class="s4">'2'</span>
        <span class="s1">self.assertTrue(ar2 &gt; ar)</span>

    <span class="s3">def </span><span class="s1">test___gt___miss(self):</span>
        <span class="s1">_component = object()</span>
        <span class="s1">ar</span><span class="s3">, </span><span class="s1">_registry</span><span class="s3">, </span><span class="s1">_name = self._makeOne(_component)</span>
        <span class="s1">ar2</span><span class="s3">, </span><span class="s1">_</span><span class="s3">, </span><span class="s1">_ = self._makeOne(_component)</span>
        <span class="s1">self.assertFalse(ar2 &gt; ar)</span>

    <span class="s3">def </span><span class="s1">test___ge___identity(self):</span>
        <span class="s1">_component = object()</span>
        <span class="s1">ar</span><span class="s3">, </span><span class="s1">_registry</span><span class="s3">, </span><span class="s1">_name = self._makeOne(_component)</span>
        <span class="s1">self.assertTrue(ar &gt;= ar)</span>

    <span class="s3">def </span><span class="s1">test___ge___miss(self):</span>
        <span class="s1">_component = object()</span>
        <span class="s1">_component2 = object()</span>
        <span class="s1">ar</span><span class="s3">, </span><span class="s1">_registry</span><span class="s3">, </span><span class="s1">_name = self._makeOne(_component)</span>
        <span class="s1">ar2</span><span class="s3">, </span><span class="s1">_</span><span class="s3">, </span><span class="s1">_ = self._makeOne(_component2)</span>
        <span class="s1">ar2.name = _name + </span><span class="s4">'2'</span>
        <span class="s1">self.assertFalse(ar &gt;= ar2)</span>

    <span class="s3">def </span><span class="s1">test___ge___hit(self):</span>
        <span class="s1">_component = object()</span>
        <span class="s1">ar</span><span class="s3">, </span><span class="s1">_registry</span><span class="s3">, </span><span class="s1">_name = self._makeOne(_component)</span>
        <span class="s1">ar2</span><span class="s3">, </span><span class="s1">_</span><span class="s3">, </span><span class="s1">_ = self._makeOne(_component)</span>
        <span class="s1">ar2.name = _name + </span><span class="s4">'2'</span>
        <span class="s1">self.assertTrue(ar2 &gt;= ar)</span>


<span class="s3">class </span><span class="s1">SubscriptionRegistrationTests(unittest.TestCase):</span>

    <span class="s3">def </span><span class="s1">_getTargetClass(self):</span>
        <span class="s3">from </span><span class="s1">zope.interface.registry </span><span class="s3">import </span><span class="s1">SubscriptionRegistration</span>
        <span class="s3">return </span><span class="s1">SubscriptionRegistration</span>

    <span class="s3">def </span><span class="s1">_makeOne(self</span><span class="s3">, </span><span class="s1">component=</span><span class="s3">None</span><span class="s1">):</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">InterfaceClass</span>

        <span class="s3">class </span><span class="s1">IFoo(InterfaceClass):</span>
            <span class="s3">pass</span>
        <span class="s1">ifoo = IFoo(</span><span class="s4">'IFoo'</span><span class="s1">)</span>
        <span class="s1">ibar = IFoo(</span><span class="s4">'IBar'</span><span class="s1">)</span>
        <span class="s3">class </span><span class="s1">_Registry(object):</span>
            <span class="s3">def </span><span class="s1">__repr__(self): </span><span class="s0"># pragma: no cover</span>
                <span class="s3">return </span><span class="s4">'_REGISTRY'</span>
        <span class="s1">registry = _Registry()</span>
        <span class="s1">name = </span><span class="s4">u'name'</span>
        <span class="s1">doc = </span><span class="s4">'DOCSTRING'</span>
        <span class="s1">klass = self._getTargetClass()</span>
        <span class="s3">return </span><span class="s1">(klass(registry</span><span class="s3">, </span><span class="s1">(ibar</span><span class="s3">,</span><span class="s1">)</span><span class="s3">, </span><span class="s1">ifoo</span><span class="s3">, </span><span class="s1">name</span><span class="s3">, </span><span class="s1">component</span><span class="s3">, </span><span class="s1">doc)</span><span class="s3">,</span>
                <span class="s1">registry</span><span class="s3">,</span>
                <span class="s1">name</span><span class="s3">,</span>
               <span class="s1">)</span>

    <span class="s3">def </span><span class="s1">test_class_conforms_to_ISubscriptionAdapterRegistration(self):</span>
        <span class="s3">from </span><span class="s1">zope.interface.verify </span><span class="s3">import </span><span class="s1">verifyClass</span>
        <span class="s3">from </span><span class="s1">zope.interface.interfaces </span><span class="s3">import </span><span class="s1">ISubscriptionAdapterRegistration</span>
        <span class="s1">verifyClass(ISubscriptionAdapterRegistration</span><span class="s3">, </span><span class="s1">self._getTargetClass())</span>

    <span class="s3">def </span><span class="s1">test_instance_conforms_to_ISubscriptionAdapterRegistration(self):</span>
        <span class="s3">from </span><span class="s1">zope.interface.verify </span><span class="s3">import </span><span class="s1">verifyObject</span>
        <span class="s3">from </span><span class="s1">zope.interface.interfaces </span><span class="s3">import </span><span class="s1">ISubscriptionAdapterRegistration</span>
        <span class="s1">sar</span><span class="s3">, </span><span class="s1">_</span><span class="s3">, </span><span class="s1">_ =  self._makeOne()</span>
        <span class="s1">verifyObject(ISubscriptionAdapterRegistration</span><span class="s3">, </span><span class="s1">sar)</span>


<span class="s3">class </span><span class="s1">HandlerRegistrationTests(unittest.TestCase):</span>

    <span class="s3">def </span><span class="s1">_getTargetClass(self):</span>
        <span class="s3">from </span><span class="s1">zope.interface.registry </span><span class="s3">import </span><span class="s1">HandlerRegistration</span>
        <span class="s3">return </span><span class="s1">HandlerRegistration</span>

    <span class="s3">def </span><span class="s1">_makeOne(self</span><span class="s3">, </span><span class="s1">component=</span><span class="s3">None</span><span class="s1">):</span>
        <span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">InterfaceClass</span>

        <span class="s3">class </span><span class="s1">IFoo(InterfaceClass):</span>
            <span class="s3">pass</span>
        <span class="s1">ifoo = IFoo(</span><span class="s4">'IFoo'</span><span class="s1">)</span>
        <span class="s3">class </span><span class="s1">_Registry(object):</span>
            <span class="s3">def </span><span class="s1">__repr__(self):</span>
                <span class="s3">return </span><span class="s4">'_REGISTRY'</span>
        <span class="s1">registry = _Registry()</span>
        <span class="s1">name = </span><span class="s4">u'name'</span>
        <span class="s1">doc = </span><span class="s4">'DOCSTRING'</span>
        <span class="s1">klass = self._getTargetClass()</span>
        <span class="s3">return </span><span class="s1">(klass(registry</span><span class="s3">, </span><span class="s1">(ifoo</span><span class="s3">,</span><span class="s1">)</span><span class="s3">, </span><span class="s1">name</span><span class="s3">, </span><span class="s1">component</span><span class="s3">, </span><span class="s1">doc)</span><span class="s3">,</span>
                <span class="s1">registry</span><span class="s3">,</span>
                <span class="s1">name</span><span class="s3">,</span>
               <span class="s1">)</span>

    <span class="s3">def </span><span class="s1">test_class_conforms_to_IHandlerRegistration(self):</span>
        <span class="s3">from </span><span class="s1">zope.interface.verify </span><span class="s3">import </span><span class="s1">verifyClass</span>
        <span class="s3">from </span><span class="s1">zope.interface.interfaces </span><span class="s3">import </span><span class="s1">IHandlerRegistration</span>
        <span class="s1">verifyClass(IHandlerRegistration</span><span class="s3">, </span><span class="s1">self._getTargetClass())</span>

    <span class="s3">def </span><span class="s1">test_instance_conforms_to_IHandlerRegistration(self):</span>
        <span class="s3">from </span><span class="s1">zope.interface.verify </span><span class="s3">import </span><span class="s1">verifyObject</span>
        <span class="s3">from </span><span class="s1">zope.interface.interfaces </span><span class="s3">import </span><span class="s1">IHandlerRegistration</span>
        <span class="s1">hr</span><span class="s3">, </span><span class="s1">_</span><span class="s3">, </span><span class="s1">_ =  self._makeOne()</span>
        <span class="s1">verifyObject(IHandlerRegistration</span><span class="s3">, </span><span class="s1">hr)</span>

    <span class="s3">def </span><span class="s1">test_properties(self):</span>
        <span class="s3">def </span><span class="s1">_factory(context):</span>
            <span class="s3">raise </span><span class="s1">NotImplementedError()</span>
        <span class="s1">hr</span><span class="s3">, </span><span class="s1">_</span><span class="s3">, </span><span class="s1">_ =  self._makeOne(_factory)</span>
        <span class="s1">self.assertTrue(hr.handler </span><span class="s3">is </span><span class="s1">_factory)</span>
        <span class="s1">self.assertTrue(hr.factory </span><span class="s3">is </span><span class="s1">hr.handler)</span>
        <span class="s1">self.assertTrue(hr.provided </span><span class="s3">is None</span><span class="s1">)</span>

    <span class="s3">def </span><span class="s1">test___repr___factory_w_name(self):</span>
        <span class="s3">class </span><span class="s1">_Factory(object):</span>
            <span class="s1">__name__ = </span><span class="s4">'TEST'</span>
        <span class="s1">hr</span><span class="s3">, </span><span class="s1">_registry</span><span class="s3">, </span><span class="s1">_name =  self._makeOne(_Factory())</span>
        <span class="s1">self.assertEqual(repr(hr)</span><span class="s3">,</span>
            <span class="s1">(</span><span class="s4">&quot;HandlerRegistration(_REGISTRY, [IFoo], %r, TEST, &quot;</span>
           <span class="s1">+ </span><span class="s4">&quot;'DOCSTRING')&quot;</span><span class="s1">) % (_name))</span>

    <span class="s3">def </span><span class="s1">test___repr___factory_wo_name(self):</span>
        <span class="s3">class </span><span class="s1">_Factory(object):</span>
            <span class="s3">def </span><span class="s1">__repr__(self):</span>
                <span class="s3">return </span><span class="s4">'TEST'</span>
        <span class="s1">hr</span><span class="s3">, </span><span class="s1">_registry</span><span class="s3">, </span><span class="s1">_name =  self._makeOne(_Factory())</span>
        <span class="s1">self.assertEqual(repr(hr)</span><span class="s3">,</span>
            <span class="s1">(</span><span class="s4">&quot;HandlerRegistration(_REGISTRY, [IFoo], %r, TEST, &quot;</span>
           <span class="s1">+ </span><span class="s4">&quot;'DOCSTRING')&quot;</span><span class="s1">) % (_name))</span>

<span class="s3">class </span><span class="s1">PersistentAdapterRegistry(VerifyingAdapterRegistry):</span>

    <span class="s3">def </span><span class="s1">__getstate__(self):</span>
        <span class="s1">state = self.__dict__.copy()</span>
        <span class="s3">for </span><span class="s1">k </span><span class="s3">in </span><span class="s1">list(state):</span>
            <span class="s3">if </span><span class="s1">k </span><span class="s3">in </span><span class="s1">self._delegated </span><span class="s3">or </span><span class="s1">k.startswith(</span><span class="s4">'_v'</span><span class="s1">):</span>
                <span class="s1">state.pop(k)</span>
        <span class="s1">state.pop(</span><span class="s4">'ro'</span><span class="s3">, None</span><span class="s1">)</span>
        <span class="s3">return </span><span class="s1">state</span>

    <span class="s3">def </span><span class="s1">__setstate__(self</span><span class="s3">, </span><span class="s1">state):</span>
        <span class="s1">bases = state.pop(</span><span class="s4">'__bases__'</span><span class="s3">, </span><span class="s1">())</span>
        <span class="s1">self.__dict__.update(state)</span>
        <span class="s1">self._createLookup()</span>
        <span class="s1">self.__bases__ = bases</span>
        <span class="s1">self._v_lookup.changed(self)</span>

<span class="s3">class </span><span class="s1">PersistentComponents(Components):</span>
    <span class="s0"># Mimic zope.component.persistentregistry.PersistentComponents:</span>
    <span class="s0"># we should be picklalable, but not persistent.Persistent ourself.</span>

    <span class="s3">def </span><span class="s1">_init_registries(self):</span>
        <span class="s1">self.adapters = PersistentAdapterRegistry()</span>
        <span class="s1">self.utilities = PersistentAdapterRegistry()</span>

<span class="s3">class </span><span class="s1">PersistentDictComponents(PersistentComponents</span><span class="s3">, </span><span class="s1">dict):</span>
    <span class="s0"># Like Pyramid's Registry, we subclass Components and dict</span>
    <span class="s3">pass</span>


<span class="s3">class </span><span class="s1">PersistentComponentsDict(dict</span><span class="s3">, </span><span class="s1">PersistentComponents):</span>
    <span class="s0"># Like the above, but inheritance is flipped</span>
    <span class="s3">def </span><span class="s1">__init__(self</span><span class="s3">, </span><span class="s1">name):</span>
        <span class="s1">dict.__init__(self)</span>
        <span class="s1">PersistentComponents.__init__(self</span><span class="s3">, </span><span class="s1">name)</span>

<span class="s3">class </span><span class="s1">TestPersistentComponents(unittest.TestCase):</span>

    <span class="s3">def </span><span class="s1">_makeOne(self):</span>
        <span class="s3">return </span><span class="s1">PersistentComponents(</span><span class="s4">'test'</span><span class="s1">)</span>

    <span class="s3">def </span><span class="s1">_check_equality_after_pickle(self</span><span class="s3">, </span><span class="s1">made):</span>
        <span class="s3">pass</span>

    <span class="s3">def </span><span class="s1">test_pickles_empty(self):</span>
        <span class="s3">import </span><span class="s1">pickle</span>
        <span class="s1">comp = self._makeOne()</span>
        <span class="s1">pickle.dumps(comp)</span>
        <span class="s1">comp2 = pickle.loads(pickle.dumps(comp))</span>

        <span class="s1">self.assertEqual(comp2.__name__</span><span class="s3">, </span><span class="s4">'test'</span><span class="s1">)</span>

    <span class="s3">def </span><span class="s1">test_pickles_with_utility_registration(self):</span>
        <span class="s3">import </span><span class="s1">pickle</span>
        <span class="s1">comp = self._makeOne()</span>
        <span class="s1">utility = object()</span>
        <span class="s1">comp.registerUtility(</span>
            <span class="s1">utility</span><span class="s3">,</span>
            <span class="s1">Interface)</span>

        <span class="s1">self.assertIs(utility</span><span class="s3">,</span>
                      <span class="s1">comp.getUtility(Interface))</span>

        <span class="s1">comp2 = pickle.loads(pickle.dumps(comp))</span>
        <span class="s1">self.assertEqual(comp2.__name__</span><span class="s3">, </span><span class="s4">'test'</span><span class="s1">)</span>

        <span class="s0"># The utility is still registered</span>
        <span class="s1">self.assertIsNotNone(comp2.getUtility(Interface))</span>

        <span class="s0"># We can register another one</span>
        <span class="s1">comp2.registerUtility(</span>
            <span class="s1">utility</span><span class="s3">,</span>
            <span class="s1">Interface)</span>
        <span class="s1">self.assertIs(utility</span><span class="s3">,</span>
                      <span class="s1">comp2.getUtility(Interface))</span>

        <span class="s1">self._check_equality_after_pickle(comp2)</span>


<span class="s3">class </span><span class="s1">TestPersistentDictComponents(TestPersistentComponents):</span>

    <span class="s3">def </span><span class="s1">_getTargetClass(self):</span>
        <span class="s3">return </span><span class="s1">PersistentDictComponents</span>

    <span class="s3">def </span><span class="s1">_makeOne(self):</span>
        <span class="s1">comp = self._getTargetClass()(name=</span><span class="s4">'test'</span><span class="s1">)</span>
        <span class="s1">comp[</span><span class="s4">'key'</span><span class="s1">] = </span><span class="s5">42</span>
        <span class="s3">return </span><span class="s1">comp</span>

    <span class="s3">def </span><span class="s1">_check_equality_after_pickle(self</span><span class="s3">, </span><span class="s1">made):</span>
        <span class="s1">self.assertIn(</span><span class="s4">'key'</span><span class="s3">, </span><span class="s1">made)</span>
        <span class="s1">self.assertEqual(made[</span><span class="s4">'key'</span><span class="s1">]</span><span class="s3">, </span><span class="s5">42</span><span class="s1">)</span>

<span class="s3">class </span><span class="s1">TestPersistentComponentsDict(TestPersistentDictComponents):</span>

    <span class="s3">def </span><span class="s1">_getTargetClass(self):</span>
        <span class="s3">return </span><span class="s1">PersistentComponentsDict</span>

<span class="s3">class </span><span class="s1">_Monkey(object):</span>
    <span class="s0"># context-manager for replacing module names in the scope of a test.</span>
    <span class="s3">def </span><span class="s1">__init__(self</span><span class="s3">, </span><span class="s1">module</span><span class="s3">, </span><span class="s1">**kw):</span>
        <span class="s1">self.module = module</span>
        <span class="s1">self.to_restore = dict([(key</span><span class="s3">, </span><span class="s1">getattr(module</span><span class="s3">, </span><span class="s1">key)) </span><span class="s3">for </span><span class="s1">key </span><span class="s3">in </span><span class="s1">kw])</span>
        <span class="s3">for </span><span class="s1">key</span><span class="s3">, </span><span class="s1">value </span><span class="s3">in </span><span class="s1">kw.items():</span>
            <span class="s1">setattr(module</span><span class="s3">, </span><span class="s1">key</span><span class="s3">, </span><span class="s1">value)</span>

    <span class="s3">def </span><span class="s1">__enter__(self):</span>
        <span class="s3">return </span><span class="s1">self</span>

    <span class="s3">def </span><span class="s1">__exit__(self</span><span class="s3">, </span><span class="s1">exc_type</span><span class="s3">, </span><span class="s1">exc_val</span><span class="s3">, </span><span class="s1">exc_tb):</span>
        <span class="s3">for </span><span class="s1">key</span><span class="s3">, </span><span class="s1">value </span><span class="s3">in </span><span class="s1">self.to_restore.items():</span>
            <span class="s1">setattr(self.module</span><span class="s3">, </span><span class="s1">key</span><span class="s3">, </span><span class="s1">value)</span>
</pre>
</body>
</html>