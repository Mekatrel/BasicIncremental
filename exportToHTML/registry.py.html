<html>
<head>
<title>registry.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #808080;}
.s1 { color: #a9b7c6;}
.s2 { color: #629755; font-style: italic;}
.s3 { color: #cc7832;}
.s4 { color: #6a8759;}
.s5 { color: #6897bb;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
registry.py</font>
</center></td></tr></table>
<pre><span class="s0">##############################################################################</span>
<span class="s0">#</span>
<span class="s0"># Copyright (c) 2006 Zope Foundation and Contributors.</span>
<span class="s0"># All Rights Reserved.</span>
<span class="s0">#</span>
<span class="s0"># This software is subject to the provisions of the Zope Public License,</span>
<span class="s0"># Version 2.1 (ZPL).  A copy of the ZPL should accompany this distribution.</span>
<span class="s0"># THIS SOFTWARE IS PROVIDED &quot;AS IS&quot; AND ANY AND ALL EXPRESS OR IMPLIED</span>
<span class="s0"># WARRANTIES ARE DISCLAIMED, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED</span>
<span class="s0"># WARRANTIES OF TITLE, MERCHANTABILITY, AGAINST INFRINGEMENT, AND FITNESS</span>
<span class="s0"># FOR A PARTICULAR PURPOSE.</span>
<span class="s0">#</span>
<span class="s0">##############################################################################</span>
<span class="s2">&quot;&quot;&quot;Basic components support 
&quot;&quot;&quot;</span>
<span class="s3">from </span><span class="s1">collections </span><span class="s3">import </span><span class="s1">defaultdict</span>

<span class="s3">try</span><span class="s1">:</span>
    <span class="s3">from </span><span class="s1">zope.event </span><span class="s3">import </span><span class="s1">notify</span>
<span class="s3">except </span><span class="s1">ImportError: </span><span class="s0"># pragma: no cover</span>
    <span class="s3">def </span><span class="s1">notify(*arg</span><span class="s3">, </span><span class="s1">**kw): </span><span class="s3">pass</span>

<span class="s3">from </span><span class="s1">zope.interface.interfaces </span><span class="s3">import </span><span class="s1">ISpecification</span>
<span class="s3">from </span><span class="s1">zope.interface.interfaces </span><span class="s3">import </span><span class="s1">ComponentLookupError</span>
<span class="s3">from </span><span class="s1">zope.interface.interfaces </span><span class="s3">import </span><span class="s1">IAdapterRegistration</span>
<span class="s3">from </span><span class="s1">zope.interface.interfaces </span><span class="s3">import </span><span class="s1">IComponents</span>
<span class="s3">from </span><span class="s1">zope.interface.interfaces </span><span class="s3">import </span><span class="s1">IHandlerRegistration</span>
<span class="s3">from </span><span class="s1">zope.interface.interfaces </span><span class="s3">import </span><span class="s1">ISubscriptionAdapterRegistration</span>
<span class="s3">from </span><span class="s1">zope.interface.interfaces </span><span class="s3">import </span><span class="s1">IUtilityRegistration</span>
<span class="s3">from </span><span class="s1">zope.interface.interfaces </span><span class="s3">import </span><span class="s1">Registered</span>
<span class="s3">from </span><span class="s1">zope.interface.interfaces </span><span class="s3">import </span><span class="s1">Unregistered</span>

<span class="s3">from </span><span class="s1">zope.interface.interface </span><span class="s3">import </span><span class="s1">Interface</span>
<span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">implementedBy</span>
<span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">implementer</span>
<span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">implementer_only</span>
<span class="s3">from </span><span class="s1">zope.interface.declarations </span><span class="s3">import </span><span class="s1">providedBy</span>
<span class="s3">from </span><span class="s1">zope.interface.adapter </span><span class="s3">import </span><span class="s1">AdapterRegistry</span>
<span class="s3">from </span><span class="s1">zope.interface._compat </span><span class="s3">import </span><span class="s1">CLASS_TYPES</span>
<span class="s3">from </span><span class="s1">zope.interface._compat </span><span class="s3">import </span><span class="s1">STRING_TYPES</span>

<span class="s1">__all__ = [</span>
    <span class="s0"># Components is public API, but</span>
    <span class="s0"># the *Registration classes are just implementations</span>
    <span class="s0"># of public interfaces.</span>
    <span class="s4">'Components'</span><span class="s3">,</span>
<span class="s1">]</span>

<span class="s3">class </span><span class="s1">_UnhashableComponentCounter(object):</span>
    <span class="s0"># defaultdict(int)-like object for unhashable components</span>

    <span class="s3">def </span><span class="s1">__init__(self</span><span class="s3">, </span><span class="s1">otherdict):</span>
        <span class="s0"># [(component, count)]</span>
        <span class="s1">self._data = [item </span><span class="s3">for </span><span class="s1">item </span><span class="s3">in </span><span class="s1">otherdict.items()]</span>

    <span class="s3">def </span><span class="s1">__getitem__(self</span><span class="s3">, </span><span class="s1">key):</span>
        <span class="s3">for </span><span class="s1">component</span><span class="s3">, </span><span class="s1">count </span><span class="s3">in </span><span class="s1">self._data:</span>
            <span class="s3">if </span><span class="s1">component == key:</span>
                <span class="s3">return </span><span class="s1">count</span>
        <span class="s3">return </span><span class="s5">0</span>

    <span class="s3">def </span><span class="s1">__setitem__(self</span><span class="s3">, </span><span class="s1">component</span><span class="s3">, </span><span class="s1">count):</span>
        <span class="s3">for </span><span class="s1">i</span><span class="s3">, </span><span class="s1">data </span><span class="s3">in </span><span class="s1">enumerate(self._data):</span>
            <span class="s3">if </span><span class="s1">data[</span><span class="s5">0</span><span class="s1">] == component:</span>
                <span class="s1">self._data[i] = component</span><span class="s3">, </span><span class="s1">count</span>
                <span class="s3">return</span>
        <span class="s1">self._data.append((component</span><span class="s3">, </span><span class="s1">count))</span>

    <span class="s3">def </span><span class="s1">__delitem__(self</span><span class="s3">, </span><span class="s1">component):</span>
        <span class="s3">for </span><span class="s1">i</span><span class="s3">, </span><span class="s1">data </span><span class="s3">in </span><span class="s1">enumerate(self._data):</span>
            <span class="s3">if </span><span class="s1">data[</span><span class="s5">0</span><span class="s1">] == component:</span>
                <span class="s3">del </span><span class="s1">self._data[i]</span>
                <span class="s3">return</span>
        <span class="s3">raise </span><span class="s1">KeyError(component) </span><span class="s0"># pragma: no cover</span>

<span class="s3">def </span><span class="s1">_defaultdict_int():</span>
    <span class="s3">return </span><span class="s1">defaultdict(int)</span>

<span class="s3">class </span><span class="s1">_UtilityRegistrations(object):</span>

    <span class="s3">def </span><span class="s1">__init__(self</span><span class="s3">, </span><span class="s1">utilities</span><span class="s3">, </span><span class="s1">utility_registrations):</span>
        <span class="s0"># {provided -&gt; {component: count}}</span>
        <span class="s1">self._cache = defaultdict(_defaultdict_int)</span>
        <span class="s1">self._utilities = utilities</span>
        <span class="s1">self._utility_registrations = utility_registrations</span>

        <span class="s1">self.__populate_cache()</span>

    <span class="s3">def </span><span class="s1">__populate_cache(self):</span>
        <span class="s3">for </span><span class="s1">((p</span><span class="s3">, </span><span class="s1">_)</span><span class="s3">, </span><span class="s1">data) </span><span class="s3">in </span><span class="s1">iter(self._utility_registrations.items()):</span>
            <span class="s1">component = data[</span><span class="s5">0</span><span class="s1">]</span>
            <span class="s1">self.__cache_utility(p</span><span class="s3">, </span><span class="s1">component)</span>

    <span class="s3">def </span><span class="s1">__cache_utility(self</span><span class="s3">, </span><span class="s1">provided</span><span class="s3">, </span><span class="s1">component):</span>
        <span class="s3">try</span><span class="s1">:</span>
            <span class="s1">self._cache[provided][component] += </span><span class="s5">1</span>
        <span class="s3">except </span><span class="s1">TypeError:</span>
            <span class="s0"># The component is not hashable, and we have a dict. Switch to a strategy</span>
            <span class="s0"># that doesn't use hashing.</span>
            <span class="s1">prov = self._cache[provided] = _UnhashableComponentCounter(self._cache[provided])</span>
            <span class="s1">prov[component] += </span><span class="s5">1</span>

    <span class="s3">def </span><span class="s1">__uncache_utility(self</span><span class="s3">, </span><span class="s1">provided</span><span class="s3">, </span><span class="s1">component):</span>
        <span class="s1">provided = self._cache[provided]</span>
        <span class="s0"># It seems like this line could raise a TypeError if component isn't</span>
        <span class="s0"># hashable and we haven't yet switched to _UnhashableComponentCounter. However,</span>
        <span class="s0"># we can't actually get in that situation. In order to get here, we would</span>
        <span class="s0"># have had to cache the utility already which would have switched</span>
        <span class="s0"># the datastructure if needed.</span>
        <span class="s1">count = provided[component]</span>
        <span class="s1">count -= </span><span class="s5">1</span>
        <span class="s3">if </span><span class="s1">count == </span><span class="s5">0</span><span class="s1">:</span>
            <span class="s3">del </span><span class="s1">provided[component]</span>
        <span class="s3">else</span><span class="s1">:</span>
            <span class="s1">provided[component] = count</span>
        <span class="s3">return </span><span class="s1">count &gt; </span><span class="s5">0</span>

    <span class="s3">def </span><span class="s1">_is_utility_subscribed(self</span><span class="s3">, </span><span class="s1">provided</span><span class="s3">, </span><span class="s1">component):</span>
        <span class="s3">try</span><span class="s1">:</span>
            <span class="s3">return </span><span class="s1">self._cache[provided][component] &gt; </span><span class="s5">0</span>
        <span class="s3">except </span><span class="s1">TypeError:</span>
            <span class="s0"># Not hashable and we're still using a dict</span>
            <span class="s3">return False</span>

    <span class="s3">def </span><span class="s1">registerUtility(self</span><span class="s3">, </span><span class="s1">provided</span><span class="s3">, </span><span class="s1">name</span><span class="s3">, </span><span class="s1">component</span><span class="s3">, </span><span class="s1">info</span><span class="s3">, </span><span class="s1">factory):</span>
        <span class="s1">subscribed = self._is_utility_subscribed(provided</span><span class="s3">, </span><span class="s1">component)</span>

        <span class="s1">self._utility_registrations[(provided</span><span class="s3">, </span><span class="s1">name)] = component</span><span class="s3">, </span><span class="s1">info</span><span class="s3">, </span><span class="s1">factory</span>
        <span class="s1">self._utilities.register(()</span><span class="s3">, </span><span class="s1">provided</span><span class="s3">, </span><span class="s1">name</span><span class="s3">, </span><span class="s1">component)</span>

        <span class="s3">if not </span><span class="s1">subscribed:</span>
            <span class="s1">self._utilities.subscribe(()</span><span class="s3">, </span><span class="s1">provided</span><span class="s3">, </span><span class="s1">component)</span>

        <span class="s1">self.__cache_utility(provided</span><span class="s3">, </span><span class="s1">component)</span>

    <span class="s3">def </span><span class="s1">unregisterUtility(self</span><span class="s3">, </span><span class="s1">provided</span><span class="s3">, </span><span class="s1">name</span><span class="s3">, </span><span class="s1">component):</span>
        <span class="s3">del </span><span class="s1">self._utility_registrations[(provided</span><span class="s3">, </span><span class="s1">name)]</span>
        <span class="s1">self._utilities.unregister(()</span><span class="s3">, </span><span class="s1">provided</span><span class="s3">, </span><span class="s1">name)</span>

        <span class="s1">subscribed = self.__uncache_utility(provided</span><span class="s3">, </span><span class="s1">component)</span>

        <span class="s3">if not </span><span class="s1">subscribed:</span>
            <span class="s1">self._utilities.unsubscribe(()</span><span class="s3">, </span><span class="s1">provided</span><span class="s3">, </span><span class="s1">component)</span>


<span class="s1">@implementer(IComponents)</span>
<span class="s3">class </span><span class="s1">Components(object):</span>

    <span class="s1">_v_utility_registrations_cache = </span><span class="s3">None</span>

    <span class="s3">def </span><span class="s1">__init__(self</span><span class="s3">, </span><span class="s1">name=</span><span class="s4">''</span><span class="s3">, </span><span class="s1">bases=()):</span>
        <span class="s0"># __init__ is used for test cleanup as well as initialization.</span>
        <span class="s0"># XXX add a separate API for test cleanup.</span>
        <span class="s3">assert </span><span class="s1">isinstance(name</span><span class="s3">, </span><span class="s1">STRING_TYPES)</span>
        <span class="s1">self.__name__ = name</span>
        <span class="s1">self._init_registries()</span>
        <span class="s1">self._init_registrations()</span>
        <span class="s1">self.__bases__ = tuple(bases)</span>
        <span class="s1">self._v_utility_registrations_cache = </span><span class="s3">None</span>

    <span class="s3">def </span><span class="s1">__repr__(self):</span>
        <span class="s3">return </span><span class="s4">&quot;&lt;%s %s&gt;&quot; </span><span class="s1">% (self.__class__.__name__</span><span class="s3">, </span><span class="s1">self.__name__)</span>

    <span class="s3">def </span><span class="s1">__reduce__(self):</span>
        <span class="s0"># Mimic what a persistent.Persistent object does and elide</span>
        <span class="s0"># _v_ attributes so that they don't get saved in ZODB.</span>
        <span class="s0"># This allows us to store things that cannot be pickled in such</span>
        <span class="s0"># attributes.</span>
        <span class="s1">reduction = super(Components</span><span class="s3">, </span><span class="s1">self).__reduce__()</span>
        <span class="s0"># (callable, args, state, listiter, dictiter)</span>
        <span class="s0"># We assume the state is always a dict; the last three items</span>
        <span class="s0"># are technically optional and can be missing or None.</span>
        <span class="s1">filtered_state = {k: v </span><span class="s3">for </span><span class="s1">k</span><span class="s3">, </span><span class="s1">v </span><span class="s3">in </span><span class="s1">reduction[</span><span class="s5">2</span><span class="s1">].items()</span>
                          <span class="s3">if not </span><span class="s1">k.startswith(</span><span class="s4">'_v_'</span><span class="s1">)}</span>
        <span class="s1">reduction = list(reduction)</span>
        <span class="s1">reduction[</span><span class="s5">2</span><span class="s1">] = filtered_state</span>
        <span class="s3">return </span><span class="s1">tuple(reduction)</span>

    <span class="s3">def </span><span class="s1">_init_registries(self):</span>
        <span class="s0"># Subclasses have never been required to call this method</span>
        <span class="s0"># if they override it, merely to fill in these two attributes.</span>
        <span class="s1">self.adapters = AdapterRegistry()</span>
        <span class="s1">self.utilities = AdapterRegistry()</span>

    <span class="s3">def </span><span class="s1">_init_registrations(self):</span>
        <span class="s1">self._utility_registrations = {}</span>
        <span class="s1">self._adapter_registrations = {}</span>
        <span class="s1">self._subscription_registrations = []</span>
        <span class="s1">self._handler_registrations = []</span>

    <span class="s1">@property</span>
    <span class="s3">def </span><span class="s1">_utility_registrations_cache(self):</span>
        <span class="s0"># We use a _v_ attribute internally so that data aren't saved in ZODB,</span>
        <span class="s0"># because this object cannot be pickled.</span>
        <span class="s1">cache = self._v_utility_registrations_cache</span>
        <span class="s3">if </span><span class="s1">(cache </span><span class="s3">is None</span>
            <span class="s3">or </span><span class="s1">cache._utilities </span><span class="s3">is not </span><span class="s1">self.utilities</span>
            <span class="s3">or </span><span class="s1">cache._utility_registrations </span><span class="s3">is not </span><span class="s1">self._utility_registrations):</span>
            <span class="s1">cache = self._v_utility_registrations_cache = _UtilityRegistrations(</span>
                <span class="s1">self.utilities</span><span class="s3">,</span>
                <span class="s1">self._utility_registrations)</span>
        <span class="s3">return </span><span class="s1">cache</span>

    <span class="s3">def </span><span class="s1">_getBases(self):</span>
        <span class="s0"># Subclasses might override</span>
        <span class="s3">return </span><span class="s1">self.__dict__.get(</span><span class="s4">'__bases__'</span><span class="s3">, </span><span class="s1">())</span>

    <span class="s3">def </span><span class="s1">_setBases(self</span><span class="s3">, </span><span class="s1">bases):</span>
        <span class="s0"># Subclasses might override</span>
        <span class="s1">self.adapters.__bases__ = tuple([</span>
            <span class="s1">base.adapters </span><span class="s3">for </span><span class="s1">base </span><span class="s3">in </span><span class="s1">bases])</span>
        <span class="s1">self.utilities.__bases__ = tuple([</span>
            <span class="s1">base.utilities </span><span class="s3">for </span><span class="s1">base </span><span class="s3">in </span><span class="s1">bases])</span>
        <span class="s1">self.__dict__[</span><span class="s4">'__bases__'</span><span class="s1">] = tuple(bases)</span>

    <span class="s1">__bases__ = property(</span>
        <span class="s3">lambda </span><span class="s1">self: self._getBases()</span><span class="s3">,</span>
        <span class="s3">lambda </span><span class="s1">self</span><span class="s3">, </span><span class="s1">bases: self._setBases(bases)</span><span class="s3">,</span>
        <span class="s1">)</span>

    <span class="s3">def </span><span class="s1">registerUtility(self</span><span class="s3">, </span><span class="s1">component=</span><span class="s3">None, </span><span class="s1">provided=</span><span class="s3">None, </span><span class="s1">name=</span><span class="s4">u''</span><span class="s3">,</span>
                        <span class="s1">info=</span><span class="s4">u''</span><span class="s3">, </span><span class="s1">event=</span><span class="s3">True, </span><span class="s1">factory=</span><span class="s3">None</span><span class="s1">):</span>
        <span class="s3">if </span><span class="s1">factory:</span>
            <span class="s3">if </span><span class="s1">component:</span>
                <span class="s3">raise </span><span class="s1">TypeError(</span><span class="s4">&quot;Can't specify factory and component.&quot;</span><span class="s1">)</span>
            <span class="s1">component = factory()</span>

        <span class="s3">if </span><span class="s1">provided </span><span class="s3">is None</span><span class="s1">:</span>
            <span class="s1">provided = _getUtilityProvided(component)</span>

        <span class="s3">if </span><span class="s1">name == </span><span class="s4">u''</span><span class="s1">:</span>
            <span class="s1">name = _getName(component)</span>

        <span class="s1">reg = self._utility_registrations.get((provided</span><span class="s3">, </span><span class="s1">name))</span>
        <span class="s3">if </span><span class="s1">reg </span><span class="s3">is not None</span><span class="s1">:</span>
            <span class="s3">if </span><span class="s1">reg[:</span><span class="s5">2</span><span class="s1">] == (component</span><span class="s3">, </span><span class="s1">info):</span>
                <span class="s0"># already registered</span>
                <span class="s3">return</span>
            <span class="s1">self.unregisterUtility(reg[</span><span class="s5">0</span><span class="s1">]</span><span class="s3">, </span><span class="s1">provided</span><span class="s3">, </span><span class="s1">name)</span>

        <span class="s1">self._utility_registrations_cache.registerUtility(</span>
            <span class="s1">provided</span><span class="s3">, </span><span class="s1">name</span><span class="s3">, </span><span class="s1">component</span><span class="s3">, </span><span class="s1">info</span><span class="s3">, </span><span class="s1">factory)</span>

        <span class="s3">if </span><span class="s1">event:</span>
            <span class="s1">notify(Registered(</span>
                <span class="s1">UtilityRegistration(self</span><span class="s3">, </span><span class="s1">provided</span><span class="s3">, </span><span class="s1">name</span><span class="s3">, </span><span class="s1">component</span><span class="s3">, </span><span class="s1">info</span><span class="s3">,</span>
                                    <span class="s1">factory)</span>
                <span class="s1">))</span>

    <span class="s3">def </span><span class="s1">unregisterUtility(self</span><span class="s3">, </span><span class="s1">component=</span><span class="s3">None, </span><span class="s1">provided=</span><span class="s3">None, </span><span class="s1">name=</span><span class="s4">u''</span><span class="s3">,</span>
                          <span class="s1">factory=</span><span class="s3">None</span><span class="s1">):</span>
        <span class="s3">if </span><span class="s1">factory:</span>
            <span class="s3">if </span><span class="s1">component:</span>
                <span class="s3">raise </span><span class="s1">TypeError(</span><span class="s4">&quot;Can't specify factory and component.&quot;</span><span class="s1">)</span>
            <span class="s1">component = factory()</span>

        <span class="s3">if </span><span class="s1">provided </span><span class="s3">is None</span><span class="s1">:</span>
            <span class="s3">if </span><span class="s1">component </span><span class="s3">is None</span><span class="s1">:</span>
                <span class="s3">raise </span><span class="s1">TypeError(</span><span class="s4">&quot;Must specify one of component, factory and &quot;</span>
                                <span class="s4">&quot;provided&quot;</span><span class="s1">)</span>
            <span class="s1">provided = _getUtilityProvided(component)</span>

        <span class="s1">old = self._utility_registrations.get((provided</span><span class="s3">, </span><span class="s1">name))</span>
        <span class="s3">if </span><span class="s1">(old </span><span class="s3">is None</span><span class="s1">) </span><span class="s3">or </span><span class="s1">((component </span><span class="s3">is not None</span><span class="s1">) </span><span class="s3">and</span>
                             <span class="s1">(component != old[</span><span class="s5">0</span><span class="s1">])):</span>
            <span class="s3">return False</span>

        <span class="s3">if </span><span class="s1">component </span><span class="s3">is None</span><span class="s1">:</span>
            <span class="s1">component = old[</span><span class="s5">0</span><span class="s1">]</span>

        <span class="s0"># Note that component is now the old thing registered</span>
        <span class="s1">self._utility_registrations_cache.unregisterUtility(</span>
            <span class="s1">provided</span><span class="s3">, </span><span class="s1">name</span><span class="s3">, </span><span class="s1">component)</span>

        <span class="s1">notify(Unregistered(</span>
            <span class="s1">UtilityRegistration(self</span><span class="s3">, </span><span class="s1">provided</span><span class="s3">, </span><span class="s1">name</span><span class="s3">, </span><span class="s1">component</span><span class="s3">, </span><span class="s1">*old[</span><span class="s5">1</span><span class="s1">:])</span>
            <span class="s1">))</span>

        <span class="s3">return True</span>

    <span class="s3">def </span><span class="s1">registeredUtilities(self):</span>
        <span class="s3">for </span><span class="s1">((provided</span><span class="s3">, </span><span class="s1">name)</span><span class="s3">, </span><span class="s1">data</span>
             <span class="s1">) </span><span class="s3">in </span><span class="s1">iter(self._utility_registrations.items()):</span>
            <span class="s3">yield </span><span class="s1">UtilityRegistration(self</span><span class="s3">, </span><span class="s1">provided</span><span class="s3">, </span><span class="s1">name</span><span class="s3">, </span><span class="s1">*data)</span>

    <span class="s3">def </span><span class="s1">queryUtility(self</span><span class="s3">, </span><span class="s1">provided</span><span class="s3">, </span><span class="s1">name=</span><span class="s4">u''</span><span class="s3">, </span><span class="s1">default=</span><span class="s3">None</span><span class="s1">):</span>
        <span class="s3">return </span><span class="s1">self.utilities.lookup(()</span><span class="s3">, </span><span class="s1">provided</span><span class="s3">, </span><span class="s1">name</span><span class="s3">, </span><span class="s1">default)</span>

    <span class="s3">def </span><span class="s1">getUtility(self</span><span class="s3">, </span><span class="s1">provided</span><span class="s3">, </span><span class="s1">name=</span><span class="s4">u''</span><span class="s1">):</span>
        <span class="s1">utility = self.utilities.lookup(()</span><span class="s3">, </span><span class="s1">provided</span><span class="s3">, </span><span class="s1">name)</span>
        <span class="s3">if </span><span class="s1">utility </span><span class="s3">is None</span><span class="s1">:</span>
            <span class="s3">raise </span><span class="s1">ComponentLookupError(provided</span><span class="s3">, </span><span class="s1">name)</span>
        <span class="s3">return </span><span class="s1">utility</span>

    <span class="s3">def </span><span class="s1">getUtilitiesFor(self</span><span class="s3">, </span><span class="s1">interface):</span>
        <span class="s3">for </span><span class="s1">name</span><span class="s3">, </span><span class="s1">utility </span><span class="s3">in </span><span class="s1">self.utilities.lookupAll(()</span><span class="s3">, </span><span class="s1">interface):</span>
            <span class="s3">yield </span><span class="s1">name</span><span class="s3">, </span><span class="s1">utility</span>

    <span class="s3">def </span><span class="s1">getAllUtilitiesRegisteredFor(self</span><span class="s3">, </span><span class="s1">interface):</span>
        <span class="s3">return </span><span class="s1">self.utilities.subscriptions(()</span><span class="s3">, </span><span class="s1">interface)</span>

    <span class="s3">def </span><span class="s1">registerAdapter(self</span><span class="s3">, </span><span class="s1">factory</span><span class="s3">, </span><span class="s1">required=</span><span class="s3">None, </span><span class="s1">provided=</span><span class="s3">None,</span>
                        <span class="s1">name=</span><span class="s4">u''</span><span class="s3">, </span><span class="s1">info=</span><span class="s4">u''</span><span class="s3">, </span><span class="s1">event=</span><span class="s3">True</span><span class="s1">):</span>
        <span class="s3">if </span><span class="s1">provided </span><span class="s3">is None</span><span class="s1">:</span>
            <span class="s1">provided = _getAdapterProvided(factory)</span>
        <span class="s1">required = _getAdapterRequired(factory</span><span class="s3">, </span><span class="s1">required)</span>
        <span class="s3">if </span><span class="s1">name == </span><span class="s4">u''</span><span class="s1">:</span>
            <span class="s1">name = _getName(factory)</span>
        <span class="s1">self._adapter_registrations[(required</span><span class="s3">, </span><span class="s1">provided</span><span class="s3">, </span><span class="s1">name)</span>
                                    <span class="s1">] = factory</span><span class="s3">, </span><span class="s1">info</span>
        <span class="s1">self.adapters.register(required</span><span class="s3">, </span><span class="s1">provided</span><span class="s3">, </span><span class="s1">name</span><span class="s3">, </span><span class="s1">factory)</span>

        <span class="s3">if </span><span class="s1">event:</span>
            <span class="s1">notify(Registered(</span>
                <span class="s1">AdapterRegistration(self</span><span class="s3">, </span><span class="s1">required</span><span class="s3">, </span><span class="s1">provided</span><span class="s3">, </span><span class="s1">name</span><span class="s3">,</span>
                                    <span class="s1">factory</span><span class="s3">, </span><span class="s1">info)</span>
                <span class="s1">))</span>


    <span class="s3">def </span><span class="s1">unregisterAdapter(self</span><span class="s3">, </span><span class="s1">factory=</span><span class="s3">None,</span>
                          <span class="s1">required=</span><span class="s3">None, </span><span class="s1">provided=</span><span class="s3">None, </span><span class="s1">name=</span><span class="s4">u''</span><span class="s3">,</span>
                          <span class="s1">):</span>
        <span class="s3">if </span><span class="s1">provided </span><span class="s3">is None</span><span class="s1">:</span>
            <span class="s3">if </span><span class="s1">factory </span><span class="s3">is None</span><span class="s1">:</span>
                <span class="s3">raise </span><span class="s1">TypeError(</span><span class="s4">&quot;Must specify one of factory and provided&quot;</span><span class="s1">)</span>
            <span class="s1">provided = _getAdapterProvided(factory)</span>

        <span class="s3">if </span><span class="s1">(required </span><span class="s3">is None</span><span class="s1">) </span><span class="s3">and </span><span class="s1">(factory </span><span class="s3">is None</span><span class="s1">):</span>
            <span class="s3">raise </span><span class="s1">TypeError(</span><span class="s4">&quot;Must specify one of factory and required&quot;</span><span class="s1">)</span>

        <span class="s1">required = _getAdapterRequired(factory</span><span class="s3">, </span><span class="s1">required)</span>
        <span class="s1">old = self._adapter_registrations.get((required</span><span class="s3">, </span><span class="s1">provided</span><span class="s3">, </span><span class="s1">name))</span>
        <span class="s3">if </span><span class="s1">(old </span><span class="s3">is None</span><span class="s1">) </span><span class="s3">or </span><span class="s1">((factory </span><span class="s3">is not None</span><span class="s1">) </span><span class="s3">and</span>
                             <span class="s1">(factory != old[</span><span class="s5">0</span><span class="s1">])):</span>
            <span class="s3">return False</span>

        <span class="s3">del </span><span class="s1">self._adapter_registrations[(required</span><span class="s3">, </span><span class="s1">provided</span><span class="s3">, </span><span class="s1">name)]</span>
        <span class="s1">self.adapters.unregister(required</span><span class="s3">, </span><span class="s1">provided</span><span class="s3">, </span><span class="s1">name)</span>

        <span class="s1">notify(Unregistered(</span>
            <span class="s1">AdapterRegistration(self</span><span class="s3">, </span><span class="s1">required</span><span class="s3">, </span><span class="s1">provided</span><span class="s3">, </span><span class="s1">name</span><span class="s3">,</span>
                                <span class="s1">*old)</span>
            <span class="s1">))</span>

        <span class="s3">return True</span>

    <span class="s3">def </span><span class="s1">registeredAdapters(self):</span>
        <span class="s3">for </span><span class="s1">((required</span><span class="s3">, </span><span class="s1">provided</span><span class="s3">, </span><span class="s1">name)</span><span class="s3">, </span><span class="s1">(component</span><span class="s3">, </span><span class="s1">info)</span>
             <span class="s1">) </span><span class="s3">in </span><span class="s1">iter(self._adapter_registrations.items()):</span>
            <span class="s3">yield </span><span class="s1">AdapterRegistration(self</span><span class="s3">, </span><span class="s1">required</span><span class="s3">, </span><span class="s1">provided</span><span class="s3">, </span><span class="s1">name</span><span class="s3">,</span>
                                      <span class="s1">component</span><span class="s3">, </span><span class="s1">info)</span>

    <span class="s3">def </span><span class="s1">queryAdapter(self</span><span class="s3">, </span><span class="s1">object</span><span class="s3">, </span><span class="s1">interface</span><span class="s3">, </span><span class="s1">name=</span><span class="s4">u''</span><span class="s3">, </span><span class="s1">default=</span><span class="s3">None</span><span class="s1">):</span>
        <span class="s3">return </span><span class="s1">self.adapters.queryAdapter(object</span><span class="s3">, </span><span class="s1">interface</span><span class="s3">, </span><span class="s1">name</span><span class="s3">, </span><span class="s1">default)</span>

    <span class="s3">def </span><span class="s1">getAdapter(self</span><span class="s3">, </span><span class="s1">object</span><span class="s3">, </span><span class="s1">interface</span><span class="s3">, </span><span class="s1">name=</span><span class="s4">u''</span><span class="s1">):</span>
        <span class="s1">adapter = self.adapters.queryAdapter(object</span><span class="s3">, </span><span class="s1">interface</span><span class="s3">, </span><span class="s1">name)</span>
        <span class="s3">if </span><span class="s1">adapter </span><span class="s3">is None</span><span class="s1">:</span>
            <span class="s3">raise </span><span class="s1">ComponentLookupError(object</span><span class="s3">, </span><span class="s1">interface</span><span class="s3">, </span><span class="s1">name)</span>
        <span class="s3">return </span><span class="s1">adapter</span>

    <span class="s3">def </span><span class="s1">queryMultiAdapter(self</span><span class="s3">, </span><span class="s1">objects</span><span class="s3">, </span><span class="s1">interface</span><span class="s3">, </span><span class="s1">name=</span><span class="s4">u''</span><span class="s3">,</span>
                          <span class="s1">default=</span><span class="s3">None</span><span class="s1">):</span>
        <span class="s3">return </span><span class="s1">self.adapters.queryMultiAdapter(</span>
            <span class="s1">objects</span><span class="s3">, </span><span class="s1">interface</span><span class="s3">, </span><span class="s1">name</span><span class="s3">, </span><span class="s1">default)</span>

    <span class="s3">def </span><span class="s1">getMultiAdapter(self</span><span class="s3">, </span><span class="s1">objects</span><span class="s3">, </span><span class="s1">interface</span><span class="s3">, </span><span class="s1">name=</span><span class="s4">u''</span><span class="s1">):</span>
        <span class="s1">adapter = self.adapters.queryMultiAdapter(objects</span><span class="s3">, </span><span class="s1">interface</span><span class="s3">, </span><span class="s1">name)</span>
        <span class="s3">if </span><span class="s1">adapter </span><span class="s3">is None</span><span class="s1">:</span>
            <span class="s3">raise </span><span class="s1">ComponentLookupError(objects</span><span class="s3">, </span><span class="s1">interface</span><span class="s3">, </span><span class="s1">name)</span>
        <span class="s3">return </span><span class="s1">adapter</span>

    <span class="s3">def </span><span class="s1">getAdapters(self</span><span class="s3">, </span><span class="s1">objects</span><span class="s3">, </span><span class="s1">provided):</span>
        <span class="s3">for </span><span class="s1">name</span><span class="s3">, </span><span class="s1">factory </span><span class="s3">in </span><span class="s1">self.adapters.lookupAll(</span>
            <span class="s1">list(map(providedBy</span><span class="s3">, </span><span class="s1">objects))</span><span class="s3">,</span>
            <span class="s1">provided):</span>
            <span class="s1">adapter = factory(*objects)</span>
            <span class="s3">if </span><span class="s1">adapter </span><span class="s3">is not None</span><span class="s1">:</span>
                <span class="s3">yield </span><span class="s1">name</span><span class="s3">, </span><span class="s1">adapter</span>

    <span class="s3">def </span><span class="s1">registerSubscriptionAdapter(self</span><span class="s3">,</span>
                                    <span class="s1">factory</span><span class="s3">, </span><span class="s1">required=</span><span class="s3">None, </span><span class="s1">provided=</span><span class="s3">None,</span>
                                    <span class="s1">name=</span><span class="s4">u''</span><span class="s3">, </span><span class="s1">info=</span><span class="s4">u''</span><span class="s3">,</span>
                                    <span class="s1">event=</span><span class="s3">True</span><span class="s1">):</span>
        <span class="s3">if </span><span class="s1">name:</span>
            <span class="s3">raise </span><span class="s1">TypeError(</span><span class="s4">&quot;Named subscribers are not yet supported&quot;</span><span class="s1">)</span>
        <span class="s3">if </span><span class="s1">provided </span><span class="s3">is None</span><span class="s1">:</span>
            <span class="s1">provided = _getAdapterProvided(factory)</span>
        <span class="s1">required = _getAdapterRequired(factory</span><span class="s3">, </span><span class="s1">required)</span>
        <span class="s1">self._subscription_registrations.append(</span>
            <span class="s1">(required</span><span class="s3">, </span><span class="s1">provided</span><span class="s3">, </span><span class="s1">name</span><span class="s3">, </span><span class="s1">factory</span><span class="s3">, </span><span class="s1">info)</span>
            <span class="s1">)</span>
        <span class="s1">self.adapters.subscribe(required</span><span class="s3">, </span><span class="s1">provided</span><span class="s3">, </span><span class="s1">factory)</span>

        <span class="s3">if </span><span class="s1">event:</span>
            <span class="s1">notify(Registered(</span>
                <span class="s1">SubscriptionRegistration(self</span><span class="s3">, </span><span class="s1">required</span><span class="s3">, </span><span class="s1">provided</span><span class="s3">, </span><span class="s1">name</span><span class="s3">,</span>
                                         <span class="s1">factory</span><span class="s3">, </span><span class="s1">info)</span>
                <span class="s1">))</span>

    <span class="s3">def </span><span class="s1">registeredSubscriptionAdapters(self):</span>
        <span class="s3">for </span><span class="s1">data </span><span class="s3">in </span><span class="s1">self._subscription_registrations:</span>
            <span class="s3">yield </span><span class="s1">SubscriptionRegistration(self</span><span class="s3">, </span><span class="s1">*data)</span>

    <span class="s3">def </span><span class="s1">unregisterSubscriptionAdapter(self</span><span class="s3">, </span><span class="s1">factory=</span><span class="s3">None,</span>
                          <span class="s1">required=</span><span class="s3">None, </span><span class="s1">provided=</span><span class="s3">None, </span><span class="s1">name=</span><span class="s4">u''</span><span class="s3">,</span>
                          <span class="s1">):</span>
        <span class="s3">if </span><span class="s1">name:</span>
            <span class="s3">raise </span><span class="s1">TypeError(</span><span class="s4">&quot;Named subscribers are not yet supported&quot;</span><span class="s1">)</span>
        <span class="s3">if </span><span class="s1">provided </span><span class="s3">is None</span><span class="s1">:</span>
            <span class="s3">if </span><span class="s1">factory </span><span class="s3">is None</span><span class="s1">:</span>
                <span class="s3">raise </span><span class="s1">TypeError(</span><span class="s4">&quot;Must specify one of factory and provided&quot;</span><span class="s1">)</span>
            <span class="s1">provided = _getAdapterProvided(factory)</span>

        <span class="s3">if </span><span class="s1">(required </span><span class="s3">is None</span><span class="s1">) </span><span class="s3">and </span><span class="s1">(factory </span><span class="s3">is None</span><span class="s1">):</span>
            <span class="s3">raise </span><span class="s1">TypeError(</span><span class="s4">&quot;Must specify one of factory and required&quot;</span><span class="s1">)</span>

        <span class="s1">required = _getAdapterRequired(factory</span><span class="s3">, </span><span class="s1">required)</span>

        <span class="s3">if </span><span class="s1">factory </span><span class="s3">is None</span><span class="s1">:</span>
            <span class="s1">new = [(r</span><span class="s3">, </span><span class="s1">p</span><span class="s3">, </span><span class="s1">n</span><span class="s3">, </span><span class="s1">f</span><span class="s3">, </span><span class="s1">i)</span>
                   <span class="s3">for </span><span class="s1">(r</span><span class="s3">, </span><span class="s1">p</span><span class="s3">, </span><span class="s1">n</span><span class="s3">, </span><span class="s1">f</span><span class="s3">, </span><span class="s1">i)</span>
                   <span class="s3">in </span><span class="s1">self._subscription_registrations</span>
                   <span class="s3">if not </span><span class="s1">(r == required </span><span class="s3">and </span><span class="s1">p == provided)</span>
                   <span class="s1">]</span>
        <span class="s3">else</span><span class="s1">:</span>
            <span class="s1">new = [(r</span><span class="s3">, </span><span class="s1">p</span><span class="s3">, </span><span class="s1">n</span><span class="s3">, </span><span class="s1">f</span><span class="s3">, </span><span class="s1">i)</span>
                   <span class="s3">for </span><span class="s1">(r</span><span class="s3">, </span><span class="s1">p</span><span class="s3">, </span><span class="s1">n</span><span class="s3">, </span><span class="s1">f</span><span class="s3">, </span><span class="s1">i)</span>
                   <span class="s3">in </span><span class="s1">self._subscription_registrations</span>
                   <span class="s3">if not </span><span class="s1">(r == required </span><span class="s3">and </span><span class="s1">p == provided </span><span class="s3">and </span><span class="s1">f == factory)</span>
                   <span class="s1">]</span>

        <span class="s3">if </span><span class="s1">len(new) == len(self._subscription_registrations):</span>
            <span class="s3">return False</span>


        <span class="s1">self._subscription_registrations[:] = new</span>
        <span class="s1">self.adapters.unsubscribe(required</span><span class="s3">, </span><span class="s1">provided</span><span class="s3">, </span><span class="s1">factory)</span>

        <span class="s1">notify(Unregistered(</span>
            <span class="s1">SubscriptionRegistration(self</span><span class="s3">, </span><span class="s1">required</span><span class="s3">, </span><span class="s1">provided</span><span class="s3">, </span><span class="s1">name</span><span class="s3">,</span>
                                     <span class="s1">factory</span><span class="s3">, </span><span class="s4">''</span><span class="s1">)</span>
            <span class="s1">))</span>

        <span class="s3">return True</span>

    <span class="s3">def </span><span class="s1">subscribers(self</span><span class="s3">, </span><span class="s1">objects</span><span class="s3">, </span><span class="s1">provided):</span>
        <span class="s3">return </span><span class="s1">self.adapters.subscribers(objects</span><span class="s3">, </span><span class="s1">provided)</span>

    <span class="s3">def </span><span class="s1">registerHandler(self</span><span class="s3">,</span>
                        <span class="s1">factory</span><span class="s3">, </span><span class="s1">required=</span><span class="s3">None,</span>
                        <span class="s1">name=</span><span class="s4">u''</span><span class="s3">, </span><span class="s1">info=</span><span class="s4">u''</span><span class="s3">,</span>
                        <span class="s1">event=</span><span class="s3">True</span><span class="s1">):</span>
        <span class="s3">if </span><span class="s1">name:</span>
            <span class="s3">raise </span><span class="s1">TypeError(</span><span class="s4">&quot;Named handlers are not yet supported&quot;</span><span class="s1">)</span>
        <span class="s1">required = _getAdapterRequired(factory</span><span class="s3">, </span><span class="s1">required)</span>
        <span class="s1">self._handler_registrations.append(</span>
            <span class="s1">(required</span><span class="s3">, </span><span class="s1">name</span><span class="s3">, </span><span class="s1">factory</span><span class="s3">, </span><span class="s1">info)</span>
            <span class="s1">)</span>
        <span class="s1">self.adapters.subscribe(required</span><span class="s3">, None, </span><span class="s1">factory)</span>

        <span class="s3">if </span><span class="s1">event:</span>
            <span class="s1">notify(Registered(</span>
                <span class="s1">HandlerRegistration(self</span><span class="s3">, </span><span class="s1">required</span><span class="s3">, </span><span class="s1">name</span><span class="s3">, </span><span class="s1">factory</span><span class="s3">, </span><span class="s1">info)</span>
                <span class="s1">))</span>

    <span class="s3">def </span><span class="s1">registeredHandlers(self):</span>
        <span class="s3">for </span><span class="s1">data </span><span class="s3">in </span><span class="s1">self._handler_registrations:</span>
            <span class="s3">yield </span><span class="s1">HandlerRegistration(self</span><span class="s3">, </span><span class="s1">*data)</span>

    <span class="s3">def </span><span class="s1">unregisterHandler(self</span><span class="s3">, </span><span class="s1">factory=</span><span class="s3">None, </span><span class="s1">required=</span><span class="s3">None, </span><span class="s1">name=</span><span class="s4">u''</span><span class="s1">):</span>
        <span class="s3">if </span><span class="s1">name:</span>
            <span class="s3">raise </span><span class="s1">TypeError(</span><span class="s4">&quot;Named subscribers are not yet supported&quot;</span><span class="s1">)</span>

        <span class="s3">if </span><span class="s1">(required </span><span class="s3">is None</span><span class="s1">) </span><span class="s3">and </span><span class="s1">(factory </span><span class="s3">is None</span><span class="s1">):</span>
            <span class="s3">raise </span><span class="s1">TypeError(</span><span class="s4">&quot;Must specify one of factory and required&quot;</span><span class="s1">)</span>

        <span class="s1">required = _getAdapterRequired(factory</span><span class="s3">, </span><span class="s1">required)</span>

        <span class="s3">if </span><span class="s1">factory </span><span class="s3">is None</span><span class="s1">:</span>
            <span class="s1">new = [(r</span><span class="s3">, </span><span class="s1">n</span><span class="s3">, </span><span class="s1">f</span><span class="s3">, </span><span class="s1">i)</span>
                   <span class="s3">for </span><span class="s1">(r</span><span class="s3">, </span><span class="s1">n</span><span class="s3">, </span><span class="s1">f</span><span class="s3">, </span><span class="s1">i)</span>
                   <span class="s3">in </span><span class="s1">self._handler_registrations</span>
                   <span class="s3">if </span><span class="s1">r != required</span>
                   <span class="s1">]</span>
        <span class="s3">else</span><span class="s1">:</span>
            <span class="s1">new = [(r</span><span class="s3">, </span><span class="s1">n</span><span class="s3">, </span><span class="s1">f</span><span class="s3">, </span><span class="s1">i)</span>
                   <span class="s3">for </span><span class="s1">(r</span><span class="s3">, </span><span class="s1">n</span><span class="s3">, </span><span class="s1">f</span><span class="s3">, </span><span class="s1">i)</span>
                   <span class="s3">in </span><span class="s1">self._handler_registrations</span>
                   <span class="s3">if not </span><span class="s1">(r == required </span><span class="s3">and </span><span class="s1">f == factory)</span>
                   <span class="s1">]</span>

        <span class="s3">if </span><span class="s1">len(new) == len(self._handler_registrations):</span>
            <span class="s3">return False</span>

        <span class="s1">self._handler_registrations[:] = new</span>
        <span class="s1">self.adapters.unsubscribe(required</span><span class="s3">, None, </span><span class="s1">factory)</span>

        <span class="s1">notify(Unregistered(</span>
            <span class="s1">HandlerRegistration(self</span><span class="s3">, </span><span class="s1">required</span><span class="s3">, </span><span class="s1">name</span><span class="s3">, </span><span class="s1">factory</span><span class="s3">, </span><span class="s4">''</span><span class="s1">)</span>
            <span class="s1">))</span>

        <span class="s3">return True</span>

    <span class="s3">def </span><span class="s1">handle(self</span><span class="s3">, </span><span class="s1">*objects):</span>
        <span class="s1">self.adapters.subscribers(objects</span><span class="s3">, None</span><span class="s1">)</span>

    <span class="s3">def </span><span class="s1">rebuildUtilityRegistryFromLocalCache(self</span><span class="s3">, </span><span class="s1">rebuild=</span><span class="s3">False</span><span class="s1">):</span>
        <span class="s2">&quot;&quot;&quot; 
        Emergency maintenance method to rebuild the ``.utilities`` 
        registry from the local copy maintained in this object, or 
        detect the need to do so. 
 
        Most users will never need to call this, but it can be helpful 
        in the event of suspected corruption. 
 
        By default, this method only checks for corruption. To make it 
        actually rebuild the registry, pass `True` for *rebuild*. 
 
        :param bool rebuild: If set to `True` (not the default), 
           this method will actually register and subscribe utilities 
           in the registry as needed to synchronize with the local cache. 
 
        :return: A dictionary that's meant as diagnostic data. The keys 
           and values may change over time. When called with a false *rebuild*, 
           the keys ``&quot;needed_registered&quot;`` and ``&quot;needed_subscribed&quot;`` will be 
           non-zero if any corruption was detected, but that will not be corrected. 
 
        .. versionadded:: 5.3.0 
        &quot;&quot;&quot;</span>
        <span class="s1">regs = dict(self._utility_registrations)</span>
        <span class="s1">utils = self.utilities</span>
        <span class="s1">needed_registered = </span><span class="s5">0</span>
        <span class="s1">did_not_register = </span><span class="s5">0</span>
        <span class="s1">needed_subscribed = </span><span class="s5">0</span>
        <span class="s1">did_not_subscribe = </span><span class="s5">0</span>


        <span class="s0"># Avoid the expensive change process during this; we'll call</span>
        <span class="s0"># it once at the end if needed.</span>
        <span class="s3">assert </span><span class="s4">'changed' </span><span class="s3">not in </span><span class="s1">utils.__dict__</span>
        <span class="s1">utils.changed = </span><span class="s3">lambda </span><span class="s1">_: </span><span class="s3">None</span>

        <span class="s3">if </span><span class="s1">rebuild:</span>
            <span class="s1">register = utils.register</span>
            <span class="s1">subscribe = utils.subscribe</span>
        <span class="s3">else</span><span class="s1">:</span>
            <span class="s1">register = subscribe = </span><span class="s3">lambda </span><span class="s1">*args: </span><span class="s3">None</span>

        <span class="s3">try</span><span class="s1">:</span>
            <span class="s3">for </span><span class="s1">(provided</span><span class="s3">, </span><span class="s1">name)</span><span class="s3">, </span><span class="s1">(value</span><span class="s3">, </span><span class="s1">_info</span><span class="s3">, </span><span class="s1">_factory) </span><span class="s3">in </span><span class="s1">regs.items():</span>
                <span class="s3">if </span><span class="s1">utils.registered(()</span><span class="s3">, </span><span class="s1">provided</span><span class="s3">, </span><span class="s1">name) != value:</span>
                    <span class="s1">register(()</span><span class="s3">, </span><span class="s1">provided</span><span class="s3">, </span><span class="s1">name</span><span class="s3">, </span><span class="s1">value)</span>
                    <span class="s1">needed_registered += </span><span class="s5">1</span>
                <span class="s3">else</span><span class="s1">:</span>
                    <span class="s1">did_not_register += </span><span class="s5">1</span>

                <span class="s3">if </span><span class="s1">utils.subscribed(()</span><span class="s3">, </span><span class="s1">provided</span><span class="s3">, </span><span class="s1">value) </span><span class="s3">is None</span><span class="s1">:</span>
                    <span class="s1">needed_subscribed += </span><span class="s5">1</span>
                    <span class="s1">subscribe(()</span><span class="s3">, </span><span class="s1">provided</span><span class="s3">, </span><span class="s1">value)</span>
                <span class="s3">else</span><span class="s1">:</span>
                    <span class="s1">did_not_subscribe += </span><span class="s5">1</span>
        <span class="s3">finally</span><span class="s1">:</span>
            <span class="s3">del </span><span class="s1">utils.changed</span>
            <span class="s3">if </span><span class="s1">rebuild </span><span class="s3">and </span><span class="s1">(needed_subscribed </span><span class="s3">or </span><span class="s1">needed_registered):</span>
                <span class="s1">utils.changed(utils)</span>

        <span class="s3">return </span><span class="s1">{</span>
            <span class="s4">'needed_registered'</span><span class="s1">: needed_registered</span><span class="s3">,</span>
            <span class="s4">'did_not_register'</span><span class="s1">: did_not_register</span><span class="s3">,</span>
            <span class="s4">'needed_subscribed'</span><span class="s1">: needed_subscribed</span><span class="s3">,</span>
            <span class="s4">'did_not_subscribe'</span><span class="s1">: did_not_subscribe</span>
        <span class="s1">}</span>

<span class="s3">def </span><span class="s1">_getName(component):</span>
    <span class="s3">try</span><span class="s1">:</span>
        <span class="s3">return </span><span class="s1">component.__component_name__</span>
    <span class="s3">except </span><span class="s1">AttributeError:</span>
        <span class="s3">return </span><span class="s4">u''</span>

<span class="s3">def </span><span class="s1">_getUtilityProvided(component):</span>
    <span class="s1">provided = list(providedBy(component))</span>
    <span class="s3">if </span><span class="s1">len(provided) == </span><span class="s5">1</span><span class="s1">:</span>
        <span class="s3">return </span><span class="s1">provided[</span><span class="s5">0</span><span class="s1">]</span>
    <span class="s3">raise </span><span class="s1">TypeError(</span>
        <span class="s4">&quot;The utility doesn't provide a single interface &quot;</span>
        <span class="s4">&quot;and no provided interface was specified.&quot;</span><span class="s1">)</span>

<span class="s3">def </span><span class="s1">_getAdapterProvided(factory):</span>
    <span class="s1">provided = list(implementedBy(factory))</span>
    <span class="s3">if </span><span class="s1">len(provided) == </span><span class="s5">1</span><span class="s1">:</span>
        <span class="s3">return </span><span class="s1">provided[</span><span class="s5">0</span><span class="s1">]</span>
    <span class="s3">raise </span><span class="s1">TypeError(</span>
        <span class="s4">&quot;The adapter factory doesn't implement a single interface &quot;</span>
        <span class="s4">&quot;and no provided interface was specified.&quot;</span><span class="s1">)</span>

<span class="s3">def </span><span class="s1">_getAdapterRequired(factory</span><span class="s3">, </span><span class="s1">required):</span>
    <span class="s3">if </span><span class="s1">required </span><span class="s3">is None</span><span class="s1">:</span>
        <span class="s3">try</span><span class="s1">:</span>
            <span class="s1">required = factory.__component_adapts__</span>
        <span class="s3">except </span><span class="s1">AttributeError:</span>
            <span class="s3">raise </span><span class="s1">TypeError(</span>
                <span class="s4">&quot;The adapter factory doesn't have a __component_adapts__ &quot;</span>
                <span class="s4">&quot;attribute and no required specifications were specified&quot;</span>
                <span class="s1">)</span>
    <span class="s3">elif </span><span class="s1">ISpecification.providedBy(required):</span>
        <span class="s3">raise </span><span class="s1">TypeError(</span><span class="s4">&quot;the required argument should be a list of &quot;</span>
                        <span class="s4">&quot;interfaces, not a single interface&quot;</span><span class="s1">)</span>

    <span class="s1">result = []</span>
    <span class="s3">for </span><span class="s1">r </span><span class="s3">in </span><span class="s1">required:</span>
        <span class="s3">if </span><span class="s1">r </span><span class="s3">is None</span><span class="s1">:</span>
            <span class="s1">r = Interface</span>
        <span class="s3">elif not </span><span class="s1">ISpecification.providedBy(r):</span>
            <span class="s3">if </span><span class="s1">isinstance(r</span><span class="s3">, </span><span class="s1">CLASS_TYPES):</span>
                <span class="s1">r = implementedBy(r)</span>
            <span class="s3">else</span><span class="s1">:</span>
                <span class="s3">raise </span><span class="s1">TypeError(</span><span class="s4">&quot;Required specification must be a &quot;</span>
                                <span class="s4">&quot;specification or class, not %r&quot; </span><span class="s1">% type(r)</span>
                                <span class="s1">)</span>
        <span class="s1">result.append(r)</span>
    <span class="s3">return </span><span class="s1">tuple(result)</span>


<span class="s1">@implementer(IUtilityRegistration)</span>
<span class="s3">class </span><span class="s1">UtilityRegistration(object):</span>

    <span class="s3">def </span><span class="s1">__init__(self</span><span class="s3">, </span><span class="s1">registry</span><span class="s3">, </span><span class="s1">provided</span><span class="s3">, </span><span class="s1">name</span><span class="s3">, </span><span class="s1">component</span><span class="s3">, </span><span class="s1">doc</span><span class="s3">, </span><span class="s1">factory=</span><span class="s3">None</span><span class="s1">):</span>
        <span class="s1">(self.registry</span><span class="s3">, </span><span class="s1">self.provided</span><span class="s3">, </span><span class="s1">self.name</span><span class="s3">, </span><span class="s1">self.component</span><span class="s3">, </span><span class="s1">self.info</span><span class="s3">,</span>
         <span class="s1">self.factory</span>
         <span class="s1">) = registry</span><span class="s3">, </span><span class="s1">provided</span><span class="s3">, </span><span class="s1">name</span><span class="s3">, </span><span class="s1">component</span><span class="s3">, </span><span class="s1">doc</span><span class="s3">, </span><span class="s1">factory</span>

    <span class="s3">def </span><span class="s1">__repr__(self):</span>
        <span class="s3">return </span><span class="s4">'%s(%r, %s, %r, %s, %r, %r)' </span><span class="s1">% (</span>
                <span class="s1">self.__class__.__name__</span><span class="s3">,</span>
                <span class="s1">self.registry</span><span class="s3">,</span>
                <span class="s1">getattr(self.provided</span><span class="s3">, </span><span class="s4">'__name__'</span><span class="s3">, None</span><span class="s1">)</span><span class="s3">, </span><span class="s1">self.name</span><span class="s3">,</span>
                <span class="s1">getattr(self.component</span><span class="s3">, </span><span class="s4">'__name__'</span><span class="s3">, </span><span class="s1">repr(self.component))</span><span class="s3">,</span>
                <span class="s1">self.factory</span><span class="s3">, </span><span class="s1">self.info</span><span class="s3">,</span>
                <span class="s1">)</span>

    <span class="s3">def </span><span class="s1">__hash__(self):</span>
        <span class="s3">return </span><span class="s1">id(self)</span>

    <span class="s3">def </span><span class="s1">__eq__(self</span><span class="s3">, </span><span class="s1">other):</span>
        <span class="s3">return </span><span class="s1">repr(self) == repr(other)</span>

    <span class="s3">def </span><span class="s1">__ne__(self</span><span class="s3">, </span><span class="s1">other):</span>
        <span class="s3">return </span><span class="s1">repr(self) != repr(other)</span>

    <span class="s3">def </span><span class="s1">__lt__(self</span><span class="s3">, </span><span class="s1">other):</span>
        <span class="s3">return </span><span class="s1">repr(self) &lt; repr(other)</span>

    <span class="s3">def </span><span class="s1">__le__(self</span><span class="s3">, </span><span class="s1">other):</span>
        <span class="s3">return </span><span class="s1">repr(self) &lt;= repr(other)</span>

    <span class="s3">def </span><span class="s1">__gt__(self</span><span class="s3">, </span><span class="s1">other):</span>
        <span class="s3">return </span><span class="s1">repr(self) &gt; repr(other)</span>

    <span class="s3">def </span><span class="s1">__ge__(self</span><span class="s3">, </span><span class="s1">other):</span>
        <span class="s3">return </span><span class="s1">repr(self) &gt;= repr(other)</span>

<span class="s1">@implementer(IAdapterRegistration)</span>
<span class="s3">class </span><span class="s1">AdapterRegistration(object):</span>

    <span class="s3">def </span><span class="s1">__init__(self</span><span class="s3">, </span><span class="s1">registry</span><span class="s3">, </span><span class="s1">required</span><span class="s3">, </span><span class="s1">provided</span><span class="s3">, </span><span class="s1">name</span><span class="s3">, </span><span class="s1">component</span><span class="s3">, </span><span class="s1">doc):</span>
        <span class="s1">(self.registry</span><span class="s3">, </span><span class="s1">self.required</span><span class="s3">, </span><span class="s1">self.provided</span><span class="s3">, </span><span class="s1">self.name</span><span class="s3">,</span>
         <span class="s1">self.factory</span><span class="s3">, </span><span class="s1">self.info</span>
         <span class="s1">) = registry</span><span class="s3">, </span><span class="s1">required</span><span class="s3">, </span><span class="s1">provided</span><span class="s3">, </span><span class="s1">name</span><span class="s3">, </span><span class="s1">component</span><span class="s3">, </span><span class="s1">doc</span>

    <span class="s3">def </span><span class="s1">__repr__(self):</span>
        <span class="s3">return </span><span class="s4">'%s(%r, %s, %s, %r, %s, %r)' </span><span class="s1">% (</span>
            <span class="s1">self.__class__.__name__</span><span class="s3">,</span>
            <span class="s1">self.registry</span><span class="s3">,</span>
            <span class="s4">'[' </span><span class="s1">+ </span><span class="s4">&quot;, &quot;</span><span class="s1">.join([r.__name__ </span><span class="s3">for </span><span class="s1">r </span><span class="s3">in </span><span class="s1">self.required]) + </span><span class="s4">']'</span><span class="s3">,</span>
            <span class="s1">getattr(self.provided</span><span class="s3">, </span><span class="s4">'__name__'</span><span class="s3">, None</span><span class="s1">)</span><span class="s3">, </span><span class="s1">self.name</span><span class="s3">,</span>
            <span class="s1">getattr(self.factory</span><span class="s3">, </span><span class="s4">'__name__'</span><span class="s3">, </span><span class="s1">repr(self.factory))</span><span class="s3">, </span><span class="s1">self.info</span><span class="s3">,</span>
            <span class="s1">)</span>

    <span class="s3">def </span><span class="s1">__hash__(self):</span>
        <span class="s3">return </span><span class="s1">id(self)</span>

    <span class="s3">def </span><span class="s1">__eq__(self</span><span class="s3">, </span><span class="s1">other):</span>
        <span class="s3">return </span><span class="s1">repr(self) == repr(other)</span>

    <span class="s3">def </span><span class="s1">__ne__(self</span><span class="s3">, </span><span class="s1">other):</span>
        <span class="s3">return </span><span class="s1">repr(self) != repr(other)</span>

    <span class="s3">def </span><span class="s1">__lt__(self</span><span class="s3">, </span><span class="s1">other):</span>
        <span class="s3">return </span><span class="s1">repr(self) &lt; repr(other)</span>

    <span class="s3">def </span><span class="s1">__le__(self</span><span class="s3">, </span><span class="s1">other):</span>
        <span class="s3">return </span><span class="s1">repr(self) &lt;= repr(other)</span>

    <span class="s3">def </span><span class="s1">__gt__(self</span><span class="s3">, </span><span class="s1">other):</span>
        <span class="s3">return </span><span class="s1">repr(self) &gt; repr(other)</span>

    <span class="s3">def </span><span class="s1">__ge__(self</span><span class="s3">, </span><span class="s1">other):</span>
        <span class="s3">return </span><span class="s1">repr(self) &gt;= repr(other)</span>

<span class="s1">@implementer_only(ISubscriptionAdapterRegistration)</span>
<span class="s3">class </span><span class="s1">SubscriptionRegistration(AdapterRegistration):</span>
    <span class="s3">pass</span>


<span class="s1">@implementer_only(IHandlerRegistration)</span>
<span class="s3">class </span><span class="s1">HandlerRegistration(AdapterRegistration):</span>

    <span class="s3">def </span><span class="s1">__init__(self</span><span class="s3">, </span><span class="s1">registry</span><span class="s3">, </span><span class="s1">required</span><span class="s3">, </span><span class="s1">name</span><span class="s3">, </span><span class="s1">handler</span><span class="s3">, </span><span class="s1">doc):</span>
        <span class="s1">(self.registry</span><span class="s3">, </span><span class="s1">self.required</span><span class="s3">, </span><span class="s1">self.name</span><span class="s3">, </span><span class="s1">self.handler</span><span class="s3">, </span><span class="s1">self.info</span>
         <span class="s1">) = registry</span><span class="s3">, </span><span class="s1">required</span><span class="s3">, </span><span class="s1">name</span><span class="s3">, </span><span class="s1">handler</span><span class="s3">, </span><span class="s1">doc</span>

    <span class="s1">@property</span>
    <span class="s3">def </span><span class="s1">factory(self):</span>
        <span class="s3">return </span><span class="s1">self.handler</span>

    <span class="s1">provided = </span><span class="s3">None</span>

    <span class="s3">def </span><span class="s1">__repr__(self):</span>
        <span class="s3">return </span><span class="s4">'%s(%r, %s, %r, %s, %r)' </span><span class="s1">% (</span>
            <span class="s1">self.__class__.__name__</span><span class="s3">,</span>
            <span class="s1">self.registry</span><span class="s3">,</span>
            <span class="s4">'[' </span><span class="s1">+ </span><span class="s4">&quot;, &quot;</span><span class="s1">.join([r.__name__ </span><span class="s3">for </span><span class="s1">r </span><span class="s3">in </span><span class="s1">self.required]) + </span><span class="s4">']'</span><span class="s3">,</span>
            <span class="s1">self.name</span><span class="s3">,</span>
            <span class="s1">getattr(self.factory</span><span class="s3">, </span><span class="s4">'__name__'</span><span class="s3">, </span><span class="s1">repr(self.factory))</span><span class="s3">, </span><span class="s1">self.info</span><span class="s3">,</span>
            <span class="s1">)</span>
</pre>
</body>
</html>